

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>fermipy.utils &mdash; Fermipy 0.18.0+25.g938c.dirty documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Fermipy
          

          
          </a>

          
            
            
              <div class="version">
                0.18.0+25.g938c.dirty
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../output.html">Output File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fitting.html">ROI Optimization and Fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model.html">Customizing the Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer.html">Developer Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced/index.html">Advanced Analysis Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../validation/index.html">Validation Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fermipy.html">fermipy package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fermipy_jobs.html">fermipy.jobs subpackage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fermipy_diffuse.html">fermipy.diffuse subpackage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Fermipy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../fermipy.html">fermipy</a> &raquo;</li>
        
      <li>fermipy.utils</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for fermipy.utils</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">xml.etree.cElementTree</span> <span class="k">as</span> <span class="nn">et</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="k">import</span> <span class="n">map_coordinates</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">UnivariateSpline</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">brentq</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage.measurements</span> <span class="k">import</span> <span class="n">label</span>
<span class="kn">import</span> <span class="nn">scipy.special</span> <span class="k">as</span> <span class="nn">special</span>
<span class="kn">from</span> <span class="nn">numpy.core</span> <span class="k">import</span> <span class="n">defchararray</span>
<span class="kn">from</span> <span class="nn">astropy.extern</span> <span class="k">import</span> <span class="n">six</span>


<div class="viewcode-block" id="init_matplotlib_backend"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.init_matplotlib_backend">[docs]</a><span class="k">def</span> <span class="nf">init_matplotlib_backend</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function initializes the matplotlib backend.  When no</span>
<span class="sd">    DISPLAY is available the backend is automatically set to &#39;Agg&#39;.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    backend : str</span>
<span class="sd">       matplotlib backend name.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">matplotlib</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DISPLAY&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span></div>


<div class="viewcode-block" id="unicode_representer"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.unicode_representer">[docs]</a><span class="k">def</span> <span class="nf">unicode_representer</span><span class="p">(</span><span class="n">dumper</span><span class="p">,</span> <span class="n">uni</span><span class="p">):</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">ScalarNode</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;tag:yaml.org,2002:str&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">uni</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">node</span></div>


<span class="n">yaml</span><span class="o">.</span><span class="n">add_representer</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">,</span> <span class="n">unicode_representer</span><span class="p">)</span>


<div class="viewcode-block" id="load_yaml"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.load_yaml">[docs]</a><span class="k">def</span> <span class="nf">load_yaml</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">infile</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_yaml"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.write_yaml">[docs]</a><span class="k">def</span> <span class="nf">write_yaml</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">tolist</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="load_npy"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.load_npy">[docs]</a><span class="k">def</span> <span class="nf">load_npy</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="load_data"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.load_data">[docs]</a><span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load python data structure from either a YAML or numpy file. &quot;&quot;&quot;</span>
    <span class="n">infile</span> <span class="o">=</span> <span class="n">resolve_path</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">)</span>
    <span class="n">infile</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">infile</span> <span class="o">+</span> <span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
        <span class="n">infile</span> <span class="o">+=</span> <span class="s1">&#39;.npy&#39;</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">infile</span> <span class="o">+</span> <span class="s1">&#39;.yaml&#39;</span><span class="p">):</span>
        <span class="n">infile</span> <span class="o">+=</span> <span class="s1">&#39;.yaml&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Input file does not exist.&#39;</span><span class="p">)</span>

    <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">infile</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.npy&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">infile</span><span class="p">,</span> <span class="n">load_npy</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.yaml&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">infile</span><span class="p">,</span> <span class="n">load_yaml</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unrecognized extension.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="resolve_path"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.resolve_path">[docs]</a><span class="k">def</span> <span class="nf">resolve_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">path</span>
    <span class="k">elif</span> <span class="n">workdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="resolve_file_path"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.resolve_file_path">[docs]</a><span class="k">def</span> <span class="nf">resolve_file_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">dirs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;search_dirs&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">expand</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expand&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">out_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="ow">and</span> \
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
        <span class="n">out_path</span> <span class="o">=</span> <span class="n">path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">d</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">p</span><span class="p">)):</span>
                <span class="n">out_path</span> <span class="o">=</span> <span class="n">p</span>
                <span class="k">break</span>

    <span class="k">if</span> <span class="n">out_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Failed to resolve file path: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">expand</span><span class="p">:</span>
        <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out_path</span></div>


<div class="viewcode-block" id="resolve_file_path_list"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.resolve_file_path_list">[docs]</a><span class="k">def</span> <span class="nf">resolve_file_path_list</span><span class="p">(</span><span class="n">pathlist</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                           <span class="n">randomize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Resolve the path of each file name in the file ``pathlist`` and</span>
<span class="sd">    write the updated paths to a new file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pathlist</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>

    <span class="n">newfiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">newfiles</span> <span class="o">+=</span> <span class="p">[</span><span class="n">f</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newfiles</span> <span class="o">+=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">f</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">randomize</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">tmppath</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">workdir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tmppath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>

    <span class="n">tmppath</span> <span class="o">+=</span> <span class="s1">&#39;.txt&#39;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmppath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmpfile</span><span class="p">:</span>
        <span class="n">tmpfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">newfiles</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tmppath</span></div>


<div class="viewcode-block" id="is_fits_file"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.is_fits_file">[docs]</a><span class="k">def</span> <span class="nf">is_fits_file</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fit&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fit.gz&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fits.gz&#39;</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="collect_dirs"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.collect_dirs">[docs]</a><span class="k">def</span> <span class="nf">collect_dirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">followlinks</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Recursively find directories under the given path.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">o</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">max_depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">o</span>

    <span class="k">for</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

        <span class="n">subdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">subdir</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">subdir</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">o</span> <span class="o">+=</span> <span class="p">[</span><span class="n">subdir</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">subdir</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">followlinks</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">max_depth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">+=</span> <span class="n">collect_dirs</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">o</span><span class="p">))</span></div>


<div class="viewcode-block" id="match_regex_list"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.match_regex_list">[docs]</a><span class="k">def</span> <span class="nf">match_regex_list</span><span class="p">(</span><span class="n">patterns</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform a regex match of a string against a list of patterns.</span>
<span class="sd">    Returns true if the string matches at least one pattern in the</span>
<span class="sd">    list.&quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="find_rows_by_string"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.find_rows_by_string">[docs]</a><span class="k">def</span> <span class="nf">find_rows_by_string</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">colnames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;assoc&#39;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Find the rows in a table ``tab`` that match at least one of the</span>
<span class="sd">    strings in ``names``.  This method ignores whitespace and case</span>
<span class="sd">    when matching strings.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tab : `astropy.table.Table`</span>
<span class="sd">       Table that will be searched.</span>

<span class="sd">    names : list</span>
<span class="sd">       List of strings.</span>

<span class="sd">    colname : str</span>
<span class="sd">       Name of the table column that will be searched for matching string.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mask : `~numpy.ndarray`</span>
<span class="sd">       Boolean mask for rows with matching strings.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tab</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">mask</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">colname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tab</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">col</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[[</span><span class="n">colname</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">col</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">defchararray</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">defchararray</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="n">colname</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span>
                                        <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">|=</span> <span class="n">col</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span>
    <span class="k">return</span> <span class="n">mask</span></div>


<div class="viewcode-block" id="join_strings"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.join_strings">[docs]</a><span class="k">def</span> <span class="nf">join_strings</span><span class="p">(</span><span class="n">strings</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">strings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">strings</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">strings</span> <span class="o">=</span> <span class="p">[</span><span class="n">strings</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">strings</span> <span class="k">if</span> <span class="n">s</span><span class="p">])</span></div>


<div class="viewcode-block" id="format_filename"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.format_filename">[docs]</a><span class="k">def</span> <span class="nf">format_filename</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">join_strings</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">join_strings</span><span class="p">([</span><span class="n">filename</span><span class="p">,</span> <span class="n">basename</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">extension</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">extension</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">+=</span> <span class="n">extension</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">extension</span>

    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="strip_suffix"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.strip_suffix">[docs]</a><span class="k">def</span> <span class="nf">strip_suffix</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">suffix</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">suffix</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\.</span><span class="si">%s</span><span class="s1">$&#39;</span> <span class="o">%</span> <span class="n">s</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">filename</span></div>


<div class="viewcode-block" id="met_to_mjd"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.met_to_mjd">[docs]</a><span class="k">def</span> <span class="nf">met_to_mjd</span><span class="p">(</span><span class="n">time</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;&quot;Convert mission elapsed time to mean julian date.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">54682.65</span> <span class="o">+</span> <span class="p">(</span><span class="n">time</span> <span class="o">-</span> <span class="mf">239557414.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">86400.</span><span class="p">)</span></div>


<span class="n">RA_NGP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mf">192.8594812065348</span><span class="p">)</span>
<span class="n">DEC_NGP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mf">27.12825118085622</span><span class="p">)</span>
<span class="n">L_CP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mf">122.9319185680026</span><span class="p">)</span>


<div class="viewcode-block" id="gal2eq"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.gal2eq">[docs]</a><span class="k">def</span> <span class="nf">gal2eq</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">L_0</span> <span class="o">=</span> <span class="n">L_CP</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">RA_0</span> <span class="o">=</span> <span class="n">RA_NGP</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.</span>

    <span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">l</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">l</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="n">sind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">DEC_NGP</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">DEC_NGP</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span>
        <span class="n">l</span> <span class="o">-</span> <span class="n">L_0</span><span class="p">)</span>

    <span class="n">dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">sind</span><span class="p">)</span>

    <span class="n">cosa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">l</span> <span class="o">-</span> <span class="n">L_0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
    <span class="n">sina</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">DEC_NGP</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">l</span> <span class="o">-</span> <span class="n">L_0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span>
        <span class="n">DEC_NGP</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>

    <span class="n">dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>

    <span class="n">cosa</span><span class="p">[</span><span class="n">cosa</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="n">cosa</span><span class="p">[</span><span class="n">cosa</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cosa</span><span class="p">)</span>
    <span class="n">ra</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sina</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">ra</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sina</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">)]</span>

    <span class="n">ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">ra</span> <span class="o">+</span> <span class="n">RA_0</span><span class="p">)</span>

    <span class="n">ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="mf">360.</span><span class="p">)</span>
    <span class="n">dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">dec</span> <span class="o">+</span> <span class="mf">90.</span><span class="p">,</span> <span class="mf">180.</span><span class="p">)</span> <span class="o">-</span> <span class="mf">90.</span>

    <span class="k">return</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span></div>


<div class="viewcode-block" id="eq2gal"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.eq2gal">[docs]</a><span class="k">def</span> <span class="nf">eq2gal</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">):</span>
    <span class="n">L_0</span> <span class="o">=</span> <span class="n">L_CP</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">RA_0</span> <span class="o">=</span> <span class="n">RA_NGP</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">DEC_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">-</span> <span class="n">DEC_NGP</span>

    <span class="n">ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dec</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">ra</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>

    <span class="n">np</span><span class="o">.</span><span class="n">sinb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">DEC_0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span>
        <span class="n">ra</span> <span class="o">-</span> <span class="n">RA_0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">DEC_0</span><span class="p">)</span>

    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sinb</span><span class="p">)</span>

    <span class="n">cosl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ra</span> <span class="o">-</span> <span class="n">RA_0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">sinl</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">DEC_0</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span>
        <span class="n">ra</span> <span class="o">-</span> <span class="n">RA_0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">DEC_0</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="n">cosl</span><span class="p">[</span><span class="n">cosl</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="n">cosl</span><span class="p">[</span><span class="n">cosl</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cosl</span><span class="p">)</span>
    <span class="n">l</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sinl</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">l</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sinl</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">)]</span>

    <span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="n">L_0</span><span class="p">)</span>

    <span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mf">360.</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="mf">90.</span><span class="p">,</span> <span class="mf">180.</span><span class="p">)</span> <span class="o">-</span> <span class="mf">90.</span>

    <span class="k">return</span> <span class="n">l</span><span class="p">,</span> <span class="n">b</span></div>


<div class="viewcode-block" id="xyz_to_lonlat"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.xyz_to_lonlat">[docs]</a><span class="k">def</span> <span class="nf">xyz_to_lonlat</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">y</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span> <span class="n">z</span><span class="p">)</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span></div>


<div class="viewcode-block" id="lonlat_to_xyz"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.lonlat_to_xyz">[docs]</a><span class="k">def</span> <span class="nf">lonlat_to_xyz</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">):</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">lon</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">-</span> <span class="n">lat</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)])</span></div>


<div class="viewcode-block" id="project"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.project">[docs]</a><span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="n">lon0</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function performs a stereographic projection on the unit</span>
<span class="sd">    vector (lon1,lat1) with the pole defined at the reference unit</span>
<span class="sd">    vector (lon0,lat0).&quot;&quot;&quot;</span>

    <span class="n">costh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">-</span> <span class="n">lat0</span><span class="p">)</span>
    <span class="n">cosphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lon0</span><span class="p">)</span>

    <span class="n">sinth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">-</span> <span class="n">lat0</span><span class="p">)</span>
    <span class="n">sinphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lon0</span><span class="p">)</span>

    <span class="n">xyz</span> <span class="o">=</span> <span class="n">lonlat_to_xyz</span><span class="p">(</span><span class="n">lon1</span><span class="p">,</span> <span class="n">lat1</span><span class="p">)</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">x1p</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">costh</span> <span class="o">*</span> <span class="n">cosphi</span> <span class="o">+</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">costh</span> <span class="o">*</span> <span class="n">sinphi</span> <span class="o">-</span> <span class="n">z1</span> <span class="o">*</span> <span class="n">sinth</span>
    <span class="n">y1p</span> <span class="o">=</span> <span class="o">-</span><span class="n">x1</span> <span class="o">*</span> <span class="n">sinphi</span> <span class="o">+</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">cosphi</span>
    <span class="n">z1p</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">sinth</span> <span class="o">*</span> <span class="n">cosphi</span> <span class="o">+</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">sinth</span> <span class="o">*</span> <span class="n">sinphi</span> <span class="o">+</span> <span class="n">z1</span> <span class="o">*</span> <span class="n">costh</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x1p</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">y1p</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span> <span class="n">z1p</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y1p</span><span class="p">,</span> <span class="n">x1p</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span></div>


<div class="viewcode-block" id="separation_cos_angle"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.separation_cos_angle">[docs]</a><span class="k">def</span> <span class="nf">separation_cos_angle</span><span class="p">(</span><span class="n">lon0</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Evaluate the cosine of the angular separation between two</span>
<span class="sd">    direction vectors.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat0</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat0</span><span class="p">)</span> <span class="o">*</span>
            <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lon1</span> <span class="o">-</span> <span class="n">lon0</span><span class="p">))</span></div>


<div class="viewcode-block" id="dot_prod"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.dot_prod">[docs]</a><span class="k">def</span> <span class="nf">dot_prod</span><span class="p">(</span><span class="n">xyz0</span><span class="p">,</span> <span class="n">xyz1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the dot product between two cartesian vectors where the</span>
<span class="sd">    second dimension contains the vector components.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xyz0</span> <span class="o">*</span> <span class="n">xyz1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="angle_to_cartesian"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.angle_to_cartesian">[docs]</a><span class="k">def</span> <span class="nf">angle_to_cartesian</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert spherical coordinates to cartesian unit vectors.&quot;&quot;&quot;</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">-</span> <span class="n">lat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span></div>


<div class="viewcode-block" id="scale_parameter"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.scale_parameter">[docs]</a><span class="k">def</span> <span class="nf">scale_parameter</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">isstr</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">p</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">p</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span> <span class="n">scale</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">p</span><span class="p">,</span> <span class="mf">1.0</span></div>


<div class="viewcode-block" id="update_bounds"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.update_bounds">[docs]</a><span class="k">def</span> <span class="nf">update_bounds</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">bounds</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="apply_minmax_selection"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.apply_minmax_selection">[docs]</a><span class="k">def</span> <span class="nf">apply_minmax_selection</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">val_minmax</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">val_minmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">val_minmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_cut</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">&gt;=</span> <span class="n">val_minmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">min_cut</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">min_cut</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">val_minmax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_cut</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="n">val_minmax</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">max_cut</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">max_cut</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">min_cut</span> <span class="ow">and</span> <span class="n">max_cut</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_source_name"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.create_source_name">[docs]</a><span class="k">def</span> <span class="nf">create_source_name</span><span class="p">(</span><span class="n">skydir</span><span class="p">,</span> <span class="n">floor</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;PS&#39;</span><span class="p">):</span>
    <span class="n">hms</span> <span class="o">=</span> <span class="n">skydir</span><span class="o">.</span><span class="n">icrs</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">hms</span>
    <span class="n">dms</span> <span class="o">=</span> <span class="n">skydir</span><span class="o">.</span><span class="n">icrs</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">dms</span>

    <span class="k">if</span> <span class="n">floor</span><span class="p">:</span>
        <span class="n">ra_ms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mf">10.</span> <span class="o">*</span> <span class="p">(</span><span class="n">hms</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="n">hms</span><span class="o">.</span><span class="n">s</span> <span class="o">/</span> <span class="mf">60.</span><span class="p">))</span> <span class="o">/</span> <span class="mf">10.</span>
        <span class="n">dec_ms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dms</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="n">dms</span><span class="o">.</span><span class="n">s</span> <span class="o">/</span> <span class="mf">60.</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ra_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">hms</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="n">hms</span><span class="o">.</span><span class="n">s</span> <span class="o">/</span> <span class="mf">60.</span><span class="p">)</span>
        <span class="n">dec_ms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dms</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="n">dms</span><span class="o">.</span><span class="n">s</span> <span class="o">/</span> <span class="mf">60.</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> J%02.f</span><span class="si">%04.1f</span><span class="s1">%+03.f%02.f&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">hms</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">ra_ms</span><span class="p">,</span>
                                           <span class="n">dms</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">dec_ms</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_model_name"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.create_model_name">[docs]</a><span class="k">def</span> <span class="nf">create_model_name</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate a name for a source object given its spatial/spectral</span>
<span class="sd">    properties.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : `~fermipy.roi_model.Source`</span>
<span class="sd">          A source object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    name : str</span>
<span class="sd">           A source name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">o</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">spatial_type</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpatialModel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">o</span> <span class="o">+=</span> <span class="n">spatial_type</span>

    <span class="k">if</span> <span class="n">spatial_type</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
        <span class="n">o</span> <span class="o">+=</span> <span class="s1">&#39;_s</span><span class="si">%04.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpatialWidth&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpectrumType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PowerLaw&#39;</span><span class="p">:</span>
        <span class="n">o</span> <span class="o">+=</span> <span class="s1">&#39;_powerlaw_</span><span class="si">%04.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">spectral_pars</span><span class="p">[</span><span class="s1">&#39;Index&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">o</span> <span class="o">+=</span> <span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpectrumType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">o</span></div>


<div class="viewcode-block" id="cov_to_correlation"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.cov_to_correlation">[docs]</a><span class="k">def</span> <span class="nf">cov_to_correlation</span><span class="p">(</span><span class="n">cov</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the correlation matrix given the covariance matrix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cov : `~numpy.ndarray`</span>
<span class="sd">        N x N matrix of covariances among N parameters.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    corr : `~numpy.ndarray`</span>
<span class="sd">        N x N matrix of correlations among N parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov</span><span class="p">))</span>
    <span class="n">errinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">errinv</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">err</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">corr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">errinv</span><span class="p">,</span> <span class="n">errinv</span><span class="p">)</span></div>


<div class="viewcode-block" id="ellipse_to_cov"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.ellipse_to_cov">[docs]</a><span class="k">def</span> <span class="nf">ellipse_to_cov</span><span class="p">(</span><span class="n">sigma_maj</span><span class="p">,</span> <span class="n">sigma_min</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the covariance matrix in two variables x and y given</span>
<span class="sd">    the std. deviation along the semi-major and semi-minor axes and</span>
<span class="sd">    the rotation angle of the error ellipse.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sigma_maj : float</span>
<span class="sd">        Std. deviation along major axis of error ellipse.</span>

<span class="sd">    sigma_min : float</span>
<span class="sd">        Std. deviation along minor axis of error ellipse.</span>

<span class="sd">    theta : float</span>
<span class="sd">        Rotation angle in radians from x-axis to ellipse major axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">sth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">covxx</span> <span class="o">=</span> <span class="n">cth</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma_maj</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sth</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma_min</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">covyy</span> <span class="o">=</span> <span class="n">sth</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma_maj</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">cth</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma_min</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">covxy</span> <span class="o">=</span> <span class="n">cth</span> <span class="o">*</span> <span class="n">sth</span> <span class="o">*</span> <span class="n">sigma_maj</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">cth</span> <span class="o">*</span> <span class="n">sth</span> <span class="o">*</span> <span class="n">sigma_min</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">covxx</span><span class="p">,</span> <span class="n">covxy</span><span class="p">],</span> <span class="p">[</span><span class="n">covxy</span><span class="p">,</span> <span class="n">covyy</span><span class="p">]])</span></div>


<div class="viewcode-block" id="twosided_cl_to_dlnl"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.twosided_cl_to_dlnl">[docs]</a><span class="k">def</span> <span class="nf">twosided_cl_to_dlnl</span><span class="p">(</span><span class="n">cl</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the delta-loglikehood value that corresponds to a</span>
<span class="sd">    two-sided interval of the given confidence level.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cl : float</span>
<span class="sd">        Confidence level.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dlnl : float    </span>
<span class="sd">        Delta-loglikelihood value with respect to the maximum of the</span>
<span class="sd">        likelihood function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">special</span><span class="o">.</span><span class="n">erfinv</span><span class="p">(</span><span class="n">cl</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="twosided_dlnl_to_cl"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.twosided_dlnl_to_cl">[docs]</a><span class="k">def</span> <span class="nf">twosided_dlnl_to_cl</span><span class="p">(</span><span class="n">dlnl</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the confidence level that corresponds to a two-sided</span>
<span class="sd">    interval with a given change in the loglikelihood value.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dlnl : float</span>
<span class="sd">        Delta-loglikelihood value with respect to the maximum of the</span>
<span class="sd">        likelihood function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cl : float</span>
<span class="sd">        Confidence level.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">special</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">dlnl</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span></div>


<div class="viewcode-block" id="onesided_cl_to_dlnl"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.onesided_cl_to_dlnl">[docs]</a><span class="k">def</span> <span class="nf">onesided_cl_to_dlnl</span><span class="p">(</span><span class="n">cl</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the delta-loglikehood values that corresponds to an</span>
<span class="sd">    upper limit of the given confidence level.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cl : float</span>
<span class="sd">        Confidence level.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dlnl : float</span>
<span class="sd">        Delta-loglikelihood value with respect to the maximum of the</span>
<span class="sd">        likelihood function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">cl</span>
    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">special</span><span class="o">.</span><span class="n">erfinv</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">),</span> <span class="mf">2.</span><span class="p">)</span></div>


<div class="viewcode-block" id="onesided_dlnl_to_cl"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.onesided_dlnl_to_cl">[docs]</a><span class="k">def</span> <span class="nf">onesided_dlnl_to_cl</span><span class="p">(</span><span class="n">dlnl</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the confidence level that corresponds to an upper limit</span>
<span class="sd">    with a given change in the loglikelihood value.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dlnl : float</span>
<span class="sd">        Delta-loglikelihood value with respect to the maximum of the</span>
<span class="sd">        likelihood function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cl : float</span>
<span class="sd">        Confidence level.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">special</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">dlnl</span><span class="o">**</span><span class="mf">0.5</span><span class="p">))</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">alpha</span></div>


<div class="viewcode-block" id="interpolate_function_min"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.interpolate_function_min">[docs]</a><span class="k">def</span> <span class="nf">interpolate_function_min</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">sp</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])):</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">x0</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">brentq</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span>
                               <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">x0</span></div>


<div class="viewcode-block" id="find_function_root"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.find_function_root">[docs]</a><span class="k">def</span> <span class="nf">find_function_root</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the root of a function: f(x)+delta in the interval encompassed</span>
<span class="sd">    by x0 and xb.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    fn : function</span>
<span class="sd">       Python function.</span>

<span class="sd">    x0 : float</span>
<span class="sd">       Fixed bound for the root search.  This will either be used as</span>
<span class="sd">       the lower or upper bound depending on the relative value of xb.</span>

<span class="sd">    xb : float</span>
<span class="sd">       Upper or lower bound for the root search.  If a root is not</span>
<span class="sd">       found in the interval [x0,xb]/[xb,x0] this value will be</span>
<span class="sd">       increased/decreased until a change in sign is found.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">x0</span> <span class="o">==</span> <span class="n">xb</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span> <span class="o">+</span> <span class="n">delta</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">xb</span> <span class="o">&lt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">xb</span> <span class="o">&gt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">xb</span> <span class="o">&lt;</span> <span class="n">x0</span><span class="p">:</span>
            <span class="n">xb</span> <span class="o">*=</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xb</span> <span class="o">*=</span> <span class="mf">2.0</span>

    <span class="c1"># Failed to find a root</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span> <span class="o">+</span> <span class="n">delta</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">if</span> <span class="n">x0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">xtol</span> <span class="o">=</span> <span class="mf">1e-10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xtol</span> <span class="o">=</span> <span class="mf">1e-10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xb</span> <span class="o">+</span> <span class="n">x0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">brentq</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">fn</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="n">xtol</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_parameter_limits"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.get_parameter_limits">[docs]</a><span class="k">def</span> <span class="nf">get_parameter_limits</span><span class="p">(</span><span class="n">xval</span><span class="p">,</span> <span class="n">loglike</span><span class="p">,</span> <span class="n">cl_limit</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">cl_err</span><span class="o">=</span><span class="mf">0.68269</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1E-2</span><span class="p">,</span>
                         <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute upper/lower limits, peak position, and 1-sigma errors</span>
<span class="sd">    from a 1-D likelihood function.  This function uses the</span>
<span class="sd">    delta-loglikelihood method to evaluate parameter limits by</span>
<span class="sd">    searching for the point at which the change in the log-likelihood</span>
<span class="sd">    value with respect to the maximum equals a specific value.  A</span>
<span class="sd">    cubic spline fit to the log-likelihood values is used to</span>
<span class="sd">    improve the accuracy of the calculation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    xval : `~numpy.ndarray`</span>
<span class="sd">       Array of parameter values.</span>

<span class="sd">    loglike : `~numpy.ndarray`</span>
<span class="sd">       Array of log-likelihood values.</span>

<span class="sd">    cl_limit : float</span>
<span class="sd">       Confidence level to use for limit calculation.</span>

<span class="sd">    cl_err : float</span>
<span class="sd">       Confidence level to use for two-sided confidence interval</span>
<span class="sd">       calculation.</span>

<span class="sd">    tol : float</span>
<span class="sd">       Absolute precision of likelihood values.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    x0 : float</span>
<span class="sd">        Coordinate at maximum of likelihood function.</span>

<span class="sd">    err_lo : float    </span>
<span class="sd">        Lower error for two-sided confidence interval with CL</span>
<span class="sd">        ``cl_err``.  Corresponds to point (x &lt; x0) at which the</span>
<span class="sd">        log-likelihood falls by a given value with respect to the</span>
<span class="sd">        maximum (0.5 for 1 sigma).  Set to nan if the change in the</span>
<span class="sd">        log-likelihood function at the lower bound of the ``xval``</span>
<span class="sd">        input array is less than than the value for the given CL.</span>

<span class="sd">    err_hi : float</span>
<span class="sd">        Upper error for two-sided confidence interval with CL</span>
<span class="sd">        ``cl_err``. Corresponds to point (x &gt; x0) at which the</span>
<span class="sd">        log-likelihood falls by a given value with respect to the</span>
<span class="sd">        maximum (0.5 for 1 sigma).  Set to nan if the change in the</span>
<span class="sd">        log-likelihood function at the upper bound of the ``xval``</span>
<span class="sd">        input array is less than the value for the given CL.</span>

<span class="sd">    err : float</span>
<span class="sd">        Symmetric 1-sigma error.  Average of ``err_lo`` and ``err_hi``</span>
<span class="sd">        if both are defined.</span>

<span class="sd">    ll : float</span>
<span class="sd">        Lower limit evaluated at confidence level ``cl_limit``.</span>

<span class="sd">    ul : float</span>
<span class="sd">        Upper limit evaluated at confidence level ``cl_limit``.</span>

<span class="sd">    lnlmax : float</span>
<span class="sd">        Log-likelihood value at ``x0``.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dlnl_limit</span> <span class="o">=</span> <span class="n">onesided_cl_to_dlnl</span><span class="p">(</span><span class="n">cl_limit</span><span class="p">)</span>
    <span class="n">dlnl_err</span> <span class="o">=</span> <span class="n">twosided_cl_to_dlnl</span><span class="p">(</span><span class="n">cl_err</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Pad the likelihood function</span>
        <span class="c1"># if len(xval) &gt;= 3 and np.max(loglike) - loglike[-1] &lt; 1.5*dlnl_limit:</span>
        <span class="c1">#    p = np.polyfit(xval[-3:], loglike[-3:], 2)</span>
        <span class="c1">#    x = np.linspace(xval[-1], 10 * xval[-1], 3)[1:]</span>
        <span class="c1">#    y = np.polyval(p, x)</span>
        <span class="c1">#    x = np.concatenate((xval, x))</span>
        <span class="c1">#    y = np.concatenate((loglike, y))</span>
        <span class="c1"># else:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">xval</span><span class="p">,</span> <span class="n">loglike</span>
        <span class="n">spline</span> <span class="o">=</span> <span class="n">UnivariateSpline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                  <span class="c1">#k=min(len(xval) - 1, 3),</span>
                                  <span class="n">w</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">tol</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to create spline: &quot;</span><span class="p">,</span> <span class="n">xval</span><span class="p">,</span> <span class="n">loglike</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;ul&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;ll&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                <span class="s1">&#39;err_lo&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;err_hi&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;err&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                <span class="s1">&#39;lnlmax&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">}</span>

    <span class="n">sd</span> <span class="o">=</span> <span class="n">spline</span><span class="o">.</span><span class="n">derivative</span><span class="p">()</span>

    <span class="n">imax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">loglike</span><span class="p">)</span>
    <span class="n">ilo</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">imax</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ihi</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">imax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">xval</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Find the peak</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">xval</span><span class="p">[</span><span class="n">imax</span><span class="p">]</span>

    <span class="c1"># Refine the peak position</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">sd</span><span class="p">(</span><span class="n">xval</span><span class="p">[</span><span class="n">ilo</span><span class="p">]))</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">sd</span><span class="p">(</span><span class="n">xval</span><span class="p">[</span><span class="n">ihi</span><span class="p">])):</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">find_function_root</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">xval</span><span class="p">[</span><span class="n">ilo</span><span class="p">],</span> <span class="n">xval</span><span class="p">[</span><span class="n">ihi</span><span class="p">])</span>

    <span class="n">lnlmax</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">spline</span><span class="p">(</span><span class="n">x0</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">t</span><span class="p">):</span> <span class="k">return</span> <span class="n">spline</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">-</span> <span class="n">lnlmax</span>
    <span class="n">fn_val</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">xval</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">fn_val</span><span class="p">[</span><span class="n">imax</span><span class="p">:]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">dlnl_limit</span><span class="p">):</span>
        <span class="n">xhi</span> <span class="o">=</span> <span class="n">xval</span><span class="p">[</span><span class="n">imax</span><span class="p">:][</span><span class="n">fn_val</span><span class="p">[</span><span class="n">imax</span><span class="p">:]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">dlnl_limit</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xhi</span> <span class="o">=</span> <span class="n">xval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>        
    <span class="c1"># EAC: brute force check that xhi is greater than x0</span>
    <span class="c1"># The fabs is here in case x0 is negative</span>
    <span class="k">if</span> <span class="n">xhi</span> <span class="o">&lt;=</span> <span class="n">x0</span><span class="p">:</span>
        <span class="n">xhi</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">fn_val</span><span class="p">[:</span><span class="n">imax</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">dlnl_limit</span><span class="p">):</span>
        <span class="n">xlo</span> <span class="o">=</span> <span class="n">xval</span><span class="p">[:</span><span class="n">imax</span><span class="p">][</span><span class="n">fn_val</span><span class="p">[:</span><span class="n">imax</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">dlnl_limit</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xlo</span> <span class="o">=</span> <span class="n">xval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># EAC: brute force check that xlo is less than x0</span>
    <span class="c1"># The fabs is here in case x0 is negative        </span>
    <span class="k">if</span> <span class="n">xlo</span> <span class="o">&gt;=</span> <span class="n">x0</span><span class="p">:</span>
        <span class="n">xlo</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>

    <span class="n">ul</span> <span class="o">=</span> <span class="n">find_function_root</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">xhi</span><span class="p">,</span> <span class="n">dlnl_limit</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
    <span class="n">ll</span> <span class="o">=</span> <span class="n">find_function_root</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">xlo</span><span class="p">,</span> <span class="n">dlnl_limit</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
    <span class="n">err_lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x0</span> <span class="o">-</span> <span class="n">find_function_root</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">xlo</span><span class="p">,</span> <span class="n">dlnl_err</span><span class="p">,</span>
                                            <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">))</span>
    <span class="n">err_hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x0</span> <span class="o">-</span> <span class="n">find_function_root</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">xhi</span><span class="p">,</span> <span class="n">dlnl_err</span><span class="p">,</span>
                                            <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">))</span>

    <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">err_lo</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">err_hi</span><span class="p">):</span>
        <span class="n">err</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">err_lo</span> <span class="o">+</span> <span class="n">err_hi</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">err_hi</span><span class="p">):</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">err_hi</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">err_lo</span><span class="p">):</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">err_lo</span>

    <span class="n">o</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="n">x0</span><span class="p">,</span> <span class="s1">&#39;ul&#39;</span><span class="p">:</span> <span class="n">ul</span><span class="p">,</span> <span class="s1">&#39;ll&#39;</span><span class="p">:</span> <span class="n">ll</span><span class="p">,</span>
         <span class="s1">&#39;err_lo&#39;</span><span class="p">:</span> <span class="n">err_lo</span><span class="p">,</span> <span class="s1">&#39;err_hi&#39;</span><span class="p">:</span> <span class="n">err_hi</span><span class="p">,</span> <span class="s1">&#39;err&#39;</span><span class="p">:</span> <span class="n">err</span><span class="p">,</span>
         <span class="s1">&#39;lnlmax&#39;</span><span class="p">:</span> <span class="n">lnlmax</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">o</span></div>


<div class="viewcode-block" id="poly_to_parabola"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.poly_to_parabola">[docs]</a><span class="k">def</span> <span class="nf">poly_to_parabola</span><span class="p">(</span><span class="n">coeff</span><span class="p">):</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="o">-</span><span class="n">coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="n">coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">y0</span></div>


<div class="viewcode-block" id="parabola"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.parabola">[docs]</a><span class="k">def</span> <span class="nf">parabola</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Evaluate a 2D parabola given by:</span>

<span class="sd">    f(x,y) = f_0 - (1/2) * \delta^T * R * \Sigma * R^T * \delta</span>

<span class="sd">    where</span>

<span class="sd">    \delta = [(x - x_0), (y - y_0)]</span>

<span class="sd">    and R is the matrix for a 2D rotation by angle \theta and \Sigma</span>
<span class="sd">    is the covariance matrix:</span>

<span class="sd">    \Sigma = [[1/\sigma_x^2, 0           ],</span>
<span class="sd">              [0           , 1/\sigma_y^2]] </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xy : tuple    </span>
<span class="sd">       Tuple containing x and y arrays for the values at which the</span>
<span class="sd">       parabola will be evaluated.</span>

<span class="sd">    amplitude : float</span>
<span class="sd">       Constant offset value.</span>

<span class="sd">    x0 : float</span>
<span class="sd">       Centroid in x coordinate.</span>

<span class="sd">    y0 : float</span>
<span class="sd">       Centroid in y coordinate.</span>

<span class="sd">    sx : float</span>
<span class="sd">       Standard deviation along first axis (x-axis when theta=0).</span>

<span class="sd">    sy : float</span>
<span class="sd">       Standard deviation along second axis (y-axis when theta=0).</span>

<span class="sd">    theta : float</span>
<span class="sd">       Rotation angle in radians.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vals : `~numpy.ndarray`    </span>
<span class="sd">       Values of the parabola evaluated at the points defined in the</span>
<span class="sd">       `xy` input tuple.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">cth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">sth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">cth</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sx</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">sth</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sy</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">theta</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">sx</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">theta</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span>
        <span class="mi">4</span> <span class="o">*</span> <span class="n">sy</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">sth</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sx</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cth</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sy</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">amplitude</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
                        <span class="mi">2</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">+</span>
                        <span class="n">c</span> <span class="o">*</span> <span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">vals</span></div>


<div class="viewcode-block" id="get_bounded_slice"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.get_bounded_slice">[docs]</a><span class="k">def</span> <span class="nf">get_bounded_slice</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">dpix</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>

    <span class="n">dpix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dpix</span><span class="p">)</span>
    <span class="n">idx_lo</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">-</span> <span class="n">dpix</span>
    <span class="n">idx_hi</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">dpix</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">idx_lo</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">idx_lo</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">idx_lo</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">idx_hi</span> <span class="o">=</span> <span class="n">idx_lo</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dpix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">idx_hi</span> <span class="o">&gt;</span> <span class="n">shape</span><span class="p">:</span>
        <span class="n">idx_hi</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">idx_hi</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
        <span class="n">idx_lo</span> <span class="o">=</span> <span class="n">idx_hi</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dpix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">slice</span><span class="p">(</span><span class="n">idx_lo</span><span class="p">,</span> <span class="n">idx_hi</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_region_mask"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.get_region_mask">[docs]</a><span class="k">def</span> <span class="nf">get_region_mask</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get mask of connected region within delta of max(z).&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">xy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span> <span class="o">=</span> <span class="n">xy</span>

    <span class="n">mz</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="n">z</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span> <span class="o">-</span> <span class="n">delta</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">label</span><span class="p">(</span><span class="n">mz</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mz</span> <span class="o">&amp;=</span> <span class="n">labels</span> <span class="o">==</span> <span class="n">labels</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">mz</span></div>


<div class="viewcode-block" id="fit_parabola"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.fit_parabola">[docs]</a><span class="k">def</span> <span class="nf">fit_parabola</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">dpix</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">zmin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fit a parabola to a 2D numpy array.  This function will fit a</span>
<span class="sd">    parabola with the functional form described in</span>
<span class="sd">    `~fermipy.utils.parabola` to a 2D slice of the input array `z`.</span>
<span class="sd">    The fit region encompasses pixels that are within `dpix` of the</span>
<span class="sd">    pixel coordinate (iz,iy) OR that have a value relative to the peak</span>
<span class="sd">    value greater than `zmin`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    z : `~numpy.ndarray`</span>

<span class="sd">    ix : int</span>
<span class="sd">       X index of center pixel of fit region in array `z`.</span>

<span class="sd">    iy : int</span>
<span class="sd">       Y index of center pixel of fit region in array `z`.</span>

<span class="sd">    dpix : int</span>
<span class="sd">       Max distance from center pixel of fit region.</span>

<span class="sd">    zmin : float</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">make_pixel_distance</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                       <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>

    <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;=</span> <span class="n">dpix</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;=</span> <span class="n">dpix</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">zmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">|=</span> <span class="n">get_region_mask</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">zmin</span><span class="p">),</span> <span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">))</span>

    <span class="n">sx</span> <span class="o">=</span> <span class="n">get_bounded_slice</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">dpix</span><span class="p">,</span> <span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sy</span> <span class="o">=</span> <span class="n">get_bounded_slice</span><span class="p">(</span><span class="n">iy</span><span class="p">,</span> <span class="n">dpix</span><span class="p">,</span> <span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">coeffx</span> <span class="o">=</span> <span class="n">poly_to_parabola</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">sx</span><span class="p">,</span> <span class="n">iy</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">sx</span><span class="p">,</span> <span class="n">iy</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">coeffy</span> <span class="o">=</span> <span class="n">poly_to_parabola</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">sy</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">sy</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>
    <span class="c1">#p0 = [coeffx[2], coeffx[0], coeffy[0], coeffx[1], coeffy[1], 0.0]</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="n">coeffx</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">ix</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">iy</span><span class="p">),</span> <span class="n">coeffx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coeffy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">]</span>

    <span class="n">o</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fit_success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;p0&#39;</span><span class="p">:</span> <span class="n">p0</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">curve_fit_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">parabola</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
        <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
        <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
        <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span>
        <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span>
        <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">curve_fit</span><span class="p">(</span><span class="n">curve_fit_fn</span><span class="p">,</span>
                                              <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">m</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">m</span><span class="p">])),</span>
                                              <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">m</span><span class="p">]),</span> <span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">popt</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span>
        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;fit_success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">fm</span> <span class="o">=</span> <span class="n">parabola</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">m</span><span class="p">]),</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">fm</span> <span class="o">-</span> <span class="n">z</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
    <span class="n">rchi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">fm</span><span class="p">)</span>

    <span class="n">o</span><span class="p">[</span><span class="s1">&#39;rchi2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rchi2</span>
    <span class="n">o</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">o</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">o</span><span class="p">[</span><span class="s1">&#39;sigmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">o</span><span class="p">[</span><span class="s1">&#39;sigmay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">o</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;sigmax&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;sigmay&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">o</span><span class="p">[</span><span class="s1">&#39;z0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">o</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">o</span><span class="p">[</span><span class="s1">&#39;popt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">popt</span>
    <span class="n">o</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>

    <span class="n">a</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;sigmax&#39;</span><span class="p">],</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;sigmay&#39;</span><span class="p">])</span>
    <span class="n">b</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;sigmax&#39;</span><span class="p">],</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;sigmay&#39;</span><span class="p">])</span>

    <span class="n">o</span><span class="p">[</span><span class="s1">&#39;eccentricity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">b</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">a</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">o</span><span class="p">[</span><span class="s1">&#39;eccentricity2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">b</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">o</span></div>


<div class="viewcode-block" id="split_bin_edges"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.split_bin_edges">[docs]</a><span class="k">def</span> <span class="nf">split_bin_edges</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">npts</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Subdivide an array of bins by splitting each bin into ``npts``</span>
<span class="sd">    subintervals.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    edges : `~numpy.ndarray`</span>
<span class="sd">        Bin edge array.</span>

<span class="sd">    npts : int</span>
<span class="sd">        Number of intervals into which each bin will be subdivided.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    edges : `~numpy.ndarray`</span>
<span class="sd">        Subdivided bin edge array.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">npts</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">edges</span>

    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span>
         <span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">*</span>
         <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">npts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">x</span><span class="p">))</span></div>


<div class="viewcode-block" id="center_to_edge"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.center_to_edge">[docs]</a><span class="k">def</span> <span class="nf">center_to_edge</span><span class="p">(</span><span class="n">center</span><span class="p">):</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">center</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">center</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">edges</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">center</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">delta</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">center</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">delta</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">edges</span></div>


<div class="viewcode-block" id="edge_to_center"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.edge_to_center">[docs]</a><span class="k">def</span> <span class="nf">edge_to_center</span><span class="p">(</span><span class="n">edges</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="edge_to_width"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.edge_to_width">[docs]</a><span class="k">def</span> <span class="nf">edge_to_width</span><span class="p">(</span><span class="n">edges</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="val_to_bin"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.val_to_bin">[docs]</a><span class="k">def</span> <span class="nf">val_to_bin</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert axis coordinate to bin index.&quot;&quot;&quot;</span>
    <span class="n">ibin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">ibin</span></div>


<div class="viewcode-block" id="val_to_pix"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.val_to_pix">[docs]</a><span class="k">def</span> <span class="nf">val_to_pix</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">center</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span></div>


<div class="viewcode-block" id="val_to_edge"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.val_to_edge">[docs]</a><span class="k">def</span> <span class="nf">val_to_edge</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert axis coordinate to bin index.&quot;&quot;&quot;</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ibin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">edges</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">ibin</span><span class="p">[</span><span class="n">ibin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">ibin</span></div>


<div class="viewcode-block" id="val_to_bin_bounded"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.val_to_bin_bounded">[docs]</a><span class="k">def</span> <span class="nf">val_to_bin_bounded</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert axis coordinate to bin index.&quot;&quot;&quot;</span>
    <span class="n">nbins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">ibin</span> <span class="o">=</span> <span class="n">val_to_bin</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">ibin</span><span class="p">[</span><span class="n">ibin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ibin</span><span class="p">[</span><span class="n">ibin</span> <span class="o">&gt;</span> <span class="n">nbins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nbins</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">ibin</span></div>


<div class="viewcode-block" id="extend_array"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.extend_array">[docs]</a><span class="k">def</span> <span class="nf">extend_array</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">binsz</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extend an array to encompass lo and hi values.&quot;&quot;&quot;</span>

    <span class="n">numlo</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">lo</span><span class="p">)</span> <span class="o">/</span> <span class="n">binsz</span><span class="p">))</span>
    <span class="n">numhi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">hi</span> <span class="o">-</span> <span class="n">edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">binsz</span><span class="p">))</span>

    <span class="n">edges</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">numlo</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">edges_lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">numlo</span> <span class="o">*</span> <span class="n">binsz</span><span class="p">,</span> <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">numlo</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">edges_lo</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">edges</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">numhi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">edges_hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">numhi</span> <span class="o">*</span> <span class="n">binsz</span><span class="p">,</span> <span class="n">numhi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">edges</span><span class="p">,</span> <span class="n">edges_hi</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>

    <span class="k">return</span> <span class="n">edges</span></div>


<div class="viewcode-block" id="mkdir"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.mkdir">[docs]</a><span class="k">def</span> <span class="nf">mkdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="nb">dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dir</span></div>


<div class="viewcode-block" id="fits_recarray_to_dict"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.fits_recarray_to_dict">[docs]</a><span class="k">def</span> <span class="nf">fits_recarray_to_dict</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a FITS recarray to a python dictionary.&quot;&quot;&quot;</span>

    <span class="n">cols</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">icol</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>

        <span class="n">col_data</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">col_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span>
            <span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">col_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">col_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
            <span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">col_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">col_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">col_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">col_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">string_</span><span class="p">:</span>
            <span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">col_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">col_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">:</span>
            <span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">col_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">col_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">col_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s1">&#39;Unrecognized column type: </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">col_data</span><span class="p">))))</span>

    <span class="k">return</span> <span class="n">cols</span></div>


<div class="viewcode-block" id="unicode_to_str"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.unicode_to_str">[docs]</a><span class="k">def</span> <span class="nf">unicode_to_str</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">o</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="k">if</span> <span class="n">isstr</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="n">o</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">o</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">return</span> <span class="n">o</span></div>


<div class="viewcode-block" id="isstr"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.isstr">[docs]</a><span class="k">def</span> <span class="nf">isstr</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;String instance testing method that works under both Python 2.X</span>
<span class="sd">    and 3.X.  Returns true if the input is a string.&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span></div>


<div class="viewcode-block" id="xmlpath_to_path"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.xmlpath_to_path">[docs]</a><span class="k">def</span> <span class="nf">xmlpath_to_path</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">path</span>

    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\$\(([a-zA-Z\_]+)\)&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\1&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="path_to_xmlpath"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.path_to_xmlpath">[docs]</a><span class="k">def</span> <span class="nf">path_to_xmlpath</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">path</span>

    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\$([a-zA-Z\_]+)&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$(\1)&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_xml_element"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.create_xml_element">[docs]</a><span class="k">def</span> <span class="nf">create_xml_element</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attrib</span><span class="p">):</span>
    <span class="n">el</span> <span class="o">=</span> <span class="n">et</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrib</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">isstr</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="n">el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="n">el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">el</span></div>


<div class="viewcode-block" id="load_xml_elements"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.load_xml_elements">[docs]</a><span class="k">def</span> <span class="nf">load_xml_elements</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="n">o</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

        <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="n">o</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">attrib</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">o</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">attrib</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">o</span></div>


<div class="viewcode-block" id="prettify_xml"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.prettify_xml">[docs]</a><span class="k">def</span> <span class="nf">prettify_xml</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a pretty-printed XML string for the Element.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">xml.dom</span> <span class="k">import</span> <span class="n">minidom</span>
    <span class="kn">import</span> <span class="nn">xml.etree.cElementTree</span> <span class="k">as</span> <span class="nn">et</span>

    <span class="n">rough_string</span> <span class="o">=</span> <span class="n">et</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">reparsed</span> <span class="o">=</span> <span class="n">minidom</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">rough_string</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">reparsed</span><span class="o">.</span><span class="n">toprettyxml</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="s2">&quot;  &quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="arg_to_list"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.arg_to_list">[docs]</a><span class="k">def</span> <span class="nf">arg_to_list</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">arg</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">arg</span><span class="p">]</span></div>


<div class="viewcode-block" id="update_keys"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.update_keys">[docs]</a><span class="k">def</span> <span class="nf">update_keys</span><span class="p">(</span><span class="n">input_dict</span><span class="p">,</span> <span class="n">key_map</span><span class="p">):</span>
    <span class="n">o</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">input_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">key_map</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">o</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">update_keys</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">key_map</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">o</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">return</span> <span class="n">o</span></div>


<div class="viewcode-block" id="create_dict"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.create_dict">[docs]</a><span class="k">def</span> <span class="nf">create_dict</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">d0</span><span class="p">)</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">merge_dict</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">add_new_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">o</span></div>


<div class="viewcode-block" id="merge_dict"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.merge_dict">[docs]</a><span class="k">def</span> <span class="nf">merge_dict</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">add_new_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">append_arrays</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Recursively merge the contents of python dictionary d0 with</span>
<span class="sd">    the contents of another python dictionary, d1.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    d0 : dict</span>
<span class="sd">       The input dictionary.</span>

<span class="sd">    d1 : dict</span>
<span class="sd">       Dictionary to be merged with the input dictionary.</span>

<span class="sd">    add_new_keys : str</span>
<span class="sd">       Do not skip keys that only exist in d1.</span>

<span class="sd">    append_arrays : bool</span>
<span class="sd">       If an element is a numpy array set the value of that element by</span>
<span class="sd">       concatenating the two arrays.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">d1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">d0</span>
    <span class="k">elif</span> <span class="n">d0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">d1</span>
    <span class="k">elif</span> <span class="n">d0</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">d1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">od</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d0</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="n">t0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d0</span><span class="p">:</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d1</span><span class="p">:</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d1</span><span class="p">:</span>
            <span class="n">od</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">od</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">merge_dict</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">add_new_keys</span><span class="p">,</span> <span class="n">append_arrays</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isstr</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
            <span class="n">od</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">od</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">append_arrays</span><span class="p">:</span>
            <span class="n">od</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t0</span> <span class="o">!=</span> <span class="n">t1</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">t0</span> <span class="o">==</span> <span class="nb">dict</span> <span class="ow">or</span> <span class="n">t0</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Conflicting types in dictionary merge for &#39;</span>
                                <span class="s1">&#39;key </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">))</span>
            <span class="n">od</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">t0</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">od</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">add_new_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d1</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d0</span><span class="p">:</span>
                <span class="n">od</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">od</span></div>


<div class="viewcode-block" id="merge_list_of_dicts"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.merge_list_of_dicts">[docs]</a><span class="k">def</span> <span class="nf">merge_list_of_dicts</span><span class="p">(</span><span class="n">listofdicts</span><span class="p">):</span>
    <span class="c1"># assumes every item in list has the same keys</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">listofdicts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">merged</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">listofdicts</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">merged</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">listofdicts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">merged</span></div>


<div class="viewcode-block" id="tolist"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.tolist">[docs]</a><span class="k">def</span> <span class="nf">tolist</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; convenience function that takes in a</span>
<span class="sd">        nested structure of lists and dictionaries</span>
<span class="sd">        and converts everything to its base objects.</span>
<span class="sd">        This is useful for dupming a file to yaml.</span>

<span class="sd">        (a) numpy arrays into python lists</span>

<span class="sd">            &gt;&gt;&gt; type(tolist(np.asarray(123))) == int</span>
<span class="sd">            True</span>
<span class="sd">            &gt;&gt;&gt; tolist(np.asarray([1,2,3])) == [1,2,3]</span>
<span class="sd">            True</span>

<span class="sd">        (b) numpy strings into python strings.</span>

<span class="sd">            &gt;&gt;&gt; tolist([np.asarray(&#39;cat&#39;)])==[&#39;cat&#39;]</span>
<span class="sd">            True</span>

<span class="sd">        (c) an ordered dict to a dict</span>

<span class="sd">            &gt;&gt;&gt; ordered=OrderedDict(a=1, b=2)</span>
<span class="sd">            &gt;&gt;&gt; type(tolist(ordered)) == dict</span>
<span class="sd">            True</span>

<span class="sd">        (d) converts unicode to regular strings</span>

<span class="sd">            &gt;&gt;&gt; type(u&#39;a&#39;) == str</span>
<span class="sd">            False</span>
<span class="sd">            &gt;&gt;&gt; type(tolist(u&#39;a&#39;)) == str</span>
<span class="sd">            True</span>

<span class="sd">        (e) converts numbers &amp; bools in strings to real represntation,</span>
<span class="sd">            (i.e. &#39;123&#39; -&gt; 123)</span>

<span class="sd">            &gt;&gt;&gt; type(tolist(np.asarray(&#39;123&#39;))) == int</span>
<span class="sd">            True</span>
<span class="sd">            &gt;&gt;&gt; type(tolist(&#39;123&#39;)) == int</span>
<span class="sd">            True</span>
<span class="sd">            &gt;&gt;&gt; tolist(&#39;False&#39;) == False</span>
<span class="sd">            True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="n">tolist</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">tolist</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">tolist</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">):</span>
        <span class="c1"># note, call tolist again to convert strings of numbers to numbers</span>
        <span class="k">return</span> <span class="n">tolist</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">isstr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">str</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># convert unicode &amp; numpy strings</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="create_hpx_disk_region_string"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.create_hpx_disk_region_string">[docs]</a><span class="k">def</span> <span class="nf">create_hpx_disk_region_string</span><span class="p">(</span><span class="n">skyDir</span><span class="p">,</span> <span class="n">coordsys</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">inclusive</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Make an all-sky region</span>
    <span class="k">if</span> <span class="n">radius</span> <span class="o">&gt;=</span> <span class="mf">90.</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">coordsys</span> <span class="o">==</span> <span class="s2">&quot;GAL&quot;</span><span class="p">:</span>
        <span class="n">xref</span> <span class="o">=</span> <span class="n">skyDir</span><span class="o">.</span><span class="n">galactic</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">deg</span>
        <span class="n">yref</span> <span class="o">=</span> <span class="n">skyDir</span><span class="o">.</span><span class="n">galactic</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">deg</span>
    <span class="k">elif</span> <span class="n">coordsys</span> <span class="o">==</span> <span class="s2">&quot;CEL&quot;</span><span class="p">:</span>
        <span class="n">xref</span> <span class="o">=</span> <span class="n">skyDir</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span>
        <span class="n">yref</span> <span class="o">=</span> <span class="n">skyDir</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unrecognized coordinate system </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">coordsys</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">inclusive</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="s2">&quot;DISK_INC(</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%i</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xref</span><span class="p">,</span> <span class="n">yref</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">inclusive</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="s2">&quot;DISK(</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xref</span><span class="p">,</span> <span class="n">yref</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">val</span></div>


<div class="viewcode-block" id="convolve2d_disk"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.convolve2d_disk">[docs]</a><span class="k">def</span> <span class="nf">convolve2d_disk</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">nstep</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Evaluate the convolution f&#39;(r) = f(r) * g(r) where f(r) is</span>
<span class="sd">    azimuthally symmetric function in two dimensions and g is a</span>
<span class="sd">    step function given by:</span>

<span class="sd">    g(r) = H(1-r/s)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    fn : function</span>
<span class="sd">      Input function that takes a single radial coordinate parameter.</span>

<span class="sd">    r :  `~numpy.ndarray`</span>
<span class="sd">      Array of points at which the convolution is to be evaluated.</span>

<span class="sd">    sig : float</span>
<span class="sd">      Radius parameter of the step function.</span>

<span class="sd">    nstep : int</span>
<span class="sd">      Number of sampling point for numeric integration.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">rmin</span> <span class="o">=</span> <span class="n">r</span> <span class="o">-</span> <span class="n">sig</span>
    <span class="n">rmax</span> <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="n">sig</span>
    <span class="n">rmin</span><span class="p">[</span><span class="n">rmin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">rmax</span> <span class="o">-</span> <span class="n">rmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">nstep</span>

    <span class="n">redge</span> <span class="o">=</span> <span class="n">rmin</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> \
        <span class="n">delta</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nstep</span><span class="p">,</span> <span class="n">nstep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">rp</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">redge</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">redge</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">dr</span> <span class="o">=</span> <span class="n">redge</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">redge</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">fnv</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
    <span class="n">cphi</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">dr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="p">((</span><span class="n">rp</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">sig</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">rrp</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">rp</span>
    <span class="n">sx</span> <span class="o">=</span> <span class="n">r</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">rp</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">sig</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">cphi</span><span class="p">[</span><span class="o">~</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">sx</span><span class="p">[</span><span class="o">~</span><span class="n">m</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">rrp</span><span class="p">[</span><span class="o">~</span><span class="n">m</span><span class="p">])</span>
    <span class="n">dphi</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cphi</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">rp</span> <span class="o">*</span> <span class="n">fnv</span> <span class="o">*</span> <span class="n">dphi</span> <span class="o">*</span> <span class="n">dr</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">sig</span> <span class="o">*</span> <span class="n">sig</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="convolve2d_gauss"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.convolve2d_gauss">[docs]</a><span class="k">def</span> <span class="nf">convolve2d_gauss</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">nstep</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Evaluate the convolution f&#39;(r) = f(r) * g(r) where f(r) is</span>
<span class="sd">    azimuthally symmetric function in two dimensions and g is a</span>
<span class="sd">    2D gaussian with standard deviation s given by:</span>

<span class="sd">    g(r) = 1/(2*pi*s^2) Exp[-r^2/(2*s^2)]</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    fn : function</span>
<span class="sd">      Input function that takes a single radial coordinate parameter.</span>

<span class="sd">    r :  `~numpy.ndarray`</span>
<span class="sd">      Array of points at which the convolution is to be evaluated.</span>

<span class="sd">    sig : float</span>
<span class="sd">      Width parameter of the gaussian.</span>

<span class="sd">    nstep : int</span>
<span class="sd">      Number of sampling point for numeric integration.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">rmin</span> <span class="o">=</span> <span class="n">r</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">sig</span>
    <span class="n">rmax</span> <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">sig</span>
    <span class="n">rmin</span><span class="p">[</span><span class="n">rmin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">rmax</span> <span class="o">-</span> <span class="n">rmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">nstep</span>

    <span class="n">redge</span> <span class="o">=</span> <span class="p">(</span><span class="n">rmin</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span>
             <span class="n">delta</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span>
             <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nstep</span><span class="p">,</span> <span class="n">nstep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">rp</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">redge</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">redge</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">dr</span> <span class="o">=</span> <span class="n">redge</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">redge</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">fnv</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
    <span class="n">sig2</span> <span class="o">=</span> <span class="n">sig</span> <span class="o">*</span> <span class="n">sig</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">rp</span> <span class="o">/</span> <span class="p">(</span><span class="n">sig2</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;je_fn&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">convolve2d_gauss</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">je</span> <span class="o">=</span> <span class="n">special</span><span class="o">.</span><span class="n">ive</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">convolve2d_gauss</span><span class="o">.</span><span class="n">je_fn</span> <span class="o">=</span> <span class="n">UnivariateSpline</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">je</span> <span class="o">=</span> <span class="n">convolve2d_gauss</span><span class="o">.</span><span class="n">je_fn</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">flat</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1">#je2 = special.ive(0,x)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">rp</span> <span class="o">*</span> <span class="n">fnv</span> <span class="o">/</span> <span class="p">(</span><span class="n">sig2</span><span class="p">)</span> <span class="o">*</span> <span class="n">je</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="n">rp</span> <span class="o">*</span> <span class="n">rp</span><span class="p">)</span> <span class="o">/</span>
                                         <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sig2</span><span class="p">))</span> <span class="o">*</span> <span class="n">dr</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="make_pixel_distance"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.make_pixel_distance">[docs]</a><span class="k">def</span> <span class="nf">make_pixel_distance</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">xpix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ypix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fill a 2D array with dimensions `shape` with the distance of each</span>
<span class="sd">    pixel from a reference direction (xpix,ypix) in pixel coordinates.</span>
<span class="sd">    Pixel coordinates are defined such that (0,0) is located at the</span>
<span class="sd">    center of the corner pixel.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">shape</span><span class="p">,</span> <span class="n">shape</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">xpix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xpix</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>

    <span class="k">if</span> <span class="n">ypix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ypix</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>

    <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">xpix</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">ypix</span>
    <span class="n">dxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">dxy</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dy</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dxy</span></div>


<div class="viewcode-block" id="make_gaussian_kernel"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.make_gaussian_kernel">[docs]</a><span class="k">def</span> <span class="nf">make_gaussian_kernel</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">npix</span><span class="o">=</span><span class="mi">501</span><span class="p">,</span> <span class="n">cdelt</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">xpix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ypix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make kernel for a 2D gaussian.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    sigma : float</span>
<span class="sd">      Standard deviation in degrees.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sigma</span> <span class="o">/=</span> <span class="n">cdelt</span>

    <span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span> <span class="k">return</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">s</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
        <span class="o">-</span><span class="n">t</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">s</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">))</span>
    <span class="n">dxy</span> <span class="o">=</span> <span class="n">make_pixel_distance</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">xpix</span><span class="p">,</span> <span class="n">ypix</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">dxy</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">/=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">cdelt</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">k</span></div>


<div class="viewcode-block" id="make_disk_kernel"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.make_disk_kernel">[docs]</a><span class="k">def</span> <span class="nf">make_disk_kernel</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">npix</span><span class="o">=</span><span class="mi">501</span><span class="p">,</span> <span class="n">cdelt</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">xpix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ypix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make kernel for a 2D disk.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    radius : float</span>
<span class="sd">      Disk radius in deg.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">radius</span> <span class="o">/=</span> <span class="n">cdelt</span>

    <span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span> <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="n">dxy</span> <span class="o">=</span> <span class="n">make_pixel_distance</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">xpix</span><span class="p">,</span> <span class="n">ypix</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">dxy</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">/=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">cdelt</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">k</span></div>


<div class="viewcode-block" id="make_cdisk_kernel"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.make_cdisk_kernel">[docs]</a><span class="k">def</span> <span class="nf">make_cdisk_kernel</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">npix</span><span class="p">,</span> <span class="n">cdelt</span><span class="p">,</span> <span class="n">xpix</span><span class="p">,</span> <span class="n">ypix</span><span class="p">,</span> <span class="n">psf_scale_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make a kernel for a PSF-convolved 2D disk.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    psf : `~fermipy.irfs.PSFModel`</span>

<span class="sd">    sigma : float</span>
<span class="sd">      68% containment radius in degrees.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sigma</span> <span class="o">/=</span> <span class="mf">0.8246211251235321</span>

    <span class="n">dtheta</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">dtheta</span>
    <span class="n">egy</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">energies</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">make_pixel_distance</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">xpix</span><span class="p">,</span> <span class="n">ypix</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">*=</span> <span class="n">cdelt</span>

    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">egy</span><span class="p">),</span> <span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">egy</span><span class="p">)):</span>
        <span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">t</span><span class="p">):</span> <span class="k">return</span> <span class="n">psf</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">scale_fn</span><span class="o">=</span><span class="n">psf_scale_fn</span><span class="p">)</span>
        <span class="n">psfc</span> <span class="o">=</span> <span class="n">convolve2d_disk</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">dtheta</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">dtheta</span><span class="p">,</span> <span class="n">psfc</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">/=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">cdelt</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">k</span></div>


<div class="viewcode-block" id="make_cgauss_kernel"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.make_cgauss_kernel">[docs]</a><span class="k">def</span> <span class="nf">make_cgauss_kernel</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">npix</span><span class="p">,</span> <span class="n">cdelt</span><span class="p">,</span> <span class="n">xpix</span><span class="p">,</span> <span class="n">ypix</span><span class="p">,</span> <span class="n">psf_scale_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make a kernel for a PSF-convolved 2D gaussian.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    psf : `~fermipy.irfs.PSFModel`</span>

<span class="sd">    sigma : float</span>
<span class="sd">      68% containment radius in degrees.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sigma</span> <span class="o">/=</span> <span class="mf">1.5095921854516636</span>

    <span class="n">dtheta</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">dtheta</span>
    <span class="n">egy</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">energies</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">make_pixel_distance</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">xpix</span><span class="p">,</span> <span class="n">ypix</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">*=</span> <span class="n">cdelt</span>

    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">egy</span><span class="p">),</span> <span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">egy</span><span class="p">)):</span>
        <span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">t</span><span class="p">):</span> <span class="k">return</span> <span class="n">psf</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">scale_fn</span><span class="o">=</span><span class="n">psf_scale_fn</span><span class="p">)</span>
        <span class="n">psfc</span> <span class="o">=</span> <span class="n">convolve2d_gauss</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">dtheta</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">dtheta</span><span class="p">,</span> <span class="n">psfc</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">/=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">cdelt</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">k</span></div>


<div class="viewcode-block" id="memoize"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.memoize">[docs]</a><span class="k">def</span> <span class="nf">memoize</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">memoizer</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">memoizer</span></div>


<div class="viewcode-block" id="make_radial_kernel"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.make_radial_kernel">[docs]</a><span class="k">def</span> <span class="nf">make_radial_kernel</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">npix</span><span class="p">,</span> <span class="n">cdelt</span><span class="p">,</span> <span class="n">xpix</span><span class="p">,</span> <span class="n">ypix</span><span class="p">,</span> <span class="n">psf_scale_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">klims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make a kernel for a general radially symmetric 2D function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    psf : `~fermipy.irfs.PSFModel`</span>

<span class="sd">    fn : callable</span>
<span class="sd">        Function that evaluates the kernel at a radial coordinate r.</span>

<span class="sd">    sigma : float</span>
<span class="sd">        68% containment radius in degrees.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">klims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">egy</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">energies</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">egy</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="n">klims</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">klims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">ang_dist</span> <span class="o">=</span> <span class="n">make_pixel_distance</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">xpix</span><span class="p">,</span> <span class="n">ypix</span><span class="p">)</span> <span class="o">*</span> <span class="n">cdelt</span>
    <span class="n">max_ang_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ang_dist</span><span class="p">)</span> <span class="o">+</span> <span class="n">cdelt</span>
    <span class="c1">#dtheta = np.linspace(0.0, (np.max(ang_dist) * 1.05)**0.5, 200)**2.0</span>
    <span class="c1"># z = create_kernel_function_lookup(psf, fn, sigma, egy,</span>
    <span class="c1">#                                  dtheta, psf_scale_fn)</span>

    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">egy</span><span class="p">),</span> <span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">r99</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">containment_angle</span><span class="p">(</span><span class="n">energies</span><span class="o">=</span><span class="n">egy</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.997</span><span class="p">)</span>
    <span class="n">r34</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">containment_angle</span><span class="p">(</span><span class="n">energies</span><span class="o">=</span><span class="n">egy</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.34</span><span class="p">)</span>

    <span class="n">rmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">r34</span> <span class="o">/</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="n">rmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">r99</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">rmin</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">rmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">rmax</span><span class="p">,</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">r34</span> <span class="o">+</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>
    <span class="n">rmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">rmax</span><span class="p">,</span> <span class="n">max_ang_dist</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">egy</span><span class="p">)):</span>

        <span class="n">rebin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">cdelt</span> <span class="o">/</span> <span class="n">rmin</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sparse</span><span class="p">:</span>
            <span class="n">dtheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">rmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span><span class="o">**</span><span class="mf">2.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dtheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">max_ang_dist</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span><span class="o">**</span><span class="mf">2.0</span>

        <span class="n">z</span> <span class="o">=</span> <span class="n">eval_radial_kernel</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dtheta</span><span class="p">,</span> <span class="n">psf_scale_fn</span><span class="p">)</span>
        <span class="n">xdist</span> <span class="o">=</span> <span class="n">make_pixel_distance</span><span class="p">(</span><span class="n">npix</span> <span class="o">*</span> <span class="n">rebin</span><span class="p">,</span>
                                    <span class="n">xpix</span> <span class="o">*</span> <span class="n">rebin</span> <span class="o">+</span> <span class="p">(</span><span class="n">rebin</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span>
                                    <span class="n">ypix</span> <span class="o">*</span> <span class="n">rebin</span> <span class="o">+</span> <span class="p">(</span><span class="n">rebin</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
        <span class="n">xdist</span> <span class="o">*=</span> <span class="n">cdelt</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">rebin</span><span class="p">)</span>
        <span class="c1">#x = val_to_pix(dtheta, np.ravel(xdist))</span>

        <span class="k">if</span> <span class="n">sparse</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">xdist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">rmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">kk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xdist</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="c1">#kk[m] = map_coordinates(z, [x[m]], order=2, prefilter=False)</span>
            <span class="n">kk</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">xdist</span><span class="p">)[</span><span class="n">m</span><span class="p">],</span> <span class="n">dtheta</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
            <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xdist</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">xdist</span><span class="p">),</span> <span class="n">dtheta</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xdist</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="c1"># kk = map_coordinates(z, [x], order=2,</span>
            <span class="c1">#                     prefilter=False).reshape(xdist.shape)</span>

        <span class="k">if</span> <span class="n">rebin</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">kk</span> <span class="o">=</span> <span class="n">sum_bins</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rebin</span><span class="p">)</span>
            <span class="n">kk</span> <span class="o">=</span> <span class="n">sum_bins</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rebin</span><span class="p">)</span>

        <span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">rebin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">egy</span><span class="p">),)</span> <span class="o">+</span> <span class="n">ang_dist</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">/=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">cdelt</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">k</span></div>


<div class="viewcode-block" id="eval_radial_kernel"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.eval_radial_kernel">[docs]</a><span class="k">def</span> <span class="nf">eval_radial_kernel</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">dtheta</span><span class="p">,</span> <span class="n">psf_scale_fn</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">psf</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">dtheta</span><span class="p">,</span> <span class="n">scale_fn</span><span class="o">=</span><span class="n">psf_scale_fn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">psf</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">scale_fn</span><span class="o">=</span><span class="n">psf_scale_fn</span><span class="p">),</span>
                  <span class="n">dtheta</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span></div>


<span class="c1">#@memoize</span>
<div class="viewcode-block" id="create_kernel_function_lookup"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.create_kernel_function_lookup">[docs]</a><span class="k">def</span> <span class="nf">create_kernel_function_lookup</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">egy</span><span class="p">,</span> <span class="n">dtheta</span><span class="p">,</span> <span class="n">psf_scale_fn</span><span class="p">):</span>

    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">egy</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">dtheta</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">egy</span><span class="p">)):</span>

        <span class="k">if</span> <span class="n">fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dtheta</span><span class="p">,</span> <span class="n">scale_fn</span><span class="o">=</span><span class="n">psf_scale_fn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">psf</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">scale_fn</span><span class="o">=</span><span class="n">psf_scale_fn</span><span class="p">),</span>
                      <span class="n">dtheta</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">z</span></div>


<div class="viewcode-block" id="create_radial_spline"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.create_radial_spline">[docs]</a><span class="k">def</span> <span class="nf">create_radial_spline</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">egy</span><span class="p">,</span> <span class="n">dtheta</span><span class="p">,</span> <span class="n">psf_scale_fn</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">scipy.ndimage.interpolation</span> <span class="k">import</span> <span class="n">spline_filter</span>

    <span class="n">z</span> <span class="o">=</span> <span class="n">create_kernel_function_lookup</span><span class="p">(</span>
        <span class="n">psf</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">egy</span><span class="p">,</span> <span class="n">dtheta</span><span class="p">,</span> <span class="n">psf_scale_fn</span><span class="p">)</span>
    <span class="n">sp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">sp</span> <span class="o">+=</span> <span class="p">[</span><span class="n">spline_filter</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">sp</span></div>


<div class="viewcode-block" id="make_psf_kernel"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.make_psf_kernel">[docs]</a><span class="k">def</span> <span class="nf">make_psf_kernel</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">npix</span><span class="p">,</span> <span class="n">cdelt</span><span class="p">,</span> <span class="n">xpix</span><span class="p">,</span> <span class="n">ypix</span><span class="p">,</span> <span class="n">psf_scale_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a kernel for a point-source.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    psf : `~fermipy.irfs.PSFModel`</span>

<span class="sd">    npix : int</span>
<span class="sd">        Number of pixels in X and Y dimensions.</span>

<span class="sd">    cdelt : float</span>
<span class="sd">        Pixel size in degrees.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">egy</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">energies</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">make_pixel_distance</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">xpix</span><span class="p">,</span> <span class="n">ypix</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">*=</span> <span class="n">cdelt</span>

    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">egy</span><span class="p">),</span> <span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">egy</span><span class="p">)):</span>
        <span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">scale_fn</span><span class="o">=</span><span class="n">psf_scale_fn</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">/=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">cdelt</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">k</span></div>


<div class="viewcode-block" id="rebin_map"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.rebin_map">[docs]</a><span class="k">def</span> <span class="nf">rebin_map</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">nebin</span><span class="p">,</span> <span class="n">npix</span><span class="p">,</span> <span class="n">rebin</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">rebin</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nebin</span><span class="p">,</span> <span class="n">npix</span> <span class="o">*</span> <span class="n">rebin</span><span class="p">,</span> <span class="n">npix</span><span class="p">,</span> <span class="n">rebin</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nebin</span><span class="p">,</span> <span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">,</span> <span class="n">rebin</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">k</span> <span class="o">/=</span> <span class="n">rebin</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">k</span></div>


<div class="viewcode-block" id="sum_bins"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.sum_bins">[docs]</a><span class="k">def</span> <span class="nf">sum_bins</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">npts</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">npts</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="n">dim</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">/</span> <span class="n">npts</span><span class="p">),</span>
                             <span class="n">npts</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="n">dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="overlap_slices"><a class="viewcode-back" href="../../fermipy.html#fermipy.utils.overlap_slices">[docs]</a><span class="k">def</span> <span class="nf">overlap_slices</span><span class="p">(</span><span class="n">large_array_shape</span><span class="p">,</span> <span class="n">small_array_shape</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modified version of `~astropy.nddata.utils.overlap_slices`.</span>

<span class="sd">    Get slices for the overlapping part of a small and a large array.</span>

<span class="sd">    Given a certain position of the center of the small array, with</span>
<span class="sd">    respect to the large array, tuples of slices are returned which can be</span>
<span class="sd">    used to extract, add or subtract the small array at the given</span>
<span class="sd">    position. This function takes care of the correct behavior at the</span>
<span class="sd">    boundaries, where the small array is cut of appropriately.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    large_array_shape : tuple</span>
<span class="sd">        Shape of the large array.</span>
<span class="sd">    small_array_shape : tuple</span>
<span class="sd">        Shape of the small array.</span>
<span class="sd">    position : tuple</span>
<span class="sd">        Position of the small array&#39;s center, with respect to the large array.</span>
<span class="sd">        Coordinates should be in the same order as the array shape.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    slices_large : tuple of slices</span>
<span class="sd">        Slices in all directions for the large array, such that</span>
<span class="sd">        ``large_array[slices_large]`` extracts the region of the large array</span>
<span class="sd">        that overlaps with the small array.</span>
<span class="sd">    slices_small : slice</span>
<span class="sd">        Slices in all directions for the small array, such that</span>
<span class="sd">        ``small_array[slices_small]`` extracts the region that is inside the</span>
<span class="sd">        large array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get edge coordinates</span>
    <span class="n">edges_min</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="n">small_shape</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">small_shape</span><span class="p">)</span> <span class="ow">in</span>
                 <span class="nb">zip</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">small_array_shape</span><span class="p">)]</span>
    <span class="n">edges_max</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="p">(</span><span class="n">small_shape</span> <span class="o">-</span> <span class="n">small_shape</span> <span class="o">//</span> <span class="mi">2</span><span class="p">))</span> <span class="k">for</span>
                 <span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">small_shape</span><span class="p">)</span> <span class="ow">in</span>
                 <span class="nb">zip</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">small_array_shape</span><span class="p">)]</span>

    <span class="c1"># Set up slices</span>
    <span class="n">slices_large</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">edge_min</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">large_shape</span><span class="p">,</span> <span class="n">edge_max</span><span class="p">))</span>
                         <span class="k">for</span> <span class="p">(</span><span class="n">edge_min</span><span class="p">,</span> <span class="n">edge_max</span><span class="p">,</span> <span class="n">large_shape</span><span class="p">)</span> <span class="ow">in</span>
                         <span class="nb">zip</span><span class="p">(</span><span class="n">edges_min</span><span class="p">,</span> <span class="n">edges_max</span><span class="p">,</span> <span class="n">large_array_shape</span><span class="p">))</span>
    <span class="n">slices_small</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">edge_min</span><span class="p">),</span>
                               <span class="nb">min</span><span class="p">(</span><span class="n">large_shape</span> <span class="o">-</span> <span class="n">edge_min</span><span class="p">,</span>
                                   <span class="n">edge_max</span> <span class="o">-</span> <span class="n">edge_min</span><span class="p">))</span>
                         <span class="k">for</span> <span class="p">(</span><span class="n">edge_min</span><span class="p">,</span> <span class="n">edge_max</span><span class="p">,</span> <span class="n">large_shape</span><span class="p">)</span> <span class="ow">in</span>
                         <span class="nb">zip</span><span class="p">(</span><span class="n">edges_min</span><span class="p">,</span> <span class="n">edges_max</span><span class="p">,</span> <span class="n">large_array_shape</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">slices_large</span><span class="p">,</span> <span class="n">slices_small</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Fermipy Developers

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>