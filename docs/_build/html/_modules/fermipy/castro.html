

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>fermipy.castro &mdash; Fermipy 0.18.0+25.g938c.dirty documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Fermipy
          

          
          </a>

          
            
            
              <div class="version">
                0.18.0+25.g938c.dirty
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../output.html">Output File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fitting.html">ROI Optimization and Fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model.html">Customizing the Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer.html">Developer Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced/index.html">Advanced Analysis Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../validation/index.html">Validation Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fermipy.html">fermipy package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fermipy_jobs.html">fermipy.jobs subpackage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fermipy_diffuse.html">fermipy.diffuse subpackage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Fermipy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../fermipy.html">fermipy</a> &raquo;</li>
        
      <li>fermipy.castro</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for fermipy.castro</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="sd">&quot;&quot;&quot;Utilities for dealing with &#39;castro data&#39;, i.e., 2D table of</span>
<span class="sd">likelihood values.</span>

<span class="sd">Castro data can be tabluated in terms of a variety of variables. The</span>
<span class="sd">most common example is probably a simple SED, where we have the</span>
<span class="sd">likelihood as a function of Energy and Energy Flux.</span>

<span class="sd">However, we could easily convert to the likelihood as a function of</span>
<span class="sd">other variables, such as the Flux normalization and the spectral</span>
<span class="sd">index, or the mass and cross-section of a putative dark matter</span>
<span class="sd">particle.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">fmin</span>

<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="k">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">gammapy.maps</span> <span class="k">import</span> <span class="n">WcsNDMap</span><span class="p">,</span> <span class="n">MapAxis</span>
<span class="kn">from</span> <span class="nn">fermipy</span> <span class="k">import</span> <span class="n">spectrum</span>
<span class="kn">from</span> <span class="nn">fermipy.sourcefind_utils</span> <span class="k">import</span> <span class="n">fit_error_ellipse</span>
<span class="kn">from</span> <span class="nn">fermipy.sourcefind_utils</span> <span class="k">import</span> <span class="n">find_peaks</span>
<span class="kn">from</span> <span class="nn">fermipy.spectrum</span> <span class="k">import</span> <span class="n">SpectralFunction</span><span class="p">,</span> <span class="n">SEDFunctor</span>
<span class="kn">from</span> <span class="nn">fermipy.utils</span> <span class="k">import</span> <span class="n">onesided_cl_to_dlnl</span>
<span class="kn">from</span> <span class="nn">fermipy.utils</span> <span class="k">import</span> <span class="n">twosided_cl_to_dlnl</span>
<span class="kn">from</span> <span class="nn">fermipy.utils</span> <span class="k">import</span> <span class="n">load_yaml</span>

<span class="n">PAR_NAMES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;PowerLaw&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Prefactor&quot;</span><span class="p">,</span> <span class="s2">&quot;Index&quot;</span><span class="p">],</span>
    <span class="s2">&quot;LogParabola&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">],</span>
    <span class="s2">&quot;PLExpCutoff&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Prefactor&quot;</span><span class="p">,</span> <span class="s2">&quot;Index1&quot;</span><span class="p">,</span> <span class="s2">&quot;Cutoff&quot;</span><span class="p">],</span>
<span class="p">}</span>


<div class="viewcode-block" id="convert_sed_cols"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.convert_sed_cols">[docs]</a><span class="k">def</span> <span class="nf">convert_sed_cols</span><span class="p">(</span><span class="n">tab</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Cast SED column names to lowercase.&quot;&quot;&quot;</span>
    <span class="c1"># Update Column names</span>
    <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">tab</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

        <span class="n">newname</span> <span class="o">=</span> <span class="n">colname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">newname</span> <span class="o">=</span> <span class="n">newname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;dfde&#39;</span><span class="p">,</span> <span class="s1">&#39;dnde&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tab</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">newname</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">tab</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">newname</span>

    <span class="k">return</span> <span class="n">tab</span></div>


<div class="viewcode-block" id="Interpolator"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.Interpolator">[docs]</a><span class="k">class</span> <span class="nc">Interpolator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Helper class for interpolating a 1-D function from a</span>
<span class="sd">    set of tabulated values.</span>

<span class="sd">    Safely deals with overflows and underflows</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; C&#39;tor, take input array of x and y value         </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">UnivariateSpline</span><span class="p">,</span> <span class="n">splrep</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">msk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">msk</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">msk</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Failed to build interpolate, empty axis.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xmin</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xmax</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ymin</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ymax</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dydx_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dydx_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fn</span> <span class="o">=</span> <span class="n">UnivariateSpline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sp</span> <span class="o">=</span> <span class="n">splrep</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xmin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the minimum value over which the spline is defined</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmin</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xmax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the maximum value over which the spline is defined</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmax</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the x values used to construct the split</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the y values used to construct the split</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span>

<div class="viewcode-block" id="Interpolator.derivative"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.Interpolator.derivative">[docs]</a>    <span class="k">def</span> <span class="nf">derivative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the derivative a an array of input values</span>

<span class="sd">        x   : the inputs        </span>
<span class="sd">        der : the order of derivative         </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">splev</span>
        <span class="k">return</span> <span class="n">splev</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sp</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="n">der</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the interpolated values for an array of inputs</span>

<span class="sd">        x : the inputs        </span>

<span class="sd">        Note that if any x value is outside the interpolation ranges</span>
<span class="sd">        this will return a linear extrapolation based on the slope</span>
<span class="sd">        at the endpoint</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">below_bounds</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmin</span>
        <span class="n">above_bounds</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmax</span>

        <span class="n">dxhi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmax</span><span class="p">)</span>
        <span class="n">dxlo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmin</span><span class="p">)</span>

        <span class="c1"># UnivariateSpline will only accept 1-D arrays so this</span>
        <span class="c1"># passes a flattened version of the array.</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fn</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="n">y</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">y</span><span class="p">[</span><span class="n">above_bounds</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ymax</span> <span class="o">+</span> <span class="n">dxhi</span><span class="p">[</span><span class="n">above_bounds</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dydx_hi</span><span class="p">)</span>
        <span class="n">y</span><span class="p">[</span><span class="n">below_bounds</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ymin</span> <span class="o">+</span> <span class="n">dxlo</span><span class="p">[</span><span class="n">below_bounds</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dydx_lo</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span></div>


<div class="viewcode-block" id="LnLFn"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.LnLFn">[docs]</a><span class="k">class</span> <span class="nc">LnLFn</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper class for interpolating a 1-D log-likelihood function from a</span>
<span class="sd">    set of tabulated values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">norm_type</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;C&#39;tor, takes input arrays of x and y values</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : array-like</span>
<span class="sd">           Set of values of the free parameter</span>

<span class="sd">        y : array-like</span>
<span class="sd">           Set of values for the _negative_ log-likelhood</span>

<span class="sd">        norm_type :  str</span>
<span class="sd">           String specifying the type of quantity used for the `x`</span>
<span class="sd">           parameter.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Note that class takes and returns the _negative log-likelihood</span>
<span class="sd">        as fitters typically minimize rather than maximize.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span> <span class="o">=</span> <span class="n">Interpolator</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mle</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_norm_type</span> <span class="o">=</span> <span class="n">norm_type</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">interp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the underlying Interpolator object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">norm_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string specifying the quantity used for the normalization.</span>
<span class="sd">        This isn&#39;t actually used in this class, but it is carried so</span>
<span class="sd">        that the class is self-describing.  The possible values are</span>
<span class="sd">        open-ended.  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_type</span>

    <span class="k">def</span> <span class="nf">_compute_mle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the maximum likelihood estimate.</span>

<span class="sd">        Calls `scipy.optimize.brentq` to find the roots of the derivative.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">min_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">min_y</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">min_y</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">argmin_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="n">ix0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">argmin_y</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">ix1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">argmin_y</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="o">.</span><span class="n">derivative</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ix0</span><span class="p">]))</span> <span class="o">==</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="o">.</span><span class="n">derivative</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ix1</span><span class="p">])):</span>
                <span class="n">ix0</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_mle</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">brentq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="o">.</span><span class="n">derivative</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ix0</span><span class="p">],</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ix1</span><span class="p">],</span>
                                              <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-10</span> <span class="o">*</span>
                                              <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>

<div class="viewcode-block" id="LnLFn.mle"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.LnLFn.mle">[docs]</a>    <span class="k">def</span> <span class="nf">mle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the maximum likelihood estimate </span>

<span class="sd">        This will return the cached value, if it exists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_mle</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mle</span></div>

<div class="viewcode-block" id="LnLFn.fn_mle"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.LnLFn.fn_mle">[docs]</a>    <span class="k">def</span> <span class="nf">fn_mle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the function value at the maximum likelihood estimate &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mle</span><span class="p">())</span></div>

<div class="viewcode-block" id="LnLFn.TS"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.LnLFn.TS">[docs]</a>    <span class="k">def</span> <span class="nf">TS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the Test Statistic &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mle</span><span class="p">()))</span></div>

<div class="viewcode-block" id="LnLFn.getDeltaLogLike"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.LnLFn.getDeltaLogLike">[docs]</a>    <span class="k">def</span> <span class="nf">getDeltaLogLike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dlnl</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the point at which the log-likelihood changes by a</span>
<span class="sd">        given value with respect to its value at the MLE.&quot;&quot;&quot;</span>
        <span class="n">mle_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mle</span><span class="p">()</span>
        <span class="c1"># A little bit of paranoia to avoid zeros</span>
        <span class="k">if</span> <span class="n">mle_val</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">mle_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="o">.</span><span class="n">xmin</span>
        <span class="k">if</span> <span class="n">mle_val</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">mle_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">log_mle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">mle_val</span><span class="p">)</span>
        <span class="n">lnl_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn_mle</span><span class="p">()</span>

        <span class="c1"># This ultra-safe code to find an absolute maximum</span>
        <span class="c1"># fmax = self.fn_mle()</span>
        <span class="c1"># m = (fmax-self.interp.y &gt; 0.1+dlnl) &amp; (self.interp.x&gt;self._mle)</span>

        <span class="c1"># if sum(m) == 0:</span>
        <span class="c1">#    xmax = self.interp.x[-1]*10</span>
        <span class="c1"># else:</span>
        <span class="c1">#    xmax = self.interp.x[m][0]</span>

        <span class="c1"># Matt has found that it is faster to use an interpolator</span>
        <span class="c1"># than an actual root-finder to find the root,</span>
        <span class="c1"># probably b/c of python overhead.</span>
        <span class="c1"># That would be something like this:</span>
        <span class="c1"># rf = lambda x: self._interp(x)+dlnl-lnl_max</span>
        <span class="c1"># return opt.brentq(rf,self._mle,self._interp.xmax,</span>
        <span class="c1">#                   xtol=1e-10*np.abs(self._mle))</span>
        <span class="k">if</span> <span class="n">upper</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">log_mle</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="o">.</span><span class="n">xmax</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">retVal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">dlnl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">lnl_max</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mle</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">retVal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">dlnl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lnl_max</span><span class="p">,</span> <span class="n">x</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">retVal</span></div>

<div class="viewcode-block" id="LnLFn.getLimit"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.LnLFn.getLimit">[docs]</a>    <span class="k">def</span> <span class="nf">getLimit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Evaluate the limits corresponding to a C.L. of (1-alpha)%.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alpha :  limit confidence level.</span>
<span class="sd">        upper :  upper or lower limits.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dlnl</span> <span class="o">=</span> <span class="n">onesided_cl_to_dlnl</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDeltaLogLike</span><span class="p">(</span><span class="n">dlnl</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper</span><span class="p">)</span></div>

<div class="viewcode-block" id="LnLFn.getInterval"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.LnLFn.getInterval">[docs]</a>    <span class="k">def</span> <span class="nf">getInterval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Evaluate the interval corresponding to a C.L. of (1-alpha)%.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alpha : limit confidence level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dlnl</span> <span class="o">=</span> <span class="n">twosided_cl_to_dlnl</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="n">lo_lim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDeltaLogLike</span><span class="p">(</span><span class="n">dlnl</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">hi_lim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDeltaLogLike</span><span class="p">(</span><span class="n">dlnl</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">lo_lim</span><span class="p">,</span> <span class="n">hi_lim</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ReferenceSpec"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.ReferenceSpec">[docs]</a><span class="k">class</span> <span class="nc">ReferenceSpec</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class encapsulates data for a reference spectrum.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ne : `int`             </span>
<span class="sd">        Number of energy bins</span>

<span class="sd">    ebins : `~numpy.ndarray`  </span>
<span class="sd">        Array of bin edges.</span>

<span class="sd">    emin : `~numpy.ndarray`  </span>
<span class="sd">        Array of lower bin edges.</span>

<span class="sd">    emax : `~numpy.ndarray`  </span>
<span class="sd">        Array of upper bin edges.</span>

<span class="sd">    bin_widths : `~numpy.ndarray`  </span>
<span class="sd">        Array of energy bin widths.</span>

<span class="sd">    eref : `~numpy.ndarray`  </span>
<span class="sd">        Array of reference energies. Typically these are the geometric</span>
<span class="sd">        mean of the energy bins</span>

<span class="sd">    ref_dnde : `~numpy.ndarray`  </span>
<span class="sd">        Array of differential photon flux values.</span>

<span class="sd">    ref_flux : `~numpy.ndarray`  </span>
<span class="sd">        Array of integral photon flux values.</span>

<span class="sd">    ref_eflux : `~numpy.ndarray` </span>
<span class="sd">        Array of integral energy flux values.</span>

<span class="sd">    ref_npred : `~numpy.ndarray` </span>
<span class="sd">        Array of predicted number of photons in each energy bin.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emin</span><span class="p">,</span> <span class="n">emax</span><span class="p">,</span> <span class="n">ref_dnde</span><span class="p">,</span> <span class="n">ref_flux</span><span class="p">,</span> <span class="n">ref_eflux</span><span class="p">,</span> <span class="n">ref_npred</span><span class="p">,</span> <span class="n">eref</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; C&#39;tor from energy bin edges and refernce fluxes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ebins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">emin</span><span class="p">,</span> <span class="n">emax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ne</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emin</span> <span class="o">=</span> <span class="n">emin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emax</span> <span class="o">=</span> <span class="n">emax</span>
        <span class="k">if</span> <span class="n">eref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_eref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">emax</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_eref</span> <span class="o">=</span> <span class="n">eref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_ebins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ebins</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_bin_widths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ebins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ebins</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ref_dnde</span> <span class="o">=</span> <span class="n">ref_dnde</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ref_flux</span> <span class="o">=</span> <span class="n">ref_flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ref_eflux</span> <span class="o">=</span> <span class="n">ref_eflux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ref_npred</span> <span class="o">=</span> <span class="n">ref_npred</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ne</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_ebins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_ebins</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ebins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ebins</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">emin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emin</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">emax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emax</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bin_widths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bin_widths</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eref</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ref_dnde</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ref_dnde</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ref_flux</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the flux values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ref_flux</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ref_eflux</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the energy flux values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ref_eflux</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ref_npred</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the number of predicted events</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ref_npred</span>

<div class="viewcode-block" id="ReferenceSpec.create_from_table"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.ReferenceSpec.create_from_table">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_from_table</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tab_e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tab_e : `~astropy.table.Table`</span>
<span class="sd">            EBOUNDS table.        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">convert_sed_cols</span><span class="p">(</span><span class="n">tab_e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">emin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tab_e</span><span class="p">[</span><span class="s1">&#39;e_min&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">MeV</span><span class="p">))</span>
            <span class="n">emax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tab_e</span><span class="p">[</span><span class="s1">&#39;e_max&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">MeV</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">emin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tab_e</span><span class="p">[</span><span class="s1">&#39;e_min&#39;</span><span class="p">])</span>
            <span class="n">emax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tab_e</span><span class="p">[</span><span class="s1">&#39;e_max&#39;</span><span class="p">])</span>

        <span class="n">ne</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">emin</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ref_dnde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tab_e</span><span class="p">[</span><span class="s1">&#39;ref_dnde&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ref_dnde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">ne</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ref_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tab_e</span><span class="p">[</span><span class="s1">&#39;ref_flux&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ref_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">ne</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ref_eflux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tab_e</span><span class="p">[</span><span class="s1">&#39;ref_eflux&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ref_eflux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">ne</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ref_npred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tab_e</span><span class="p">[</span><span class="s1">&#39;ref_npred&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ref_npred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">ne</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">emin</span><span class="p">,</span> <span class="n">emax</span><span class="p">,</span> <span class="n">ref_dnde</span><span class="p">,</span> <span class="n">ref_flux</span><span class="p">,</span> <span class="n">ref_eflux</span><span class="p">,</span> <span class="n">ref_npred</span><span class="p">)</span></div>

<div class="viewcode-block" id="ReferenceSpec.build_ebound_table"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.ReferenceSpec.build_ebound_table">[docs]</a>    <span class="k">def</span> <span class="nf">build_ebound_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Build and return an EBOUNDS table with the encapsulated data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;E_MIN&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_emin</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;MeV&#39;</span><span class="p">),</span>
            <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;E_MAX&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_emax</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;MeV&#39;</span><span class="p">),</span>
            <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;E_REF&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_eref</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;MeV&#39;</span><span class="p">),</span>
            <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;REF_DNDE&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ref_dnde</span><span class="p">,</span>
                   <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ph / (MeV cm2 s)&#39;</span><span class="p">),</span>
            <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;REF_FLUX&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ref_flux</span><span class="p">,</span>
                   <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ph / (cm2 s)&#39;</span><span class="p">),</span>
            <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;REF_EFLUX&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ref_eflux</span><span class="p">,</span>
                   <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;MeV / (cm2 s)&#39;</span><span class="p">),</span>
            <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;REF_NPRED&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ref_npred</span><span class="p">,</span>
                   <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ph&#39;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tab</span></div>

    
<div class="viewcode-block" id="ReferenceSpec.create_functor"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.ReferenceSpec.create_functor">[docs]</a>    <span class="k">def</span> <span class="nf">create_functor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specType</span><span class="p">,</span> <span class="n">normType</span><span class="p">,</span> <span class="n">initPars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1E3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a functor object that computes normalizations in a</span>
<span class="sd">        sequence of energy bins for a given spectral model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------  </span>
<span class="sd">        specType : str        </span>
<span class="sd">            The type of spectrum to use.  This can be a string</span>
<span class="sd">            corresponding to the spectral model class name or a</span>
<span class="sd">            `~fermipy.spectrum.SpectralFunction` object.</span>

<span class="sd">        normType : The type of normalization to use</span>

<span class="sd">        initPars : `~numpy.ndarray`        </span>
<span class="sd">            Arrays of parameter values with which the spectral</span>
<span class="sd">            function will be initialized.</span>

<span class="sd">        scale : float</span>
<span class="sd">            The &#39;pivot energy&#39; or energy scale to use for the spectrum</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fn : `~fermipy.spectrum.SEDFunctor`</span>
<span class="sd">            A functor object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">SpectralFunction</span><span class="o">.</span><span class="n">create_functor</span><span class="p">(</span><span class="n">specType</span><span class="p">,</span>
                                             <span class="n">normType</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">_emin</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">_emax</span><span class="p">,</span>
                                             <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">initPars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">specType</span> <span class="o">==</span> <span class="s1">&#39;PowerLaw&#39;</span><span class="p">:</span>
                <span class="n">initPars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5e-13</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">specType</span> <span class="o">==</span> <span class="s1">&#39;LogParabola&#39;</span><span class="p">:</span>
                <span class="n">initPars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5e-13</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">specType</span> <span class="o">==</span> <span class="s1">&#39;PLExpCutoff&#39;</span><span class="p">:</span>
                <span class="n">initPars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5e-13</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1E4</span><span class="p">])</span>

        <span class="n">fn</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">initPars</span>
        <span class="k">return</span> <span class="n">fn</span></div></div>

    

<div class="viewcode-block" id="SpecData"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.SpecData">[docs]</a><span class="k">class</span> <span class="nc">SpecData</span><span class="p">(</span><span class="n">ReferenceSpec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class encapsulates spectral analysis results (best-fit</span>
<span class="sd">    normalizations, errors, etc.), energy binning, and reference</span>
<span class="sd">    spectrum definition.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    norm : `~numpy.ndarray`</span>

<span class="sd">    norm_err : `~numpy.ndarray`</span>

<span class="sd">    flux : `~numpy.ndarray`</span>
<span class="sd">        Array of integral photon flux values.</span>

<span class="sd">    eflux :  `~numpy.ndarray`</span>
<span class="sd">        Array of integral energy flux values.</span>

<span class="sd">    dnde :`~numpy.ndarray`</span>
<span class="sd">        Differential flux values</span>

<span class="sd">    dnde_err :`~numpy.ndarray`</span>
<span class="sd">        Uncertainties on differential flux values</span>

<span class="sd">    e2dnde :`~numpy.ndarray`</span>
<span class="sd">        Differential flux values scaled by E^2</span>

<span class="sd">    e2dnde_err :`~numpy.ndarray`</span>
<span class="sd">        Uncertainties on differential flux values scaled by E^2</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref_spec</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">norm_err</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ref_spec : `~fermipy.castro.ReferenceSpec`</span>
<span class="sd">            Object with energy bin definitions and reference spectra.</span>

<span class="sd">        norm : `~numpy.ndarray`        </span>
<span class="sd">            Array of best-fit normalizations in units of the reference</span>
<span class="sd">            spectrum amplitude.</span>

<span class="sd">        norm_err : `~numpy.ndarray`        </span>
<span class="sd">            Array of uncertainties in units of the reference</span>
<span class="sd">            spectrum amplitude.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SpecData</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ref_spec</span><span class="o">.</span><span class="n">emin</span><span class="p">,</span> <span class="n">ref_spec</span><span class="o">.</span><span class="n">emax</span><span class="p">,</span>
                                       <span class="n">ref_spec</span><span class="o">.</span><span class="n">ref_dnde</span><span class="p">,</span> <span class="n">ref_spec</span><span class="o">.</span><span class="n">ref_flux</span><span class="p">,</span>
                                       <span class="n">ref_spec</span><span class="o">.</span><span class="n">ref_eflux</span><span class="p">,</span> <span class="n">ref_spec</span><span class="o">.</span><span class="n">ref_npred</span><span class="p">,</span>
                                       <span class="n">ref_spec</span><span class="o">.</span><span class="n">eref</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_norm</span> <span class="o">=</span> <span class="n">norm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_norm_err</span> <span class="o">=</span> <span class="n">norm_err</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dnde</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ref_dnde</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dnde_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_err</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ref_dnde</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ref_flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eflux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ref_eflux</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">norm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">norm_err</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_err</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dnde</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dnde</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dnde_err</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dnde_err</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">flux</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flux</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eflux</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eflux</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">e2dnde</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dnde</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">eref</span><span class="o">**</span><span class="mi">2</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">e2dnde_err</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dnde_err</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">evals</span><span class="o">**</span><span class="mi">2</span>

<div class="viewcode-block" id="SpecData.create_from_table"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.SpecData.create_from_table">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_from_table</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tab</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">ReferenceSpec</span><span class="o">.</span><span class="n">create_from_table</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">tab</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">],</span> <span class="n">tab</span><span class="p">[</span><span class="s1">&#39;norm_err&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="SpecData.build_spec_table"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.SpecData.build_spec_table">[docs]</a>    <span class="k">def</span> <span class="nf">build_spec_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">col_emin</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;e_min&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                          <span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">emin</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">emin</span><span class="p">)</span>
        <span class="n">col_emax</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;e_max&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                          <span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">emax</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">emax</span><span class="p">)</span>
        <span class="n">col_ref</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;e_ref&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                         <span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eref</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">emax</span><span class="p">)</span>
        <span class="n">col_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_emin</span><span class="p">,</span> <span class="n">col_emax</span><span class="p">,</span> <span class="n">col_ref</span><span class="p">]</span>
        <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">))</span>
        <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;norm_err&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_err</span><span class="p">))</span>
        <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;dnde&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                               <span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dnde</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dnde</span><span class="p">))</span>
        <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;dnde_err&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                               <span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dnde_err</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dnde_err</span><span class="p">))</span>
        <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                               <span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">))</span>
        <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;eflux&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                               <span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eflux</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eflux</span><span class="p">))</span>

        <span class="n">tab</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">col_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tab</span></div></div>


<div class="viewcode-block" id="CastroData_Base"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData_Base">[docs]</a><span class="k">class</span> <span class="nc">CastroData_Base</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This class wraps the data needed to make a &quot;Castro&quot; plot,</span>
<span class="sd">    namely the log-likelihood as a function of normalization.</span>

<span class="sd">    In this case the x-axes and y-axes are generic</span>
<span class="sd">    Sub-classes can implement particul axes choices (e.g., EFlux v. Energy)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">norm_vals</span><span class="p">,</span> <span class="n">nll_vals</span><span class="p">,</span> <span class="n">nll_offsets</span><span class="p">,</span> <span class="n">norm_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;C&#39;tor</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        norm_vals : `~numpy.ndarray`</span>
<span class="sd">           The normalization values in an N X M array, where N is the</span>
<span class="sd">           number for bins and M number of sampled values for each bin</span>
<span class="sd">           Note that these should be the true values, with the </span>
<span class="sd">           reference spectrum included, and _NOT_ the values w.r.t. to the </span>
<span class="sd">           reference spectrum.</span>

<span class="sd">        nll_vals : `~numpy.ndarray`</span>
<span class="sd">           The _negative_ log-likelihood values in an N X M array,</span>
<span class="sd">           where N is the number for bins and M number of sampled</span>
<span class="sd">           values for each bin</span>

<span class="sd">        nll_offsets : `~numpy.ndarray`</span>
<span class="sd">           The offsets of the log-likelihood values (i.e., the minimum value) in an</span>
<span class="sd">           N array, when N is the number for bins</span>

<span class="sd">        norm_type : str</span>
<span class="sd">           String specifying the quantity used for the normalization,</span>
<span class="sd">           value depend on the sub-class details</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Ensure that input arrays are sorted by the normalization</span>
        <span class="c1"># value in each bin</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">norm_vals</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">norm_vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span>
                                      <span class="n">norm_vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">norm_vals</span> <span class="o">=</span> <span class="n">norm_vals</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">nll_vals</span> <span class="o">=</span> <span class="n">nll_vals</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_norm_vals</span> <span class="o">=</span> <span class="n">norm_vals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nll_vals</span> <span class="o">=</span> <span class="n">nll_vals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nll_offsets</span> <span class="o">=</span> <span class="n">nll_offsets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loglikes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nll_null</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_norm_type</span> <span class="o">=</span> <span class="n">norm_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ny</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">normv</span><span class="p">,</span> <span class="n">nllv</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_norm_vals</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">_nll_vals</span><span class="p">)):</span>
            <span class="n">nllfunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_lnl_fn</span><span class="p">(</span><span class="n">normv</span><span class="p">,</span> <span class="n">nllv</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nll_null</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nll_vals</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loglikes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nllfunc</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the number of profiles &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nx</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ny</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the number of profiles &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ny</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">norm_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the normalization type flag &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_type</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nll_null</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the negative log-likelihood for the null-hypothesis &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nll_null</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nll_offsets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the offsets in the negative log-likelihoods for each bin &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nll_offsets</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the LnLFn object for the ith energy bin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loglikes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the negative log-likelihood for an array of values,</span>
<span class="sd">        summed over the energy bins</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x  : `~numpy.ndarray`</span>
<span class="sd">           Array of N x M values</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        nll_val : `~numpy.ndarray`</span>
<span class="sd">           Array of negative log-likelihood values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nll_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nll_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="c1"># crude hack to force the fitter away from unphysical values</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">return</span> <span class="mf">1000.</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">nll_val</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loglikes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xv</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">nll_val</span>

<div class="viewcode-block" id="CastroData_Base.build_lnl_fn"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData_Base.build_lnl_fn">[docs]</a>    <span class="k">def</span> <span class="nf">build_lnl_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normv</span><span class="p">,</span> <span class="n">nllv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">LnLFn</span><span class="p">(</span><span class="n">normv</span><span class="p">,</span> <span class="n">nllv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="CastroData_Base.norm_derivative"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData_Base.norm_derivative">[docs]</a>    <span class="k">def</span> <span class="nf">norm_derivative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">norm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">norm</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">der_val</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">der_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">der_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">norm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
            <span class="n">der_val</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loglikes</span><span class="p">[</span>
                <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">interp</span><span class="o">.</span><span class="n">derivative</span><span class="p">(</span><span class="n">norm</span> <span class="o">*</span> <span class="n">sv</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">sv</span>
        <span class="k">return</span> <span class="n">der_val</span></div>

<div class="viewcode-block" id="CastroData_Base.derivative"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData_Base.derivative">[docs]</a>    <span class="k">def</span> <span class="nf">derivative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the derivate of the log-like summed over the energy</span>
<span class="sd">        bins</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x   : `~numpy.ndarray`</span>
<span class="sd">           Array of N x M values</span>

<span class="sd">        der : int</span>
<span class="sd">           Order of the derivate</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        der_val : `~numpy.ndarray`</span>
<span class="sd">           Array of negative log-likelihood values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">der_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">der_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">der_val</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loglikes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">interp</span><span class="o">.</span><span class="n">derivative</span><span class="p">(</span><span class="n">xv</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="n">der</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">der_val</span></div>

<div class="viewcode-block" id="CastroData_Base.mles"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData_Base.mles">[docs]</a>    <span class="k">def</span> <span class="nf">mles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the maximum likelihood estimates for each of the energy bins</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mle_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nx</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nx</span><span class="p">):</span>
            <span class="n">mle_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loglikes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mle</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">mle_vals</span></div>

<div class="viewcode-block" id="CastroData_Base.fn_mles"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData_Base.fn_mles">[docs]</a>    <span class="k">def</span> <span class="nf">fn_mles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;returns the summed likelihood at the maximum likelihood estimate</span>

<span class="sd">        Note that simply sums the maximum likelihood values at each</span>
<span class="sd">        bin, and does not impose any sort of constrain between bins</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mle_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mles</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">(</span><span class="n">mle_vals</span><span class="p">)</span></div>

<div class="viewcode-block" id="CastroData_Base.ts_vals"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData_Base.ts_vals">[docs]</a>    <span class="k">def</span> <span class="nf">ts_vals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns test statistic values for each energy bin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ts_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nx</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nx</span><span class="p">):</span>
            <span class="n">ts_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loglikes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">TS</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">ts_vals</span></div>

<div class="viewcode-block" id="CastroData_Base.chi2_vals"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData_Base.chi2_vals">[docs]</a>    <span class="k">def</span> <span class="nf">chi2_vals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the difference in the log-likelihood between the</span>
<span class="sd">        MLE in each energy bin and the normalization predicted by a</span>
<span class="sd">        global best-fit model.  This array can be summed to get a</span>
<span class="sd">        goodness-of-fit chi2 for the model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : `~numpy.ndarray`        </span>
<span class="sd">            An array of normalizations derived from a global fit to</span>
<span class="sd">            all energy bins.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        chi2_vals : `~numpy.ndarray`</span>
<span class="sd">            An array of chi2 values for each energy bin.        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">chi2_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nx</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nx</span><span class="p">):</span>

            <span class="n">mle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loglikes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mle</span><span class="p">()</span>
            <span class="n">nll0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loglikes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">mle</span><span class="p">)</span>
            <span class="n">nll1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loglikes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">chi2_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">nll0</span> <span class="o">-</span> <span class="n">nll1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">chi2_vals</span></div>

<div class="viewcode-block" id="CastroData_Base.getLimits"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData_Base.getLimits">[docs]</a>    <span class="k">def</span> <span class="nf">getLimits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Evaluate the limits corresponding to a C.L. of (1-alpha)%.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alpha :  float</span>
<span class="sd">           limit confidence level.</span>
<span class="sd">        upper :  bool</span>
<span class="sd">           upper or lower limits.</span>

<span class="sd">        returns an array of values, one for each energy bin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">limit_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nx</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nx</span><span class="p">):</span>
            <span class="n">limit_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loglikes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getLimit</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">limit_vals</span></div>

<div class="viewcode-block" id="CastroData_Base.getIntervals"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData_Base.getIntervals">[docs]</a>    <span class="k">def</span> <span class="nf">getIntervals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Evaluate the two-sided intervals corresponding to a C.L. of</span>
<span class="sd">        (1-alpha)%.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alpha :  float</span>
<span class="sd">           limit confidence level.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        limit_vals_hi : `~numpy.ndarray`</span>
<span class="sd">            An array of lower limit values.</span>

<span class="sd">        limit_vals_lo : `~numpy.ndarray`</span>
<span class="sd">            An array of upper limit values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">limit_vals_lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nx</span><span class="p">))</span>
        <span class="n">limit_vals_hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nx</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nx</span><span class="p">):</span>
            <span class="n">lo_lim</span><span class="p">,</span> <span class="n">hi_lim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loglikes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getInterval</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
            <span class="n">limit_vals_lo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lo_lim</span>
            <span class="n">limit_vals_hi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hi_lim</span>

        <span class="k">return</span> <span class="n">limit_vals_lo</span><span class="p">,</span> <span class="n">limit_vals_hi</span></div>

<div class="viewcode-block" id="CastroData_Base.fitNormalization"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData_Base.fitNormalization">[docs]</a>    <span class="k">def</span> <span class="nf">fitNormalization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specVals</span><span class="p">,</span> <span class="n">xlims</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit the normalization given a set of spectral values that</span>
<span class="sd">        define a spectral shape</span>

<span class="sd">        This version is faster, and solves for the root of the derivatvie</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        specVals :  an array of (nebin values that define a spectral shape</span>
<span class="sd">        xlims    :  fit limits     </span>

<span class="sd">        returns the best-fit normalization value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">brentq</span>

        <span class="k">def</span> <span class="nf">fDeriv</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_derivative</span><span class="p">(</span><span class="n">specVals</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">brentq</span><span class="p">(</span><span class="n">fDeriv</span><span class="p">,</span> <span class="n">xlims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xlims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">check_underflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">specVals</span> <span class="o">*</span> <span class="n">xlims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> \
                <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">specVals</span> <span class="o">*</span> <span class="n">xlims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">check_underflow</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">xlims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">xlims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CastroData_Base.fitNorm_v2"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData_Base.fitNorm_v2">[docs]</a>    <span class="k">def</span> <span class="nf">fitNorm_v2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specVals</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit the normalization given a set of spectral values </span>
<span class="sd">        that define a spectral shape.</span>

<span class="sd">        This version uses `scipy.optimize.fmin`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        specVals :  an array of (nebin values that define a spectral shape</span>
<span class="sd">        xlims    :  fit limits     </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        norm : float</span>
<span class="sd">            Best-fit normalization value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">fmin</span>

        <span class="k">def</span> <span class="nf">fToMin</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">specVals</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">fmin</span><span class="p">(</span><span class="n">fToMin</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CastroData_Base.fit_spectrum"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData_Base.fit_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">fit_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specFunc</span><span class="p">,</span> <span class="n">initPars</span><span class="p">,</span> <span class="n">freePars</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fit for the free parameters of a spectral function</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        specFunc : `~fermipy.spectrum.SpectralFunction`</span>
<span class="sd">            The Spectral Function</span>

<span class="sd">        initPars : `~numpy.ndarray`</span>
<span class="sd">            The initial values of the parameters</span>

<span class="sd">        freePars : `~numpy.ndarray`        </span>
<span class="sd">            Boolean array indicating which parameters should be free in</span>
<span class="sd">            the fit.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        params : `~numpy.ndarray`</span>
<span class="sd">            Best-fit parameters.</span>

<span class="sd">        spec_vals : `~numpy.ndarray`</span>
<span class="sd">            The values of the best-fit spectral model in each energy bin.</span>

<span class="sd">        ts_spec : float</span>
<span class="sd">            The TS of the best-fit spectrum</span>

<span class="sd">        chi2_vals : `~numpy.ndarray`</span>
<span class="sd">            Array of chi-squared values for each energy bin.</span>

<span class="sd">        chi2_spec : float</span>
<span class="sd">            Global chi-squared value for the sum of all energy bins.</span>

<span class="sd">        pval_spec : float</span>
<span class="sd">            p-value of chi-squared for the best-fit spectrum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">specFunc</span><span class="p">,</span> <span class="n">SEDFunctor</span><span class="p">):</span>
            <span class="n">specFunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_functor</span><span class="p">(</span><span class="n">specFunc</span><span class="p">,</span> <span class="n">initPars</span><span class="p">,</span>
                                           <span class="n">scale</span><span class="o">=</span><span class="n">specFunc</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">freePars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">freePars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">initPars</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">freePars</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">initPars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">initPars</span><span class="p">)</span>
        <span class="n">freePars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">freePars</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">fToMin</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>

            <span class="n">xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">specFunc</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
            <span class="n">xp</span><span class="p">[</span><span class="n">freePars</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">specFunc</span><span class="p">(</span><span class="n">xp</span><span class="p">))</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">fmin</span><span class="p">(</span><span class="n">fToMin</span><span class="p">,</span> <span class="n">initPars</span><span class="p">[</span><span class="n">freePars</span><span class="p">],</span> <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>

        <span class="n">out_pars</span> <span class="o">=</span> <span class="n">specFunc</span><span class="o">.</span><span class="n">params</span>
        <span class="n">out_pars</span><span class="p">[</span><span class="n">freePars</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="n">spec_vals</span> <span class="o">=</span> <span class="n">specFunc</span><span class="p">(</span><span class="n">out_pars</span><span class="p">)</span>
        <span class="n">spec_npred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spec_vals</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">specFunc</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">SEDFluxFunctor</span><span class="p">):</span>
            <span class="n">spec_npred</span> <span class="o">=</span> <span class="n">spec_vals</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">refSpec</span><span class="o">.</span><span class="n">ref_npred</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">refSpec</span><span class="o">.</span><span class="n">ref_flux</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">specFunc</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">SEDEFluxFunctor</span><span class="p">):</span>
            <span class="n">spec_npred</span> <span class="o">=</span> <span class="n">spec_vals</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">refSpec</span><span class="o">.</span><span class="n">ref_npred</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">refSpec</span><span class="o">.</span><span class="n">ref_eflux</span>

        <span class="n">ts_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TS_spectrum</span><span class="p">(</span><span class="n">spec_vals</span><span class="p">)</span>
        <span class="n">chi2_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chi2_vals</span><span class="p">(</span><span class="n">spec_vals</span><span class="p">)</span>
        <span class="n">chi2_spec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">chi2_vals</span><span class="p">)</span>
        <span class="n">pval_spec</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">chi2_spec</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec_vals</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">out_pars</span><span class="p">,</span> <span class="n">spec_vals</span><span class="o">=</span><span class="n">spec_vals</span><span class="p">,</span>
                    <span class="n">spec_npred</span><span class="o">=</span><span class="n">spec_npred</span><span class="p">,</span>
                    <span class="n">ts_spec</span><span class="o">=</span><span class="n">ts_spec</span><span class="p">,</span> <span class="n">chi2_spec</span><span class="o">=</span><span class="n">chi2_spec</span><span class="p">,</span>
                    <span class="n">chi2_vals</span><span class="o">=</span><span class="n">chi2_vals</span><span class="p">,</span> <span class="n">pval_spec</span><span class="o">=</span><span class="n">pval_spec</span><span class="p">)</span></div>

<div class="viewcode-block" id="CastroData_Base.TS_spectrum"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData_Base.TS_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">TS_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec_vals</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate and the TS for a given set of spectral values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nll_null</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">spec_vals</span><span class="p">))</span></div>

<div class="viewcode-block" id="CastroData_Base.build_scandata_table"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData_Base.build_scandata_table">[docs]</a>    <span class="k">def</span> <span class="nf">build_scandata_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build an `astropy.table.Table` object from these data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_vals</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">col_norm</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">col_normv</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;norm_scan&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                           <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">col_dll</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;dloglike_scan&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                         <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">col_norm</span><span class="p">,</span> <span class="n">col_normv</span><span class="p">,</span> <span class="n">col_dll</span><span class="p">])</span>
        <span class="n">tab</span><span class="o">.</span><span class="n">add_row</span><span class="p">({</span><span class="s2">&quot;norm&quot;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
                     <span class="s2">&quot;norm_scan&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_vals</span><span class="p">,</span>
                     <span class="s2">&quot;dloglike_scan&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nll_vals</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">tab</span></div>

<div class="viewcode-block" id="CastroData_Base.stack_nll"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData_Base.stack_nll">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">stack_nll</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">components</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Combine the log-likelihoods from a number of components.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        shape    :  tuple</span>
<span class="sd">           The shape of the return array</span>

<span class="sd">        components : `~fermipy.castro.CastroData_Base`</span>
<span class="sd">           The components to be stacked</span>

<span class="sd">        weights : array-like</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        norm_vals : `numpy.ndarray`</span>
<span class="sd">           N X M array of Normalization values</span>

<span class="sd">        nll_vals  : `numpy.ndarray`</span>
<span class="sd">           N X M array of log-likelihood values</span>

<span class="sd">        nll_offsets :  `numpy.ndarray`</span>
<span class="sd">           N array of maximum log-likelihood values in each bin</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_bins</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_vals</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)))</span>

        <span class="n">norm_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">nll_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">nll_offsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_bins</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_bins</span><span class="p">):</span>
            <span class="n">log_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ylims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">log_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ylims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">norm_vals</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">log_min</span><span class="p">,</span> <span class="n">log_max</span><span class="p">,</span> <span class="n">n_vals</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">components</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
                <span class="n">nll_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">norm_vals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">c</span><span class="o">.</span><span class="n">nll_offsets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># Reset the offsets</span>
            <span class="n">nll_obj</span> <span class="o">=</span> <span class="n">LnLFn</span><span class="p">(</span><span class="n">norm_vals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nll_vals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">ll_offset</span> <span class="o">=</span> <span class="n">nll_obj</span><span class="o">.</span><span class="n">fn_mle</span><span class="p">()</span>
            <span class="n">nll_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">ll_offset</span>
            <span class="n">nll_offsets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">ll_offset</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">norm_vals</span><span class="p">,</span> <span class="n">nll_vals</span><span class="p">,</span> <span class="n">nll_offsets</span></div>


<div class="viewcode-block" id="CastroData_Base.x_edges"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData_Base.x_edges">[docs]</a>    <span class="k">def</span> <span class="nf">x_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="CastroData"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData">[docs]</a><span class="k">class</span> <span class="nc">CastroData</span><span class="p">(</span><span class="n">CastroData_Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This class wraps the data needed to make a &quot;Castro&quot; plot,</span>
<span class="sd">    namely the log-likelihood as a function of normalization for a</span>
<span class="sd">    series of energy bins.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">norm_vals</span><span class="p">,</span> <span class="n">nll_vals</span><span class="p">,</span> <span class="n">refSpec</span><span class="p">,</span> <span class="n">norm_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; C&#39;tor</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        norm_vals : `~numpy.ndarray`</span>
<span class="sd">           The normalization values ( nEBins X N array, where N is the</span>
<span class="sd">           number of sampled values for each bin )</span>

<span class="sd">        nll_vals : `~numpy.ndarray`</span>
<span class="sd">           The log-likelihood values ( nEBins X N array, where N is</span>
<span class="sd">           the number of sampled values for each bin )</span>

<span class="sd">        refSpec : `~fermipy.sed.ReferenceSpec`</span>
<span class="sd">           The object with the reference spectrum details.</span>

<span class="sd">        norm_type : str</span>
<span class="sd">            Type of normalization to use, options are:</span>

<span class="sd">            * norm : Normalization w.r.t. to test source</span>
<span class="sd">            * flux : Flux of the test source ( ph cm^-2 s^-1 )</span>
<span class="sd">            * eflux: Energy Flux of the test source ( MeV cm^-2 s^-1 )</span>
<span class="sd">            * npred: Number of predicted photons (Not implemented)</span>
<span class="sd">            * dnde : Differential flux of the test source ( ph cm^-2 s^-1</span>
<span class="sd">              MeV^-1 )</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nll_offsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nll_vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CastroData</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">norm_vals</span><span class="p">,</span> <span class="n">nll_vals</span><span class="p">,</span> <span class="n">nll_offsets</span><span class="p">,</span> <span class="n">norm_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refSpec</span> <span class="o">=</span> <span class="n">refSpec</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the number of energy bins.  This is also the number of x-axis bins.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nx</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">refSpec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a `~fermipy.castro.ReferenceSpec` with the spectral data &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refSpec</span>

<div class="viewcode-block" id="CastroData.create_from_yamlfile"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData.create_from_yamlfile">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_from_yamlfile</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">yamlfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a Castro data object from a yaml file contains</span>
<span class="sd">        the likelihood data.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">load_yaml</span><span class="p">(</span><span class="n">yamlfile</span><span class="p">)</span>
        <span class="n">nebins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">emin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;emin&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nebins</span><span class="p">)])</span>
        <span class="n">emax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;emax&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nebins</span><span class="p">)])</span>
        <span class="n">ref_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nebins</span><span class="p">)])</span>
        <span class="n">ref_eflux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;eflux&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nebins</span><span class="p">)])</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;eflux2npred&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nebins</span><span class="p">)])</span>
        <span class="n">ref_npred</span> <span class="o">=</span> <span class="n">conv</span><span class="o">*</span><span class="n">ref_eflux</span>
        <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ref_flux</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">ref_spec</span> <span class="o">=</span> <span class="n">ReferenceSpec</span><span class="p">(</span><span class="n">emin</span><span class="p">,</span> <span class="n">emax</span><span class="p">,</span> <span class="n">ones</span><span class="p">,</span> <span class="n">ref_flux</span><span class="p">,</span> <span class="n">ref_eflux</span><span class="p">,</span> <span class="n">ref_npred</span><span class="p">)</span>
        <span class="n">norm_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;eflux&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nebins</span><span class="p">)])</span>
        <span class="n">ll_data</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;logLike&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nebins</span><span class="p">)])</span>
        <span class="n">max_ll</span> <span class="o">=</span> <span class="n">ll_data</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">nll_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_ll</span> <span class="o">-</span> <span class="n">ll_data</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">norm_data</span><span class="p">,</span> <span class="n">nll_data</span><span class="p">,</span> <span class="n">ref_spec</span><span class="p">,</span> <span class="s1">&#39;eflux&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CastroData.create_from_flux_points"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData.create_from_flux_points">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_from_flux_points</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">txtfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a Castro data object from a text file containing a</span>
<span class="sd">        sequence of differential flux points.&quot;&quot;&quot;</span>

        <span class="n">tab</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">txtfile</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii.ecsv&#39;</span><span class="p">)</span>
        <span class="n">dnde_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">ph</span> <span class="o">/</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">MeV</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">cm</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
        <span class="n">loge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tab</span><span class="p">[</span><span class="s1">&#39;e_ref&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">MeV</span><span class="p">)))</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tab</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dnde_unit</span><span class="p">))</span>
        <span class="n">norm_errp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tab</span><span class="p">[</span><span class="s1">&#39;norm_errp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dnde_unit</span><span class="p">))</span>
        <span class="n">norm_errn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tab</span><span class="p">[</span><span class="s1">&#39;norm_errn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dnde_unit</span><span class="p">))</span>
        <span class="n">norm_err</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">norm_errp</span> <span class="o">+</span> <span class="n">norm_errn</span><span class="p">)</span>
        <span class="n">dloge</span> <span class="o">=</span> <span class="n">loge</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">loge</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dloge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dloge</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dloge</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">emin</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">loge</span> <span class="o">-</span> <span class="n">dloge</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">emax</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">loge</span> <span class="o">+</span> <span class="n">dloge</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ectr</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">loge</span>
        <span class="n">deltae</span> <span class="o">=</span> <span class="n">emax</span> <span class="o">-</span> <span class="n">emin</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">norm</span> <span class="o">*</span> <span class="n">deltae</span>
        <span class="n">eflux</span> <span class="o">=</span> <span class="n">norm</span> <span class="o">*</span> <span class="n">deltae</span> <span class="o">*</span> <span class="n">ectr</span>

        <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">flux</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">ref_spec</span> <span class="o">=</span> <span class="n">ReferenceSpec</span><span class="p">(</span><span class="n">emin</span><span class="p">,</span> <span class="n">emax</span><span class="p">,</span> <span class="n">ones</span><span class="p">,</span> <span class="n">ones</span><span class="p">,</span> <span class="n">ones</span><span class="p">,</span> <span class="n">ones</span><span class="p">)</span>

        <span class="n">spec_data</span> <span class="o">=</span> <span class="n">SpecData</span><span class="p">(</span><span class="n">ref_spec</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">eflux</span><span class="p">,</span> <span class="n">norm_err</span><span class="p">)</span>

        <span class="n">stephi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
        <span class="n">steplo</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)[</span><span class="mi">1</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">loscale</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">norm_err</span>
        <span class="n">hiscale</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">norm_err</span>
        <span class="n">loscale</span><span class="p">[</span><span class="n">loscale</span> <span class="o">&gt;</span> <span class="n">norm</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span><span class="p">[</span><span class="n">loscale</span> <span class="o">&gt;</span> <span class="n">norm</span><span class="p">]</span>

        <span class="n">norm_vals_hi</span> <span class="o">=</span> <span class="n">norm</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> \
            <span class="n">stephi</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">hiscale</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">norm_vals_lo</span> <span class="o">=</span> <span class="n">norm</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> \
            <span class="n">steplo</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">loscale</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="n">norm_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">norm_vals_lo</span><span class="p">,</span> <span class="n">norm_vals_hi</span><span class="p">))</span>
        <span class="n">nll_vals</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> \
            <span class="p">(</span><span class="n">norm_vals</span> <span class="o">-</span> <span class="n">norm</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> \
            <span class="n">norm_err</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="n">norm_vals</span> <span class="o">*=</span> <span class="n">flux</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">/</span> <span class="n">norm</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">norm_vals</span><span class="p">,</span> <span class="n">nll_vals</span><span class="p">,</span> <span class="n">spec_data</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CastroData.create_from_tables"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData.create_from_tables">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_from_tables</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">norm_type</span><span class="o">=</span><span class="s1">&#39;eflux&#39;</span><span class="p">,</span>
                           <span class="n">tab_s</span><span class="o">=</span><span class="s2">&quot;SCANDATA&quot;</span><span class="p">,</span>
                           <span class="n">tab_e</span><span class="o">=</span><span class="s2">&quot;EBOUNDS&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a CastroData object from two tables</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        norm_type : str</span>
<span class="sd">            Type of normalization to use.  Valid options are:</span>

<span class="sd">            * norm : Normalization w.r.t. to test source</span>
<span class="sd">            * flux : Flux of the test source ( ph cm^-2 s^-1 )</span>
<span class="sd">            * eflux: Energy Flux of the test source ( MeV cm^-2 s^-1 )</span>
<span class="sd">            * npred: Number of predicted photons (Not implemented)</span>
<span class="sd">            * dnde : Differential flux of the test source ( ph cm^-2 s^-1</span>
<span class="sd">              MeV^-1 )</span>

<span class="sd">        tab_s : str</span>
<span class="sd">           table scan data</span>

<span class="sd">        tab_e : str</span>
<span class="sd">           table energy binning and normalization data</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        castro : `~fermipy.castro.CastroData`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">norm_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;eflux&#39;</span><span class="p">,</span> <span class="s1">&#39;dnde&#39;</span><span class="p">]:</span>
            <span class="n">norm_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tab_s</span><span class="p">[</span><span class="s1">&#39;norm_scan&#39;</span><span class="p">]</span> <span class="o">*</span>
                                 <span class="n">tab_e</span><span class="p">[</span><span class="s1">&#39;ref_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">norm_type</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">norm_type</span> <span class="o">==</span> <span class="s2">&quot;norm&quot;</span><span class="p">:</span>
            <span class="n">norm_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tab_s</span><span class="p">[</span><span class="s1">&#39;norm_scan&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unrecognized normalization type: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">norm_type</span><span class="p">)</span>

        <span class="n">nll_vals</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tab_s</span><span class="p">[</span><span class="s1">&#39;dloglike_scan&#39;</span><span class="p">])</span>

        <span class="n">rs</span> <span class="o">=</span> <span class="n">ReferenceSpec</span><span class="o">.</span><span class="n">create_from_table</span><span class="p">(</span><span class="n">tab_e</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">norm_vals</span><span class="p">,</span> <span class="n">nll_vals</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">norm_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="CastroData.create_from_fits"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData.create_from_fits">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_from_fits</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fitsfile</span><span class="p">,</span> <span class="n">norm_type</span><span class="o">=</span><span class="s1">&#39;eflux&#39;</span><span class="p">,</span>
                         <span class="n">hdu_scan</span><span class="o">=</span><span class="s2">&quot;SCANDATA&quot;</span><span class="p">,</span>
                         <span class="n">hdu_energies</span><span class="o">=</span><span class="s2">&quot;EBOUNDS&quot;</span><span class="p">,</span>
                         <span class="n">irow</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a CastroData object from a tscube FITS file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fitsfile  : str</span>
<span class="sd">            Name of the fits file</span>

<span class="sd">        norm_type : str</span>
<span class="sd">            Type of normalization to use.  Valid options are:</span>

<span class="sd">            * norm : Normalization w.r.t. to test source</span>
<span class="sd">            * flux : Flux of the test source ( ph cm^-2 s^-1 )</span>
<span class="sd">            * eflux: Energy Flux of the test source ( MeV cm^-2 s^-1 )</span>
<span class="sd">            * npred: Number of predicted photons (Not implemented)</span>
<span class="sd">            * dnde : Differential flux of the test source ( ph cm^-2 s^-1</span>
<span class="sd">              MeV^-1 )</span>

<span class="sd">        hdu_scan : str</span>
<span class="sd">            Name of the FITS HDU with the scan data</span>

<span class="sd">        hdu_energies : str        </span>
<span class="sd">            Name of the FITS HDU with the energy binning and</span>
<span class="sd">            normalization data</span>

<span class="sd">        irow : int or None</span>
<span class="sd">            If none, then this assumes that there is a single row in</span>
<span class="sd">            the scan data table Otherwise, this specifies which row of</span>
<span class="sd">            the table to use</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        castro : `~fermipy.castro.CastroData`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">irow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tab_s</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">,</span> <span class="n">hdu</span><span class="o">=</span><span class="n">hdu_scan</span><span class="p">)[</span><span class="n">irow</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tab_s</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">,</span> <span class="n">hdu</span><span class="o">=</span><span class="n">hdu_scan</span><span class="p">)</span>
        <span class="n">tab_e</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">,</span> <span class="n">hdu</span><span class="o">=</span><span class="n">hdu_energies</span><span class="p">)</span>

        <span class="n">tab_s</span> <span class="o">=</span> <span class="n">convert_sed_cols</span><span class="p">(</span><span class="n">tab_s</span><span class="p">)</span>
        <span class="n">tab_e</span> <span class="o">=</span> <span class="n">convert_sed_cols</span><span class="p">(</span><span class="n">tab_e</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">create_from_tables</span><span class="p">(</span><span class="n">norm_type</span><span class="p">,</span> <span class="n">tab_s</span><span class="p">,</span> <span class="n">tab_e</span><span class="p">)</span></div>

<div class="viewcode-block" id="CastroData.create_from_sedfile"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData.create_from_sedfile">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_from_sedfile</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fitsfile</span><span class="p">,</span> <span class="n">norm_type</span><span class="o">=</span><span class="s1">&#39;eflux&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a CastroData object from an SED fits file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fitsfile  : str </span>
<span class="sd">            Name of the fits file</span>

<span class="sd">        norm_type : str</span>
<span class="sd">            Type of normalization to use, options are:</span>

<span class="sd">            * norm : Normalization w.r.t. to test source</span>
<span class="sd">            * flux : Flux of the test source ( ph cm^-2 s^-1 )</span>
<span class="sd">            * eflux: Energy Flux of the test source ( MeV cm^-2 s^-1 )</span>
<span class="sd">            * npred: Number of predicted photons (Not implemented)</span>
<span class="sd">            * dnde : Differential flux of the test source ( ph cm^-2 s^-1</span>
<span class="sd">              MeV^-1 )</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        castro : `~fermipy.castro.CastroData`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tab_s</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">,</span> <span class="n">hdu</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tab_s</span> <span class="o">=</span> <span class="n">convert_sed_cols</span><span class="p">(</span><span class="n">tab_s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">norm_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;eflux&#39;</span><span class="p">,</span> <span class="s1">&#39;dnde&#39;</span><span class="p">]:</span>
            <span class="n">ref_colname</span> <span class="o">=</span> <span class="s1">&#39;ref_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">norm_type</span>
            <span class="n">norm_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tab_s</span><span class="p">[</span><span class="s1">&#39;norm_scan&#39;</span><span class="p">]</span> <span class="o">*</span>
                                 <span class="n">tab_s</span><span class="p">[</span><span class="n">ref_colname</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">norm_type</span> <span class="o">==</span> <span class="s2">&quot;norm&quot;</span><span class="p">:</span>
            <span class="n">norm_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tab_s</span><span class="p">[</span><span class="s1">&#39;norm_scan&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unrecognized normalization type: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">norm_type</span><span class="p">)</span>

        <span class="n">nll_vals</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tab_s</span><span class="p">[</span><span class="s1">&#39;dloglike_scan&#39;</span><span class="p">])</span>
        <span class="n">ref_spec</span> <span class="o">=</span> <span class="n">ReferenceSpec</span><span class="o">.</span><span class="n">create_from_table</span><span class="p">(</span><span class="n">tab_s</span><span class="p">)</span>
        <span class="n">spec_data</span> <span class="o">=</span> <span class="n">SpecData</span><span class="p">(</span><span class="n">ref_spec</span><span class="p">,</span> <span class="n">tab_s</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">],</span> <span class="n">tab_s</span><span class="p">[</span><span class="s1">&#39;norm_err&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">norm_vals</span><span class="p">,</span> <span class="n">nll_vals</span><span class="p">,</span> <span class="n">spec_data</span><span class="p">,</span> <span class="n">norm_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="CastroData.create_from_stack"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData.create_from_stack">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_from_stack</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">components</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  Combine the log-likelihoods from a number of components.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        shape    :  tuple</span>
<span class="sd">           The shape of the return array</span>

<span class="sd">        components : [~fermipy.castro.CastroData_Base]</span>
<span class="sd">           The components to be stacked</span>

<span class="sd">        weights : array-like</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        castro : `~fermipy.castro.CastroData`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">norm_vals</span><span class="p">,</span> <span class="n">nll_vals</span><span class="p">,</span> <span class="n">nll_offsets</span> <span class="o">=</span> <span class="n">CastroData_Base</span><span class="o">.</span><span class="n">stack_nll</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span>
                                                                     <span class="n">components</span><span class="p">,</span>
                                                                     <span class="n">ylims</span><span class="p">,</span>
                                                                     <span class="n">weights</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">norm_vals</span><span class="p">,</span> <span class="n">nll_vals</span><span class="p">,</span>
                   <span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">refSpec</span><span class="p">,</span>
                   <span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">norm_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="CastroData.spectrum_loglike"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData.spectrum_loglike">[docs]</a>    <span class="k">def</span> <span class="nf">spectrum_loglike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specType</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1E3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the log-likelihood for a particular spectrum</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        specTypes  : str</span>
<span class="sd">            The type of spectrum to try</span>

<span class="sd">        params : array-like</span>
<span class="sd">            The spectral parameters</span>

<span class="sd">        scale : float</span>
<span class="sd">            The energy scale or &#39;pivot&#39; energy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sfn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_functor</span><span class="p">(</span><span class="n">specType</span><span class="p">,</span> <span class="n">scale</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">sfn</span><span class="p">(</span><span class="n">params</span><span class="p">))</span></div>

<div class="viewcode-block" id="CastroData.test_spectra"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData.test_spectra">[docs]</a>    <span class="k">def</span> <span class="nf">test_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec_types</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test different spectral types against the SED represented by this</span>
<span class="sd">        CastroData.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        spec_types : [str,...]</span>
<span class="sd">           List of spectral types to try</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        retDict : dict</span>
<span class="sd">           A dictionary of dictionaries.  The top level dictionary is</span>
<span class="sd">           keyed by spec_type.  The sub-dictionaries each contain:</span>

<span class="sd">           * &quot;Function&quot;    : `~fermipy.spectrum.SpectralFunction`</span>
<span class="sd">           * &quot;Result&quot;      : tuple with the output of scipy.optimize.fmin</span>
<span class="sd">           * &quot;Spectrum&quot;    : `~numpy.ndarray` with best-fit spectral values</span>
<span class="sd">           * &quot;ScaleEnergy&quot; : float, the &#39;pivot energy&#39; value</span>
<span class="sd">           * &quot;TS&quot;          : float, the TS for the best-fit spectrum</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spec_types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PowerLaw&quot;</span><span class="p">,</span> <span class="s2">&quot;LogParabola&quot;</span><span class="p">,</span> <span class="s2">&quot;PLExpCutoff&quot;</span><span class="p">]</span>

        <span class="n">retDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">specType</span> <span class="ow">in</span> <span class="n">spec_types</span><span class="p">:</span>
            <span class="n">spec_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_functor</span><span class="p">(</span><span class="n">specType</span><span class="p">)</span>
            <span class="n">fit_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_spectrum</span><span class="p">(</span><span class="n">spec_func</span><span class="p">,</span> <span class="n">spec_func</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

            <span class="n">specDict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Function&quot;</span><span class="p">:</span> <span class="n">spec_func</span><span class="p">,</span>
                        <span class="s2">&quot;Result&quot;</span><span class="p">:</span> <span class="n">fit_out</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">],</span>
                        <span class="s2">&quot;Spectrum&quot;</span><span class="p">:</span> <span class="n">fit_out</span><span class="p">[</span><span class="s1">&#39;spec_vals&#39;</span><span class="p">],</span>
                        <span class="s2">&quot;ScaleEnergy&quot;</span><span class="p">:</span> <span class="n">spec_func</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                        <span class="s2">&quot;TS&quot;</span><span class="p">:</span> <span class="n">fit_out</span><span class="p">[</span><span class="s1">&#39;ts_spec&#39;</span><span class="p">]}</span>

            <span class="n">retDict</span><span class="p">[</span><span class="n">specType</span><span class="p">]</span> <span class="o">=</span> <span class="n">specDict</span>

        <span class="k">return</span> <span class="n">retDict</span></div>

<div class="viewcode-block" id="CastroData.create_functor"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData.create_functor">[docs]</a>    <span class="k">def</span> <span class="nf">create_functor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specType</span><span class="p">,</span> <span class="n">initPars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1E3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a functor object that computes normalizations in a</span>
<span class="sd">        sequence of energy bins for a given spectral model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        specType : str        </span>
<span class="sd">            The type of spectrum to use.  This can be a string</span>
<span class="sd">            corresponding to the spectral model class name or a</span>
<span class="sd">            `~fermipy.spectrum.SpectralFunction` object.</span>

<span class="sd">        initPars : `~numpy.ndarray`        </span>
<span class="sd">            Arrays of parameter values with which the spectral</span>
<span class="sd">            function will be initialized.</span>

<span class="sd">        scale : float</span>
<span class="sd">            The &#39;pivot energy&#39; or energy scale to use for the spectrum</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fn : `~fermipy.spectrum.SEDFunctor`</span>
<span class="sd">            A functor object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refSpec</span><span class="o">.</span><span class="n">create_functor</span><span class="p">(</span><span class="n">specType</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span><span class="p">,</span> <span class="n">initPars</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="CastroData.x_edges"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.CastroData.x_edges">[docs]</a>    <span class="k">def</span> <span class="nf">x_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refSpec</span><span class="o">.</span><span class="n">emax</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refSpec</span><span class="o">.</span><span class="n">emin</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div></div>
    


<div class="viewcode-block" id="TSCube"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.TSCube">[docs]</a><span class="k">class</span> <span class="nc">TSCube</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class wrapping a TSCube, which is a collection of CastroData</span>
<span class="sd">    objects for a set of directions.</span>

<span class="sd">    This class wraps a combination of:</span>

<span class="sd">    * Pixel data,</span>
<span class="sd">    * Pixel x Energy bin data,</span>
<span class="sd">    * Pixel x Energy Bin x Normalization scan point data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tsmap</span><span class="p">,</span> <span class="n">normmap</span><span class="p">,</span> <span class="n">tscube</span><span class="p">,</span> <span class="n">normcube</span><span class="p">,</span>
                 <span class="n">norm_vals</span><span class="p">,</span> <span class="n">nll_vals</span><span class="p">,</span> <span class="n">refSpec</span><span class="p">,</span> <span class="n">norm_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;C&#39;tor</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tsmap : `~gammapy.maps.WcsNDMap`</span>
<span class="sd">           A Map object with the TestStatistic values in each pixel</span>

<span class="sd">        normmap : `~gammapy.maps.WcsNDMap`</span>
<span class="sd">           A Map object with the normalization values in each pixel</span>

<span class="sd">        tscube : `~gammapy.maps.WcsNDMap`</span>
<span class="sd">           A Map object with the TestStatistic values in each pixel &amp;</span>
<span class="sd">           energy bin</span>

<span class="sd">        normcube : `~gammapy.maps.WcsNDMap`</span>
<span class="sd">           A Map object with the normalization values in each pixel &amp;</span>
<span class="sd">           energy bin</span>

<span class="sd">        norm_vals : `~numpy.ndarray`</span>
<span class="sd">           The normalization values ( nEBins X N array, where N is the</span>
<span class="sd">           number of sampled values for each bin )</span>

<span class="sd">        nll_vals : `~numpy.ndarray`</span>
<span class="sd">           The negative log-likelihood values ( nEBins X N array, where N is</span>
<span class="sd">           the number of sampled values for each bin )</span>

<span class="sd">        refSpec : `~fermipy.castro.ReferenceSpec`</span>
<span class="sd">           The ReferenceSpec object with the reference values.</span>

<span class="sd">        norm_type : str</span>
<span class="sd">            Type of normalization to use, options are:</span>

<span class="sd">            * norm : Normalization w.r.t. to test source</span>
<span class="sd">            * flux : Flux of the test source ( ph cm^-2 s^-1 )</span>
<span class="sd">            * eflux: Energy Flux of the test source ( MeV cm^-2 s^-1 )</span>
<span class="sd">            * npred: Number of predicted photons (Not implemented)</span>
<span class="sd">            * dnde : Differential flux of the test source ( ph cm^-2 s^-1</span>
<span class="sd">              MeV^-1 )</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tsmap</span> <span class="o">=</span> <span class="n">tsmap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_normmap</span> <span class="o">=</span> <span class="n">normmap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tscube</span> <span class="o">=</span> <span class="n">tscube</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_normcube</span> <span class="o">=</span> <span class="n">normcube</span>
        <span class="k">if</span> <span class="n">tscube</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ts_cumul</span> <span class="o">=</span> <span class="n">tscube</span><span class="o">.</span><span class="n">sum_over_axes</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ts_cumul</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refSpec</span> <span class="o">=</span> <span class="n">refSpec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_norm_vals</span> <span class="o">=</span> <span class="n">norm_vals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nll_vals</span> <span class="o">=</span> <span class="n">nll_vals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refSpec</span><span class="o">.</span><span class="n">nE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nN</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_norm_type</span> <span class="o">=</span> <span class="n">norm_type</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nvals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of values in the tscube&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tsmap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the Map of the TestStatistic value &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tsmap</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">normmap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the Map of the Best-fit normalization value &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normmap</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tscube</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the Cube of the TestStatistic value per pixel / energy bin&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tscube</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">normcube</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the Cube of the normalization value per pixel / energy bin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normcube</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ts_cumul</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the Map of the cumulative TestStatistic value per pixel</span>
<span class="sd">        (summed over energy bin)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ts_cumul</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">refSpec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the Spectral Data object &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refSpec</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the number of energy bins &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nE</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nN</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the number of sample points in each energy bin &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nN</span>

<div class="viewcode-block" id="TSCube.create_from_fits"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.TSCube.create_from_fits">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_from_fits</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fitsfile</span><span class="p">,</span> <span class="n">norm_type</span><span class="o">=</span><span class="s1">&#39;flux&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build a TSCube object from a fits file created by gttscube</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fitsfile : str</span>
<span class="sd">           Path to the tscube FITS file.</span>

<span class="sd">        norm_type : str</span>
<span class="sd">           String specifying the quantity used for the normalization</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tsmap</span> <span class="o">=</span> <span class="n">WcsNDMap</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>

        <span class="n">tab_e</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">,</span> <span class="s1">&#39;EBOUNDS&#39;</span><span class="p">)</span>
        <span class="n">tab_e</span> <span class="o">=</span> <span class="n">convert_sed_cols</span><span class="p">(</span><span class="n">tab_e</span><span class="p">)</span>        
        <span class="n">tab_f</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">,</span> <span class="s1">&#39;FITDATA&#39;</span><span class="p">)</span>
        <span class="n">tab_f</span> <span class="o">=</span> <span class="n">convert_sed_cols</span><span class="p">(</span><span class="n">tab_f</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tab_s</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">,</span> <span class="s1">&#39;SCANDATA&#39;</span><span class="p">)</span>
            <span class="n">tab_s</span> <span class="o">=</span> <span class="n">convert_sed_cols</span><span class="p">(</span><span class="n">tab_s</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">tab_s</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">emin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tab_e</span><span class="p">[</span><span class="s1">&#39;e_min&#39;</span><span class="p">])</span>
        <span class="n">emax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tab_e</span><span class="p">[</span><span class="s1">&#39;e_max&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">tab_e</span><span class="p">[</span><span class="s1">&#39;e_min&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;keV&#39;</span><span class="p">:</span>
                <span class="n">emin</span> <span class="o">/=</span> <span class="mf">1000.</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">tab_e</span><span class="p">[</span><span class="s1">&#39;e_max&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;keV&#39;</span><span class="p">:</span>
                <span class="n">emax</span> <span class="o">/=</span> <span class="mf">1000.</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">nebins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tab_e</span><span class="p">)</span>
        <span class="n">npred</span> <span class="o">=</span> <span class="n">tab_e</span><span class="p">[</span><span class="s1">&#39;ref_npred&#39;</span><span class="p">]</span>

        <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tsmap</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">cube_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">tsmap</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                          <span class="n">tsmap</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nebins</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cube_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">tsmap</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nebins</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Counts map has dimension </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ndim</span><span class="p">))</span>

        <span class="n">refSpec</span> <span class="o">=</span> <span class="n">ReferenceSpec</span><span class="o">.</span><span class="n">create_from_table</span><span class="p">(</span><span class="n">tab_e</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tab_s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nll_vals</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tab_s</span><span class="p">[</span><span class="s2">&quot;dloglike_scan&quot;</span><span class="p">])</span>
            <span class="n">norm_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tab_s</span><span class="p">[</span><span class="s2">&quot;norm_scan&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nll_vals</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">norm_vals</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">axis</span> <span class="o">=</span> <span class="n">MapAxis</span><span class="o">.</span><span class="n">from_edges</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">emin</span><span class="p">,</span> <span class="n">emax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:])),</span>
                                  <span class="n">interp</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">geom_3d</span> <span class="o">=</span> <span class="n">tsmap</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">to_cube</span><span class="p">([</span><span class="n">axis</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">tab_s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tscube</span> <span class="o">=</span> <span class="n">WcsNDMap</span><span class="p">(</span><span class="n">geom_3d</span><span class="p">,</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">rollaxis</span><span class="p">(</span><span class="n">tab_s</span><span class="p">[</span><span class="s2">&quot;ts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">cube_shape</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">ncube</span> <span class="o">=</span> <span class="n">WcsNDMap</span><span class="p">(</span><span class="n">geom_3d</span><span class="p">,</span>
                             <span class="n">np</span><span class="o">.</span><span class="n">rollaxis</span><span class="p">(</span><span class="n">tab_s</span><span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">cube_shape</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tscube</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ncube</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nmap</span> <span class="o">=</span> <span class="n">WcsNDMap</span><span class="p">(</span><span class="n">tsmap</span><span class="o">.</span><span class="n">geom</span><span class="p">,</span>
                            <span class="n">tab_f</span><span class="p">[</span><span class="s1">&#39;fit_norm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tsmap</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">nmap</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">ref_colname</span> <span class="o">=</span> <span class="s1">&#39;ref_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">norm_type</span>
        <span class="k">if</span> <span class="n">norm_vals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">norm_vals</span> <span class="o">*=</span> <span class="n">tab_e</span><span class="p">[</span><span class="n">ref_colname</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">tsmap</span><span class="p">,</span> <span class="n">nmap</span><span class="p">,</span> <span class="n">tscube</span><span class="p">,</span> <span class="n">ncube</span><span class="p">,</span>
                   <span class="n">norm_vals</span><span class="p">,</span> <span class="n">nll_vals</span><span class="p">,</span> <span class="n">refSpec</span><span class="p">,</span>
                   <span class="n">norm_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="TSCube.castroData_from_ipix"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.TSCube.castroData_from_ipix">[docs]</a>    <span class="k">def</span> <span class="nf">castroData_from_ipix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ipix</span><span class="p">,</span> <span class="n">colwise</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Build a CastroData object for a particular pixel &quot;&quot;&quot;</span>
        <span class="c1"># pix = utils.skydir_to_pix</span>
        <span class="k">if</span> <span class="n">colwise</span><span class="p">:</span>
            <span class="n">ipix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tsmap</span><span class="o">.</span><span class="n">ipix_swap_axes</span><span class="p">(</span><span class="n">ipix</span><span class="p">,</span> <span class="n">colwise</span><span class="p">)</span>
        <span class="n">norm_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_vals</span><span class="p">[</span><span class="n">ipix</span><span class="p">]</span>
        <span class="n">nll_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nll_vals</span><span class="p">[</span><span class="n">ipix</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">CastroData</span><span class="p">(</span><span class="n">norm_d</span><span class="p">,</span> <span class="n">nll_d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refSpec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="TSCube.castroData_from_pix_xy"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.TSCube.castroData_from_pix_xy">[docs]</a>    <span class="k">def</span> <span class="nf">castroData_from_pix_xy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xy</span><span class="p">,</span> <span class="n">colwise</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Build a CastroData object for a particular pixel &quot;&quot;&quot;</span>
        <span class="n">ipix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tsmap</span><span class="o">.</span><span class="n">xy_pix_to_ipix</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">colwise</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">castroData_from_ipix</span><span class="p">(</span><span class="n">ipix</span><span class="p">)</span></div>

<div class="viewcode-block" id="TSCube.find_and_refine_peaks"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.TSCube.find_and_refine_peaks">[docs]</a>    <span class="k">def</span> <span class="nf">find_and_refine_peaks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">min_separation</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                              <span class="n">use_cumul</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run a simple peak-finding algorithm, and fit the peaks to</span>
<span class="sd">        paraboloids to extract their positions and error ellipses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        threshold : float</span>
<span class="sd">            Peak threshold in TS.</span>

<span class="sd">        min_separation : float</span>
<span class="sd">            Radius of region size in degrees.  Sets the minimum allowable</span>
<span class="sd">            separation between peaks.</span>

<span class="sd">        use_cumul : bool</span>
<span class="sd">            If true, used the cumulative TS map (i.e., the TS summed</span>
<span class="sd">            over the energy bins) instead of the TS Map from the fit</span>
<span class="sd">            to and index=2 powerlaw.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        peaks    : list</span>
<span class="sd">            List of dictionaries containing the location and amplitude of</span>
<span class="sd">            each peak.  Output of `~fermipy.sourcefind.find_peaks`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">use_cumul</span><span class="p">:</span>
            <span class="n">theMap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ts_cumul</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">theMap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tsmap</span>

        <span class="n">peaks</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">theMap</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">min_separation</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">fit_error_ellipse</span><span class="p">(</span><span class="n">theMap</span><span class="p">,</span> <span class="p">(</span><span class="n">peak</span><span class="p">[</span><span class="s1">&#39;ix&#39;</span><span class="p">],</span> <span class="n">peak</span><span class="p">[</span><span class="s1">&#39;iy&#39;</span><span class="p">]),</span>
                                  <span class="n">dpix</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">peak</span><span class="p">[</span><span class="s1">&#39;fit_loc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span>
            <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;fit_success&#39;</span><span class="p">]:</span>
                <span class="n">peak</span><span class="p">[</span><span class="s1">&#39;fit_skydir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;skydir&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">peak</span><span class="p">[</span><span class="s1">&#39;fit_skydir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak</span><span class="p">[</span><span class="s1">&#39;skydir&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">peaks</span></div>

<div class="viewcode-block" id="TSCube.test_spectra_of_peak"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.TSCube.test_spectra_of_peak">[docs]</a>    <span class="k">def</span> <span class="nf">test_spectra_of_peak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">spec_types</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test different spectral types against the SED represented by the</span>
<span class="sd">        CastroData corresponding to a single pixel in this TSCube</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        spec_types  : [str,...]</span>
<span class="sd">           List of spectral types to try</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        castro : `~fermipy.castro.CastroData`</span>
<span class="sd">           The castro data object for the pixel corresponding to the peak</span>

<span class="sd">        test_dict : dict</span>
<span class="sd">           The dictionary returned by `~fermipy.castro.CastroData.test_spectra`</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">spec_types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PowerLaw&quot;</span><span class="p">,</span> <span class="s2">&quot;LogParabola&quot;</span><span class="p">,</span> <span class="s2">&quot;PLExpCutoff&quot;</span><span class="p">]</span>

        <span class="n">castro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">castroData_from_pix_xy</span><span class="p">(</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">peak</span><span class="p">[</span><span class="s1">&#39;ix&#39;</span><span class="p">],</span> <span class="n">peak</span><span class="p">[</span><span class="s1">&#39;iy&#39;</span><span class="p">]),</span> <span class="n">colwise</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">test_dict</span> <span class="o">=</span> <span class="n">castro</span><span class="o">.</span><span class="n">test_spectra</span><span class="p">(</span><span class="n">spec_types</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">castro</span><span class="p">,</span> <span class="n">test_dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="TSCube.find_sources"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.TSCube.find_sources">[docs]</a>    <span class="k">def</span> <span class="nf">find_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span>
                     <span class="n">min_separation</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                     <span class="n">use_cumul</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">output_peaks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">output_castro</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">output_specInfo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">output_src_dicts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">output_srcs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">srcs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">src_dicts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">castros</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">specInfo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_and_refine_peaks</span><span class="p">(</span>
            <span class="n">threshold</span><span class="p">,</span> <span class="n">min_separation</span><span class="p">,</span> <span class="n">use_cumul</span><span class="o">=</span><span class="n">use_cumul</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">:</span>
            <span class="p">(</span><span class="n">castro</span><span class="p">,</span> <span class="n">test_dict</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_spectra_of_peak</span><span class="p">(</span><span class="n">peak</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;PowerLaw&quot;</span><span class="p">])</span>
            <span class="n">src_name</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">create_source_name</span><span class="p">(</span><span class="n">peak</span><span class="p">[</span><span class="s1">&#39;fit_skydir&#39;</span><span class="p">])</span>
            <span class="n">src_dict</span> <span class="o">=</span> <span class="n">build_source_dict</span><span class="p">(</span><span class="n">src_name</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">test_dict</span><span class="p">,</span> <span class="s2">&quot;PowerLaw&quot;</span><span class="p">)</span>
            <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">src_dict</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">output_castro</span><span class="p">:</span>
                <span class="n">castros</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">castro</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">output_specInfo</span><span class="p">:</span>
                <span class="n">specInfo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_dict</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">output_src_dicts</span><span class="p">:</span>
                <span class="n">src_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">src_dict</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">output_srcs</span><span class="p">:</span>
                <span class="n">src</span> <span class="o">=</span> <span class="n">roi_model</span><span class="o">.</span><span class="n">Source</span><span class="o">.</span><span class="n">create_from_dict</span><span class="p">(</span><span class="n">src_dict</span><span class="p">)</span>
                <span class="n">srcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

        <span class="n">retDict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Names&quot;</span><span class="p">:</span> <span class="n">names</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">output_peaks</span><span class="p">:</span>
            <span class="n">retDict</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peaks</span>
        <span class="k">if</span> <span class="n">output_castro</span><span class="p">:</span>
            <span class="n">retDict</span><span class="p">[</span><span class="s2">&quot;Castro&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">castros</span>
        <span class="k">if</span> <span class="n">output_specInfo</span><span class="p">:</span>
            <span class="n">retDict</span><span class="p">[</span><span class="s2">&quot;Spectral&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">specInfo</span>
        <span class="k">if</span> <span class="n">output_src_dicts</span><span class="p">:</span>
            <span class="n">retDict</span><span class="p">[</span><span class="s2">&quot;SrcDicts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src_dicts</span>
        <span class="k">if</span> <span class="n">output_srcs</span><span class="p">:</span>
            <span class="n">retDict</span><span class="p">[</span><span class="s2">&quot;Sources&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">srcs</span>
        <span class="k">return</span> <span class="n">retDict</span></div></div>


<div class="viewcode-block" id="build_source_dict"><a class="viewcode-back" href="../../fermipy.html#fermipy.castro.build_source_dict">[docs]</a><span class="k">def</span> <span class="nf">build_source_dict</span><span class="p">(</span><span class="n">src_name</span><span class="p">,</span> <span class="n">peak_dict</span><span class="p">,</span> <span class="n">spec_dict</span><span class="p">,</span> <span class="n">spec_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spec_results</span> <span class="o">=</span> <span class="n">spec_dict</span><span class="p">[</span><span class="n">spec_type</span><span class="p">]</span>
    <span class="n">src_dir</span> <span class="o">=</span> <span class="n">peak_dict</span><span class="p">[</span><span class="s1">&#39;fit_skydir&#39;</span><span class="p">]</span>

    <span class="n">src_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">src_name</span><span class="p">,</span>
                    <span class="n">Source_Name</span><span class="o">=</span><span class="n">src_name</span><span class="p">,</span>
                    <span class="n">SpatialModel</span><span class="o">=</span><span class="s1">&#39;PointSource&#39;</span><span class="p">,</span>
                    <span class="n">SpectrumType</span><span class="o">=</span><span class="n">spec_type</span><span class="p">,</span>
                    <span class="n">ts</span><span class="o">=</span><span class="n">spec_results</span><span class="p">[</span><span class="s2">&quot;TS&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">ra</span><span class="o">=</span><span class="n">src_dir</span><span class="o">.</span><span class="n">icrs</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                    <span class="n">dec</span><span class="o">=</span><span class="n">src_dir</span><span class="o">.</span><span class="n">icrs</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                    <span class="n">Prefactor</span><span class="o">=</span><span class="n">spec_results</span><span class="p">[</span><span class="s2">&quot;Result&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">Index</span><span class="o">=-</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">spec_results</span><span class="p">[</span><span class="s2">&quot;Result&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">Scale</span><span class="o">=</span><span class="n">spec_results</span><span class="p">[</span><span class="s2">&quot;ScaleEnergy&quot;</span><span class="p">])</span>

    <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;pos_sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_dict</span><span class="p">[</span><span class="s1">&#39;fit_loc&#39;</span><span class="p">][</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span>
    <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;pos_sigma_semimajor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_dict</span><span class="p">[</span><span class="s1">&#39;fit_loc&#39;</span><span class="p">][</span><span class="s1">&#39;sigma_semimajor&#39;</span><span class="p">]</span>
    <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;pos_sigma_semiminor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_dict</span><span class="p">[</span><span class="s1">&#39;fit_loc&#39;</span><span class="p">][</span><span class="s1">&#39;sigma_semiminor&#39;</span><span class="p">]</span>
    <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;pos_r68&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_dict</span><span class="p">[</span><span class="s1">&#39;fit_loc&#39;</span><span class="p">][</span><span class="s1">&#39;r68&#39;</span><span class="p">]</span>
    <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;pos_r95&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_dict</span><span class="p">[</span><span class="s1">&#39;fit_loc&#39;</span><span class="p">][</span><span class="s1">&#39;r95&#39;</span><span class="p">]</span>
    <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;pos_r99&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_dict</span><span class="p">[</span><span class="s1">&#39;fit_loc&#39;</span><span class="p">][</span><span class="s1">&#39;r99&#39;</span><span class="p">]</span>
    <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;pos_angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">peak_dict</span><span class="p">[</span><span class="s1">&#39;fit_loc&#39;</span><span class="p">][</span><span class="s1">&#39;theta&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">src_dict</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="kn">from</span> <span class="nn">fermipy</span> <span class="k">import</span> <span class="n">roi_model</span>
    <span class="kn">import</span> <span class="nn">fermipy.utils</span> <span class="k">as</span> <span class="nn">utils</span>
    <span class="kn">import</span> <span class="nn">sys</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">flux_type</span> <span class="o">=</span> <span class="s2">&quot;flux&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flux_type</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># castro_sed = CastroData.create_from_sedfile(&quot;sed.fits&quot;)</span>
    <span class="n">castro_sed</span> <span class="o">=</span> <span class="n">CastroData</span><span class="o">.</span><span class="n">create_from_fits</span><span class="p">(</span><span class="s2">&quot;castro.fits&quot;</span><span class="p">,</span> <span class="n">irow</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">test_dict_sed</span> <span class="o">=</span> <span class="n">castro_sed</span><span class="o">.</span><span class="n">test_spectra</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">test_dict_sed</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Fermipy Developers

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>