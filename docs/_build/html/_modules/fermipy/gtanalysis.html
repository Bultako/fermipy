

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>fermipy.gtanalysis &mdash; Fermipy 0.18.0+17.gdd46b.dirty documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Fermipy
          

          
          </a>

          
            
            
              <div class="version">
                0.18.0+17.gdd46b.dirty
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../output.html">Output File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fitting.html">ROI Optimization and Fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model.html">Customizing the Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer.html">Developer Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced/index.html">Advanced Analysis Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../validation/index.html">Validation Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fermipy.html">fermipy package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fermipy_jobs.html">fermipy.jobs subpackage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fermipy_diffuse.html">fermipy.diffuse subpackage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Fermipy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../fermipy.html">fermipy</a> &raquo;</li>
        
      <li>fermipy.gtanalysis</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for fermipy.gtanalysis</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">filecmp</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="k">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">vstack</span>
<span class="kn">from</span> <span class="nn">gammapy.maps</span> <span class="k">import</span> <span class="n">Map</span><span class="p">,</span> <span class="n">HpxGeom</span><span class="p">,</span> <span class="n">WcsGeom</span><span class="p">,</span> <span class="n">MapAxis</span><span class="p">,</span> <span class="n">WcsNDMap</span><span class="p">,</span> <span class="n">HpxNDMap</span>
<span class="kn">import</span> <span class="nn">fermipy</span>
<span class="kn">import</span> <span class="nn">fermipy.defaults</span> <span class="k">as</span> <span class="nn">defaults</span>
<span class="kn">import</span> <span class="nn">fermipy.utils</span> <span class="k">as</span> <span class="nn">utils</span>
<span class="kn">import</span> <span class="nn">fermipy.wcs_utils</span> <span class="k">as</span> <span class="nn">wcs_utils</span>
<span class="kn">import</span> <span class="nn">fermipy.fits_utils</span> <span class="k">as</span> <span class="nn">fits_utils</span>
<span class="kn">import</span> <span class="nn">fermipy.gtutils</span> <span class="k">as</span> <span class="nn">gtutils</span>
<span class="kn">import</span> <span class="nn">fermipy.srcmap_utils</span> <span class="k">as</span> <span class="nn">srcmap_utils</span>
<span class="kn">import</span> <span class="nn">fermipy.skymap</span> <span class="k">as</span> <span class="nn">skymap</span>
<span class="kn">import</span> <span class="nn">fermipy.plotting</span> <span class="k">as</span> <span class="nn">plotting</span>
<span class="kn">import</span> <span class="nn">fermipy.irfs</span> <span class="k">as</span> <span class="nn">irfs</span>
<span class="kn">import</span> <span class="nn">fermipy.sed</span> <span class="k">as</span> <span class="nn">sed</span>
<span class="kn">import</span> <span class="nn">fermipy.lightcurve</span> <span class="k">as</span> <span class="nn">lightcurve</span>
<span class="kn">from</span> <span class="nn">fermipy.residmap</span> <span class="k">import</span> <span class="n">ResidMapGenerator</span>
<span class="kn">from</span> <span class="nn">fermipy.tsmap</span> <span class="k">import</span> <span class="n">TSMapGenerator</span><span class="p">,</span> <span class="n">TSCubeGenerator</span>
<span class="kn">from</span> <span class="nn">fermipy.sourcefind</span> <span class="k">import</span> <span class="n">SourceFind</span>
<span class="kn">from</span> <span class="nn">fermipy.extension</span> <span class="k">import</span> <span class="n">ExtensionFit</span>
<span class="kn">from</span> <span class="nn">fermipy.utils</span> <span class="k">import</span> <span class="n">merge_dict</span>
<span class="kn">from</span> <span class="nn">fermipy.utils</span> <span class="k">import</span> <span class="n">create_hpx_disk_region_string</span>
<span class="kn">from</span> <span class="nn">fermipy.utils</span> <span class="k">import</span> <span class="n">resolve_file_path</span>
<span class="kn">from</span> <span class="nn">fermipy.roi_model</span> <span class="k">import</span> <span class="n">ROIModel</span>
<span class="kn">from</span> <span class="nn">fermipy.ltcube</span> <span class="k">import</span> <span class="n">LTCube</span>
<span class="kn">from</span> <span class="nn">fermipy.plotting</span> <span class="k">import</span> <span class="n">AnalysisPlotter</span>
<span class="kn">from</span> <span class="nn">fermipy.logger</span> <span class="k">import</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">log_level</span>
<span class="kn">from</span> <span class="nn">fermipy.config</span> <span class="k">import</span> <span class="n">ConfigSchema</span>
<span class="kn">from</span> <span class="nn">fermipy.timing</span> <span class="k">import</span> <span class="n">Timer</span>
<span class="kn">from</span> <span class="nn">fermipy.docstring_utils</span> <span class="k">import</span> <span class="n">DocstringMeta</span>
<span class="kn">from</span> <span class="nn">fermipy.fitcache</span> <span class="k">import</span> <span class="n">FitCache</span>
<span class="kn">from</span> <span class="nn">fermipy.data_struct</span> <span class="k">import</span> <span class="n">MutableNamedTuple</span>
<span class="c1"># pylikelihood</span>
<span class="kn">import</span> <span class="nn">GtApp</span>
<span class="kn">import</span> <span class="nn">FluxDensity</span>
<span class="kn">from</span> <span class="nn">LikelihoodState</span> <span class="k">import</span> <span class="n">LikelihoodState</span>
<span class="kn">from</span> <span class="nn">fermipy.gtutils</span> <span class="k">import</span> <span class="n">BinnedAnalysis</span><span class="p">,</span> <span class="n">SummedLikelihood</span>
<span class="kn">import</span> <span class="nn">BinnedAnalysis</span> <span class="k">as</span> <span class="nn">ba</span>
<span class="kn">import</span> <span class="nn">pyLikelihood</span> <span class="k">as</span> <span class="nn">pyLike</span>

<span class="n">norm_parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;ConstantValue&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">],</span>
    <span class="s1">&#39;PowerLaw&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Prefactor&#39;</span><span class="p">],</span>
    <span class="s1">&#39;PowerLaw2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Integral&#39;</span><span class="p">],</span>
    <span class="s1">&#39;BrokenPowerLaw&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Prefactor&#39;</span><span class="p">],</span>
    <span class="s1">&#39;SmoothBrokenPowerLaw&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Prefactor&#39;</span><span class="p">],</span>
    <span class="s1">&#39;LogParabola&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">],</span>
    <span class="s1">&#39;PLSuperExpCutoff&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Prefactor&#39;</span><span class="p">],</span>
    <span class="s1">&#39;PLSuperExpCutoff2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Prefactor&#39;</span><span class="p">],</span>
    <span class="s1">&#39;ExpCutoff&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Prefactor&#39;</span><span class="p">],</span>
    <span class="s1">&#39;FileFunction&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Normalization&#39;</span><span class="p">],</span>
    <span class="s1">&#39;DMFitFunction&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;sigmav&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Gaussian&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Prefactor&#39;</span><span class="p">],</span>
    <span class="s1">&#39;PiecewisePowerLaw&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;dNdE0&#39;</span><span class="p">],</span>
<span class="p">}</span>

<span class="n">shape_parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;ConstantValue&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;PowerLaw&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Index&#39;</span><span class="p">],</span>
    <span class="s1">&#39;PowerLaw2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Index&#39;</span><span class="p">],</span>
    <span class="s1">&#39;BrokenPowerLaw&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Index1&#39;</span><span class="p">,</span> <span class="s1">&#39;Index2&#39;</span><span class="p">],</span>
    <span class="s1">&#39;SmoothBrokenPowerLaw&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Index1&#39;</span><span class="p">,</span> <span class="s1">&#39;Index2&#39;</span><span class="p">],</span>
    <span class="s1">&#39;LogParabola&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">],</span>
    <span class="s1">&#39;PLSuperExpCutoff&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Index1&#39;</span><span class="p">,</span> <span class="s1">&#39;Cutoff&#39;</span><span class="p">],</span>
    <span class="s1">&#39;PLSuperExpCutoff2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Index1&#39;</span><span class="p">,</span> <span class="s1">&#39;Expfactor&#39;</span><span class="p">],</span>
    <span class="s1">&#39;ExpCutoff&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Index1&#39;</span><span class="p">,</span> <span class="s1">&#39;Cutoff&#39;</span><span class="p">],</span>
    <span class="s1">&#39;FileFunction&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;DMFitFunction&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Gaussian&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Mean&#39;</span><span class="p">,</span> <span class="s1">&#39;Sigma&#39;</span><span class="p">],</span>
<span class="p">}</span>

<span class="n">index_parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;ConstantValue&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;PowerLaw&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Index&#39;</span><span class="p">],</span>
    <span class="s1">&#39;PowerLaw2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Index&#39;</span><span class="p">],</span>
    <span class="s1">&#39;BrokenPowerLaw&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Index1&#39;</span><span class="p">,</span> <span class="s1">&#39;Index2&#39;</span><span class="p">],</span>
    <span class="s1">&#39;SmoothBrokenPowerLaw&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Index1&#39;</span><span class="p">,</span> <span class="s1">&#39;Index2&#39;</span><span class="p">],</span>
    <span class="s1">&#39;LogParabola&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">],</span>
    <span class="s1">&#39;PLSuperExpCutoff&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Index1&#39;</span><span class="p">,</span> <span class="s1">&#39;Index2&#39;</span><span class="p">],</span>
    <span class="s1">&#39;PLSuperExpCutoff2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Index1&#39;</span><span class="p">,</span> <span class="s1">&#39;Index2&#39;</span><span class="p">],</span>
    <span class="s1">&#39;ExpCutoff&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Index1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;FileFunction&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;DMFitFunction&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;Gaussian&#39;</span><span class="p">:</span> <span class="p">[],</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">set_edisp_kwargs</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
    <span class="n">gtapp</span> <span class="o">=</span> <span class="n">GtApp</span><span class="o">.</span><span class="n">GtApp</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;edisp_bins&#39;</span> <span class="ow">in</span> <span class="n">gtapp</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;edisp&#39;</span><span class="p">]:</span>
            <span class="n">edisp_bins</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;edisp_bins&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edisp_bins</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;edisp_bins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edisp_bins</span>
    <span class="k">elif</span> <span class="s1">&#39;edisp&#39;</span> <span class="ow">in</span> <span class="n">gtapp</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;edisp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;edisp&#39;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">make_scaled_srcmap</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="n">srcmap0</span><span class="p">,</span>
                       <span class="n">bexp_file0</span><span class="p">,</span> <span class="n">bexproi_file0</span><span class="p">,</span>
                       <span class="n">bexp_file1</span><span class="p">,</span> <span class="n">bexproi_file1</span><span class="p">,</span>
                       <span class="n">ccubefile1</span><span class="p">,</span>
                       <span class="n">outfile</span><span class="p">):</span>

    <span class="n">bexp0</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">bexp_file0</span><span class="p">)</span>
    <span class="n">bexp1</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">bexp_file1</span><span class="p">)</span>
    <span class="n">bexproi0</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">bexproi_file0</span><span class="p">)</span>
    <span class="n">bexproi1</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">bexproi_file1</span><span class="p">)</span>
    <span class="n">bexp_ratio</span> <span class="o">=</span> <span class="n">WcsNDMap</span><span class="p">(</span><span class="n">bexp0</span><span class="o">.</span><span class="n">geom</span><span class="p">,</span>
                          <span class="n">bexp1</span><span class="o">.</span><span class="n">data</span> <span class="o">/</span> <span class="n">bexp0</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">bexproi_ratio</span> <span class="o">=</span> <span class="n">WcsNDMap</span><span class="p">(</span><span class="n">bexproi0</span><span class="o">.</span><span class="n">geom</span><span class="p">,</span>
                             <span class="n">bexproi1</span><span class="o">.</span><span class="n">data</span> <span class="o">/</span> <span class="n">bexproi0</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">srcmap0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">roi</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">diffuse</span><span class="p">:</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">bexproi_ratio</span><span class="o">.</span><span class="n">data</span>
            <span class="n">hdulist</span><span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">ratio</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">skydir</span><span class="p">,</span>
                     <span class="n">bexp_ratio</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">center</span><span class="p">)</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">bexp_ratio</span><span class="o">.</span><span class="n">interp_by_coord</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
            <span class="n">hdulist</span><span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">ratio</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="n">hdulist_ccube</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ccubefile1</span><span class="p">)</span>
    <span class="n">hdulist</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdulist_ccube</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span>
    <span class="n">hdulist</span><span class="p">[</span><span class="s1">&#39;EBOUNDS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdulist_ccube</span><span class="p">[</span><span class="s1">&#39;EBOUNDS&#39;</span><span class="p">]</span>
    <span class="n">hdulist</span><span class="p">[</span><span class="s1">&#39;GTI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdulist_ccube</span><span class="p">[</span><span class="s1">&#39;GTI&#39;</span><span class="p">]</span>
    <span class="n">hdulist</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">hdulist_ccube</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">hdulist</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">create_sc_table</span><span class="p">(</span><span class="n">scfile</span><span class="p">,</span> <span class="n">colnames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load an FT2 file from a file or list of files.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_fits_file</span><span class="p">(</span><span class="n">scfile</span><span class="p">)</span> <span class="ow">and</span> <span class="n">colnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">create_table_from_fits</span><span class="p">(</span><span class="n">scfile</span><span class="p">,</span> <span class="s1">&#39;SC_DATA&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_fits_file</span><span class="p">(</span><span class="n">scfile</span><span class="p">):</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">scfile</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">scfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)]</span>

    <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span><span class="n">create_table_from_fits</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;SC_DATA&#39;</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">vstack</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_table_from_fits</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">,</span> <span class="n">hduname</span><span class="p">,</span> <span class="n">colnames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Memory efficient function for loading a table from a FITS</span>
<span class="sd">    file.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">colnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">,</span> <span class="n">hduname</span><span class="p">)</span>

    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">h</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="n">hduname</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">cols</span> <span class="o">+=</span> <span class="p">[</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">Table</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_spectral_index</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">egy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the local spectral index of a source.&quot;&quot;&quot;</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="mf">1E-5</span>
    <span class="n">f0</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()(</span><span class="n">pyLike</span><span class="o">.</span><span class="n">dArg</span><span class="p">(</span><span class="n">egy</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">delta</span><span class="p">)))</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()(</span><span class="n">pyLike</span><span class="o">.</span><span class="n">dArg</span><span class="p">(</span><span class="n">egy</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">f0</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">f1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">f0</span> <span class="o">/</span> <span class="n">f1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">delta</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">delta</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">return</span> <span class="n">gamma</span>


<span class="k">def</span> <span class="nf">run_gtapp</span><span class="p">(</span><span class="n">appname</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="n">loglevel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;loglevel&#39;</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;Running </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">appname</span><span class="p">)</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">filter_dict</span><span class="p">(</span><span class="n">kw</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kw</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">unicode_to_str</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>
    <span class="n">gtapp</span> <span class="o">=</span> <span class="n">GtApp</span><span class="o">.</span><span class="n">GtApp</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">appname</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">appname</span> <span class="o">==</span> <span class="s1">&#39;gtbin&#39;</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;scfile&#39;</span> <span class="ow">and</span>
            <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_fits_file</span><span class="p">(</span><span class="n">v</span><span class="p">)):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="n">v</span>
        <span class="n">gtapp</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="n">gtapp</span><span class="o">.</span><span class="n">command</span><span class="p">())</span>
    <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">gtapp</span><span class="o">.</span><span class="n">runWithOutput</span><span class="p">(</span><span class="n">print_command</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

        <span class="c1"># Capture return code?</span>

    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;Finished </span><span class="si">%s</span><span class="s1">. Execution time: </span><span class="si">%.2f</span><span class="s1"> s&#39;</span><span class="p">,</span>
               <span class="n">appname</span><span class="p">,</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">filter_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">val</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>


<div class="viewcode-block" id="GTAnalysis"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis">[docs]</a><span class="k">class</span> <span class="nc">GTAnalysis</span><span class="p">(</span><span class="n">fermipy</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Configurable</span><span class="p">,</span> <span class="n">sed</span><span class="o">.</span><span class="n">SEDGenerator</span><span class="p">,</span>
                 <span class="n">ResidMapGenerator</span><span class="p">,</span> <span class="n">TSMapGenerator</span><span class="p">,</span> <span class="n">TSCubeGenerator</span><span class="p">,</span>
                 <span class="n">SourceFind</span><span class="p">,</span> <span class="n">ExtensionFit</span><span class="p">,</span> <span class="n">lightcurve</span><span class="o">.</span><span class="n">LightCurve</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;High-level analysis interface that manages a set of analysis</span>
<span class="sd">    component objects.  Most of the functionality of the Fermipy</span>
<span class="sd">    package is provided through the methods of this class.  The class</span>
<span class="sd">    constructor accepts a dictionary that defines the configuration</span>
<span class="sd">    for the analysis.  Keyword arguments to the constructor can be</span>
<span class="sd">    used to override parameters in the configuration dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">DocstringMeta</span>

    <span class="n">_docstring_registry</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;extension&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">extension</span><span class="p">,</span>
        <span class="s1">&#39;sed&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">sed</span><span class="p">,</span>
        <span class="s1">&#39;localize&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">localize</span><span class="p">,</span>
        <span class="s1">&#39;tsmap&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">tsmap</span><span class="p">,</span>
        <span class="s1">&#39;residmap&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">residmap</span><span class="p">,</span>
        <span class="s1">&#39;lightcurve&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">lightcurve</span><span class="p">,</span>
        <span class="s1">&#39;find_sources&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">sourcefind</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;logging&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">logging</span><span class="p">,</span>
                <span class="s1">&#39;fileio&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">fileio</span><span class="p">,</span>
                <span class="s1">&#39;optimizer&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span>
                <span class="s1">&#39;binning&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">binning</span><span class="p">,</span>
                <span class="s1">&#39;selection&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span>
                <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="s1">&#39;ltcube&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">ltcube</span><span class="p">,</span>
                <span class="s1">&#39;gtlike&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">gtlike</span><span class="p">,</span>
                <span class="s1">&#39;mc&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">mc</span><span class="p">,</span>
                <span class="s1">&#39;residmap&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">residmap</span><span class="p">,</span>
                <span class="s1">&#39;tsmap&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">tsmap</span><span class="p">,</span>
                <span class="s1">&#39;tscube&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">tscube</span><span class="p">,</span>
                <span class="s1">&#39;sourcefind&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">sourcefind</span><span class="p">,</span>
                <span class="s1">&#39;sed&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">sed</span><span class="p">,</span>
                <span class="s1">&#39;lightcurve&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">lightcurve</span><span class="p">,</span>
                <span class="s1">&#39;extension&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">extension</span><span class="p">,</span>
                <span class="s1">&#39;localize&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">localize</span><span class="p">,</span>
                <span class="s1">&#39;roiopt&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">roiopt</span><span class="p">,</span>
                <span class="s1">&#39;plotting&#39;</span><span class="p">:</span> <span class="n">defaults</span><span class="o">.</span><span class="n">plotting</span><span class="p">,</span>
                <span class="s1">&#39;components&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Setup directories</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rootdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outdir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">validate</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loglevel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;loglevel&#39;</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">GTAnalysis</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">,</span>
                                         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_projtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;projtype&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;tmin&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;tmax&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lck_params</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Set random seed</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">][</span><span class="s1">&#39;seed&#39;</span><span class="p">])</span>

        <span class="c1"># Destination directory for output data products</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;outdir&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rootdir</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;outdir&#39;</span><span class="p">])</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_outdir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Save directory not defined.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;logfile&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;logfile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span>
                                                            <span class="s1">&#39;fermipy.log&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;logging&#39;</span><span class="p">][</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger_name</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;logfile&#39;</span><span class="p">],</span>
                         <span class="n">log_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;logging&#39;</span><span class="p">][</span><span class="s1">&#39;verbosity&#39;</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                        <span class="s2">&quot;fermipy version </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span>
                        <span class="nb">format</span><span class="p">(</span><span class="n">fermipy</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;ScienceTools version </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fermipy</span><span class="o">.</span><span class="n">get_st_version</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

        <span class="c1"># Working directory (can be the same as savedir)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;usescratch&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;workdir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span>
                <span class="n">prefix</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;USER&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
                <span class="nb">dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;scratchdir&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Created working directory: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;workdir&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;workdir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outdir</span>

        <span class="k">if</span> <span class="s1">&#39;FERMIPY_WORKDIR&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;FERMIPY_WORKDIR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;workdir&#39;</span><span class="p">]</span>

        <span class="c1"># put pfiles into savedir</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PFILES&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PFILES&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Create Plotter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plotter</span> <span class="o">=</span> <span class="n">AnalysisPlotter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;plotting&#39;</span><span class="p">],</span>
                                        <span class="n">fileio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">],</span>
                                        <span class="n">logging</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;logging&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_like</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_components</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">configs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_component_configs</span><span class="p">()</span>

        <span class="c1"># Setup the ROI definition</span>
        <span class="k">if</span> <span class="n">roi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_roi</span> <span class="o">=</span> <span class="n">ROIModel</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">configs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;selection&#39;</span><span class="p">],</span>
                                        <span class="n">configs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
                                        <span class="n">fileio</span><span class="o">=</span><span class="n">configs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;fileio&#39;</span><span class="p">],</span>
                                        <span class="n">coordsys</span><span class="o">=</span><span class="n">configs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;coordsys&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_roi</span> <span class="o">=</span> <span class="n">roi</span>

        <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">configs</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_component</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loglevel</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="s1">&#39;ccube&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s1">&#39;ccube.fits&#39;</span><span class="p">)</span>

        <span class="n">ebin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">roiwidths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">binsz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">ebin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ebin_edges</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">log_energies</span><span class="p">))</span>
            <span class="n">roiwidths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">roiwidths</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">roiwidth</span><span class="p">)</span>
            <span class="n">binsz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">binsz</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">binsz</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ebin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ebin_edges</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">5</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enumbins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ebin_edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loge_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_ebin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_ebin_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_roi_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;loglike&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s1">&#39;npred&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s1">&#39;npred_wt&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enumbins</span><span class="p">),</span>
            <span class="s1">&#39;counts_wt&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enumbins</span><span class="p">),</span>
            <span class="s1">&#39;model_counts&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enumbins</span><span class="p">),</span>
            <span class="s1">&#39;model_counts_wt&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enumbins</span><span class="p">),</span>
            <span class="s1">&#39;energies&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">),</span>
            <span class="s1">&#39;log_energies&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">),</span>
            <span class="s1">&#39;loge_bounds&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loge_bounds</span><span class="p">),</span>
            <span class="s1">&#39;components&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">:</span>
            <span class="n">comp_model</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;loglike&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                           <span class="s1">&#39;npred&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                           <span class="s1">&#39;npred_wt&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                           <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">enumbins</span><span class="p">),</span>
                           <span class="s1">&#39;counts_wt&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">enumbins</span><span class="p">),</span>
                           <span class="s1">&#39;model_counts&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">enumbins</span><span class="p">),</span>
                           <span class="s1">&#39;model_counts_wt&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">enumbins</span><span class="p">),</span>
                           <span class="s1">&#39;energies&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">energies</span><span class="p">),</span>
                           <span class="s1">&#39;log_energies&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">log_energies</span><span class="p">),</span>
                           <span class="s1">&#39;src_expscale&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">src_expscale</span><span class="p">),</span>
                           <span class="p">}]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_roi_data</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">comp_model</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_roiwidth</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">roiwidths</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_binsz</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">binsz</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_npix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_roiwidth</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binsz</span><span class="p">))</span>

        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">MapAxis</span><span class="o">.</span><span class="n">from_edges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span>
                                   <span class="n">name</span><span class="o">=</span><span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;MeV&#39;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projtype</span> <span class="o">==</span> <span class="s1">&#39;HPX&#39;</span><span class="p">:</span>
            <span class="n">is_nested</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;hpx_ordering_scheme&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;NESTED&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_geom</span> <span class="o">=</span> <span class="n">HpxGeom</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;hpx_order&#39;</span><span class="p">],</span>
                                        <span class="n">nest</span><span class="o">=</span><span class="n">is_nested</span><span class="p">,</span>
                                        <span class="n">coordsys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;coordsys&#39;</span><span class="p">],</span>
                                        <span class="n">width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;roiwidth&#39;</span><span class="p">],</span>
                                        <span class="n">skydir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">skydir</span><span class="p">,</span>
                                        <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_geom</span> <span class="o">=</span> <span class="n">WcsGeom</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">npix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">npix</span><span class="p">,</span> <span class="n">binsz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_binsz</span><span class="p">,</span>
                                        <span class="n">coordsys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;coordsys&#39;</span><span class="p">],</span>
                                        <span class="n">proj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;proj&#39;</span><span class="p">],</span>
                                        <span class="n">skydir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">skydir</span><span class="p">,</span>
                                        <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
            
            <span class="c1"># Update projection of ROI object</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_roi</span><span class="o">.</span><span class="n">set_geom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;usescratch&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stage_input</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage_output</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the default loglevel.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger_name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">loglevel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the default loglevel.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loglevel</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">workdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the analysis working directory.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;workdir&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">outdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the analysis output directory.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outdir</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">roi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the ROI object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roi</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">plotter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the plotter instance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plotter</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">like</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the global likelihood object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_like</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the list of analysis components.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">energies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the energy bin edges in MeV.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">10</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_ebin_edges</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_energies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the energy bin edges in log10(E/MeV).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ebin_edges</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">enumbins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of energy bins.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enumbins</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">npix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of energy bins.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_npix</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">loge_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Current analysis energy bounds in log10(E/MeV).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loge_bounds</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">projtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the type of projection to use&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_projtype</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">geom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ROI geometry.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geom</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tmin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the MET time for the start of the observation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmin</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tmax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the MET time for the end of the observation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmax</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span>

<div class="viewcode-block" id="GTAnalysis.create"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.create">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">infile</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new instance of GTAnalysis from an analysis output file</span>
<span class="sd">        generated with `~fermipy.GTAnalysis.write_roi`.  By default</span>
<span class="sd">        the new instance will inherit the configuration of the saved</span>
<span class="sd">        analysis instance.  The configuration may be overriden by</span>
<span class="sd">        passing a configuration file path with the ``config``</span>
<span class="sd">        argument.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        infile : str</span>
<span class="sd">            Path to the ROI results file.</span>

<span class="sd">        config : str</span>
<span class="sd">            Path to a configuration file.  This will override the</span>
<span class="sd">            configuration in the ROI results file.</span>

<span class="sd">        params : str</span>
<span class="sd">            Path to a yaml file with updated parameter values</span>
<span class="sd">        </span>
<span class="sd">        mask : str</span>
<span class="sd">            Path to a fits file with an updated mask</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">infile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
        <span class="n">roi_file</span><span class="p">,</span> <span class="n">roi_data</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">roi_data</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>
            <span class="n">validate</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">validate</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">gta</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">)</span>
        <span class="n">gta</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">init_sources</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">gta</span><span class="o">.</span><span class="n">load_roi</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gta</span></div>

<div class="viewcode-block" id="GTAnalysis.clone"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.clone">[docs]</a>    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a clone of this analysis instance.&quot;&quot;&quot;</span>
        <span class="n">gta</span> <span class="o">=</span> <span class="n">GTAnalysis</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">gta</span><span class="o">.</span><span class="n">_roi</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gta</span></div>

<div class="viewcode-block" id="GTAnalysis.set_random_seed"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.set_random_seed">[docs]</a>    <span class="k">def</span> <span class="nf">set_random_seed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the seed for the random number generator&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">][</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.set_log_level"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.set_log_level">[docs]</a>    <span class="k">def</span> <span class="nf">set_log_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_update_roi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roi_data</span>

        <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;loglike&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">()</span>

        <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;model_counts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;model_counts_wt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;model_counts_wt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;model_counts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;npred&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;npred_wt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">):</span>
            <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;loglike&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">c</span><span class="o">.</span><span class="n">like</span><span class="p">()</span>
            <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;model_counts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;model_counts_wt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;model_counts_wt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;model_counts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;npred&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;npred_wt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">sourceNames</span><span class="p">():</span>

            <span class="c1"># EAC, this is one of the only things we need from setup()</span>
            <span class="c1"># self.update_source(name)</span>

            <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;model_counts&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;model_counts&#39;</span><span class="p">]</span>
            <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;npred&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;model_counts&#39;</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;model_counts_wt&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;model_counts_wt&#39;</span><span class="p">]</span>
                <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;npred_wt&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;model_counts_wt&#39;</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;model_counts_wt&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;model_counts&#39;</span><span class="p">]</span>
                <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;npred&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;model_counts&#39;</span><span class="p">])</span>

            <span class="n">mc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_counts_spectrum</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">mc_wt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_counts_spectrum</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">weighted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">):</span>
                <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;model_counts&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">mc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;model_counts_wt&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">mc_wt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;npred&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;npred_wt&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mc_wt</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_update_srcmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">_update_srcmap</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fitcache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fitcache</span><span class="o">.</span><span class="n">update_source</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_srcmap_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">src</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">_create_srcmap_cache</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clear_srcmap_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">_srcmap_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<div class="viewcode-block" id="GTAnalysis.reload_source"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.reload_source">[docs]</a>    <span class="k">def</span> <span class="nf">reload_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">init_source</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete and reload a source in the model.  This will update</span>
<span class="sd">        the spatial model of this source to the one defined in the XML</span>
<span class="sd">        model.&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">reload_source</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">init_source</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_source</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span></div>

<div class="viewcode-block" id="GTAnalysis.reload_sources"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.reload_sources">[docs]</a>    <span class="k">def</span> <span class="nf">reload_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">init_source</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">reload_sources</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">init_source</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_init_source</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span></div>

<div class="viewcode-block" id="GTAnalysis.set_source_morphology"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.set_source_morphology">[docs]</a>    <span class="k">def</span> <span class="nf">set_source_morphology</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the spatial model of a source.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">           Source name.</span>

<span class="sd">        spatial_model : str</span>
<span class="sd">           Spatial model name (PointSource, RadialGaussian, etc.).</span>

<span class="sd">        spatial_pars : dict</span>
<span class="sd">           Dictionary of spatial parameters (optional).</span>

<span class="sd">        use_cache : bool        </span>
<span class="sd">           Generate the spatial model by interpolating the cached source</span>
<span class="sd">           map.</span>

<span class="sd">        use_pylike : bool</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="n">spatial_model</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;spatial_model&#39;</span><span class="p">,</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpatialModel&#39;</span><span class="p">])</span>
        <span class="n">spatial_pars</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;spatial_pars&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">use_pylike</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_pylike&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">psf_scale_fn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;psf_scale_fn&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">update_source</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;update_source&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pyLike</span><span class="o">.</span><span class="n">BinnedLikelihood</span><span class="p">,</span> <span class="s1">&#39;setSourceMapImage&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">use_pylike</span><span class="p">:</span>
            <span class="n">src</span><span class="o">.</span><span class="n">set_spatial_model</span><span class="p">(</span><span class="n">spatial_model</span><span class="p">,</span> <span class="n">spatial_pars</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_srcmap</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">psf_scale_fn</span><span class="o">=</span><span class="n">psf_scale_fn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_source</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                                     <span class="n">save_template</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">src</span><span class="o">.</span><span class="n">set_spatial_model</span><span class="p">(</span><span class="n">spatial_model</span><span class="p">,</span> <span class="n">spatial_pars</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_source</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">init_source</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">use_pylike</span><span class="o">=</span><span class="n">use_pylike</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">update_source</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_source</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.set_source_spectrum"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.set_source_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">set_source_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">spectrum_type</span><span class="o">=</span><span class="s1">&#39;PowerLaw&#39;</span><span class="p">,</span>
                            <span class="n">spectrum_pars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_source</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the spectral model of a source.  This function can be</span>
<span class="sd">        used to change the spectral type of a source or modify its</span>
<span class="sd">        spectral parameters.  If called with</span>
<span class="sd">        spectrum_type=&#39;FileFunction&#39; and spectrum_pars=None, the</span>
<span class="sd">        source spectrum will be replaced with a FileFunction with the</span>
<span class="sd">        same differential flux distribution as the original spectrum.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        name : str</span>
<span class="sd">           Source name.</span>

<span class="sd">        spectrum_type : str</span>
<span class="sd">           Spectrum type (PowerLaw, etc.).</span>

<span class="sd">        spectrum_pars : dict</span>
<span class="sd">           Dictionary of spectral parameters (optional).</span>

<span class="sd">        update_source : bool</span>
<span class="sd">           Recompute all source characteristics (flux, TS, NPred)</span>
<span class="sd">           using the new spectral model of the source.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="n">spectrum_pars</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">spectrum_pars</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">spectrum_pars</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;SpectrumType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PowerLaw&#39;</span> <span class="ow">and</span>
                <span class="n">spectrum_type</span> <span class="o">==</span> <span class="s1">&#39;LogParabola&#39;</span><span class="p">):</span>
            <span class="n">spectrum_pars</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                                              <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">})</span>
            <span class="n">spectrum_pars</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;Eb&#39;</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">spectral_pars</span><span class="p">[</span><span class="s1">&#39;Scale&#39;</span><span class="p">])</span>
            <span class="n">spectrum_pars</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;norm&#39;</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">spectral_pars</span><span class="p">[</span><span class="s1">&#39;Prefactor&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;alpha&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">spectrum_pars</span><span class="p">:</span>
                <span class="n">spectrum_pars</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">spectral_pars</span><span class="p">[</span><span class="s1">&#39;Index&#39;</span><span class="p">]</span>
                <span class="n">spectrum_pars</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.0</span>
                <span class="k">if</span> <span class="n">spectrum_pars</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">][</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">:</span>
                    <span class="n">spectrum_pars</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.0</span>
                    <span class="n">spectrum_pars</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">][</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.0</span>

        <span class="k">if</span> <span class="n">spectrum_type</span> <span class="o">==</span> <span class="s1">&#39;FileFunction&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_filefunction</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">spectrum_pars</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">gtutils</span><span class="o">.</span><span class="n">create_spectrum_from_dict</span><span class="p">(</span><span class="n">spectrum_type</span><span class="p">,</span>
                                                   <span class="n">spectrum_pars</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">setSpectrum</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">fn</span><span class="p">)</span>

        <span class="c1"># Get parameters</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">getSource</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="n">pars_dict</span> <span class="o">=</span> <span class="n">gtutils</span><span class="o">.</span><span class="n">get_function_pars_dict</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">spectrum</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;SpectrumType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">set_spectral_pars</span><span class="p">(</span><span class="n">pars_dict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;SpectrumType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum_type</span>
            <span class="n">c</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">set_spectral_pars</span><span class="p">(</span><span class="n">pars_dict</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">update_source</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_source</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.set_source_dnde"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.set_source_dnde">[docs]</a>    <span class="k">def</span> <span class="nf">set_source_dnde</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dnde</span><span class="p">,</span> <span class="n">update_source</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the differential flux distribution of a source with the</span>
<span class="sd">        FileFunction spectral type.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">           Source name.</span>

<span class="sd">        dnde : `~numpy.ndarray`</span>
<span class="sd">           Array of differential flux values (cm^{-2} s^{-1} MeV^{-1}).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;SpectrumType&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;FileFunction&#39;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Wrong spectral type: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;SpectrumType&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">xy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source_dnde</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dnde</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Wrong length for dnde array: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">dnde</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">getSource</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span>
            <span class="n">file_function</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">FileFunction_cast</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
            <span class="n">file_function</span><span class="o">.</span><span class="n">setSpectrum</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dnde</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">update_source</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_source</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.get_source_dnde"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.get_source_dnde">[docs]</a>    <span class="k">def</span> <span class="nf">get_source_dnde</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return differential flux distribution of a source.  For</span>
<span class="sd">        sources with FileFunction spectral type this returns the</span>
<span class="sd">        internal differential flux array.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        loge : `~numpy.ndarray`</span>
<span class="sd">           Array of energies at which the differential flux is</span>
<span class="sd">           evaluated (log10(E/MeV)).</span>

<span class="sd">        dnde : `~numpy.ndarray`</span>
<span class="sd">           Array of differential flux values (cm^{-2} s^{-1} MeV^{-1})</span>
<span class="sd">           evaluated at energies in ``loge``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;SpectrumType&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;FileFunction&#39;</span><span class="p">:</span>

            <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">getSource</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span>
            <span class="n">file_function</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">FileFunction_cast</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
            <span class="n">loge</span> <span class="o">=</span> <span class="n">file_function</span><span class="o">.</span><span class="n">log_energy</span><span class="p">()</span>
            <span class="n">logdnde</span> <span class="o">=</span> <span class="n">file_function</span><span class="o">.</span><span class="n">log_dnde</span><span class="p">()</span>

            <span class="n">loge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">loge</span><span class="p">))</span>
            <span class="n">dnde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logdnde</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">loge</span><span class="p">,</span> <span class="n">dnde</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ebinsz</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">enumbins</span>
            <span class="n">loge</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">extend_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">,</span> <span class="n">ebinsz</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">)</span>

            <span class="n">dnde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()(</span><span class="n">pyLike</span><span class="o">.</span><span class="n">dArg</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">egy</span><span class="p">))</span>
                             <span class="k">for</span> <span class="n">egy</span> <span class="ow">in</span> <span class="n">loge</span><span class="p">])</span>

            <span class="k">return</span> <span class="n">loge</span><span class="p">,</span> <span class="n">dnde</span></div>

    <span class="k">def</span> <span class="nf">_create_filefunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">spectrum_pars</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace the spectrum of an existing source with a</span>
<span class="sd">        FileFunction.&quot;&quot;&quot;</span>

        <span class="n">spectrum_pars</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">spectrum_pars</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">spectrum_pars</span>

        <span class="k">if</span> <span class="s1">&#39;loge&#39;</span> <span class="ow">in</span> <span class="n">spectrum_pars</span><span class="p">:</span>
            <span class="n">loge</span> <span class="o">=</span> <span class="n">spectrum_pars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;loge&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ebinsz</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">enumbins</span>
            <span class="n">loge</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">extend_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">,</span> <span class="n">ebinsz</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">)</span>

        <span class="c1"># Get the values</span>
        <span class="n">dnde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loge</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;dnde&#39;</span> <span class="ow">in</span> <span class="n">spectrum_pars</span><span class="p">:</span>
            <span class="n">dnde</span> <span class="o">=</span> <span class="n">spectrum_pars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dnde&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dnde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()(</span><span class="n">pyLike</span><span class="o">.</span><span class="n">dArg</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">egy</span><span class="p">))</span>
                             <span class="k">for</span> <span class="n">egy</span> <span class="ow">in</span> <span class="n">loge</span><span class="p">])</span>

        <span class="n">filename</span> <span class="o">=</span> \
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span>
                         <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_filespectrum.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)))</span>

        <span class="c1"># Create file spectrum txt file</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="mi">10</span><span class="o">**</span><span class="n">loge</span><span class="p">,</span> <span class="n">dnde</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">setSpectrum</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;FileFunction&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;Spectrum_Filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="c1"># Update</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">getSource</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span>

            <span class="n">spectrum</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;Normalization&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="mf">1E-3</span><span class="p">,</span> <span class="mf">1E3</span><span class="p">)</span>

            <span class="n">file_function</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">FileFunction_cast</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
            <span class="n">file_function</span><span class="o">.</span><span class="n">readFunction</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
            <span class="n">c</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;Spectrum_Filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>

    <span class="k">def</span> <span class="nf">_create_component_configs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">configs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">]</span>

        <span class="n">common_config</span> <span class="o">=</span> <span class="n">GTBinnedAnalysis</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
        <span class="n">common_config</span> <span class="o">=</span> <span class="n">merge_dict</span><span class="p">(</span><span class="n">common_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                                   <span class="n">add_new_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">components</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">common_config</span><span class="p">)</span>
            <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;file_suffix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;_00&#39;</span>
            <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;00&#39;</span>
            <span class="n">configs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">components</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">components</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
                <span class="n">cfg</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">common_config</span><span class="p">)</span>
                <span class="n">cfg</span> <span class="o">=</span> <span class="n">merge_dict</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">components</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">add_new_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;file_suffix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">k</span>
                <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
                <span class="n">configs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">components</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">components</span><span class="p">):</span>
                <span class="n">cfg</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">common_config</span><span class="p">)</span>
                <span class="n">cfg</span> <span class="o">=</span> <span class="n">merge_dict</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">add_new_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;file_suffix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;_</span><span class="si">%02i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span>
                <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%02i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span>
                <span class="n">configs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid type for component block.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">configs</span>

    <span class="k">def</span> <span class="nf">_create_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating Analysis Component: &quot;</span> <span class="o">+</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>

        <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;workdir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;workdir&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">GTBinnedAnalysis</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span>
                <span class="n">cfg</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="n">comp</span> <span class="o">=</span> <span class="n">GTBinnedAnalysis</span><span class="p">(</span>
            <span class="n">cfg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">,</span> <span class="n">logging</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;logging&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">comp</span>

<div class="viewcode-block" id="GTAnalysis.stage_output"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.stage_output">[docs]</a>    <span class="k">def</span> <span class="nf">stage_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy data products to final output directory.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Working directory does not exist.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">regex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;outdir_regex&#39;</span><span class="p">]</span>
        <span class="n">savefits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;savefits&#39;</span><span class="p">]</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Staging files to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>

        <span class="n">fitsfiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>

                <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">fitsfiles</span> <span class="o">+=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>

            <span class="n">wpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">opath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">match_regex_list</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">opath</span><span class="p">)</span> <span class="ow">and</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">wpath</span><span class="p">,</span> <span class="n">opath</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">savefits</span> <span class="ow">and</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fitsfiles</span><span class="p">:</span>
                <span class="k">continue</span>


            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Copying &#39;</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Copying &#39;</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">wpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Finished.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.stage_input"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.stage_input">[docs]</a>    <span class="k">def</span> <span class="nf">stage_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy input files to working directory.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Working directory does not exist.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Staging files to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>

        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">)]</span>

        <span class="n">regex</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;workdir_regex&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">match_regex_list</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)):</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Copying &#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>

                <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">wpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="n">opath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">wpath</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">opath</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Copying &#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">opath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Finished.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.setup"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_sources</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run pre-processing for each analysis component and</span>
<span class="sd">        construct a joint likelihood object.  This function performs</span>
<span class="sd">        the following tasks: data selection (gtselect, gtmktime),</span>
<span class="sd">        data binning (gtbin), and model generation (gtexpcube2,gtsrcmaps).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        init_sources : bool</span>

<span class="sd">           Choose whether to compute properties (flux, TS, etc.) for</span>
<span class="sd">           individual sources.</span>

<span class="sd">        overwrite : bool</span>

<span class="sd">           Run all pre-processing steps even if the output file of</span>
<span class="sd">           that step is present in the working directory.  By default</span>
<span class="sd">           this function will skip any steps for which the output file</span>
<span class="sd">           already exists.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">loglevel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;loglevel&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglevel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;Running setup.&#39;</span><span class="p">)</span>

        <span class="c1"># Make spatial maps for extended sources</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">diffuse</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">extended</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_template</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="c1"># Run setup for each component</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">):</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>

        <span class="c1"># Create likelihood</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_likelihood</span><span class="p">()</span>

        <span class="c1"># Determine tmin, tmax</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">tmin</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmin</span> <span class="ow">is</span> <span class="kc">None</span>
                          <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmin</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">tmin</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">tmax</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmax</span> <span class="ow">is</span> <span class="kc">None</span>
                          <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmax</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">tmax</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">init_sources</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;Initializing source properties&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">sourceNames</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Initializing source </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_init_source</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_roi</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;Finished setup.&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_create_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">srcmdl</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Instantiate the likelihood object for each component and</span>
<span class="sd">        create a SummedLikelihood.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_like</span> <span class="o">=</span> <span class="n">SummedLikelihood</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">_create_binned_analysis</span><span class="p">(</span><span class="n">srcmdl</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_like</span><span class="o">.</span><span class="n">addComponent</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">like</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fitcache</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_roi_model</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_init_roi_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roi_data</span>

        <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;counts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enumbins</span><span class="p">)</span>
        <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;counts_wt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enumbins</span><span class="p">)</span>
        <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;loglike&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">()</span>

        <span class="n">cmaps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">wmaps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">proj_type</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">crd</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">,</span> <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">]):</span>
            <span class="n">cm</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">counts_map</span><span class="p">()</span>
            <span class="n">wm</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">weight_map</span><span class="p">()</span>
            <span class="n">cmaps</span> <span class="o">+=</span> <span class="p">[</span><span class="n">cm</span><span class="p">]</span>
            <span class="n">wmaps</span> <span class="o">+=</span> <span class="p">[</span><span class="n">wm</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">WcsNDMap</span><span class="p">):</span>
                <span class="n">crd</span><span class="p">[</span><span class="s1">&#39;counts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">crd</span><span class="p">[</span><span class="s1">&#39;counts_wt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">wm</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                          <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">HpxNDMap</span><span class="p">):</span>
                <span class="n">proj_type</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">crd</span><span class="p">[</span><span class="s1">&#39;counts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
                <span class="n">crd</span><span class="p">[</span><span class="s1">&#39;counts_wt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">wm</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="n">crd</span><span class="p">[</span><span class="s1">&#39;loglike&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">c</span><span class="o">.</span><span class="n">like</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">proj_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enumbins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npix</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">proj_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enumbins</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">npix</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coadd_maps</span><span class="p">(</span><span class="n">cmaps</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">wmaps</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>

        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">src</span><span class="o">.</span><span class="n">update_data</span><span class="p">({</span><span class="s1">&#39;sed&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_src_model</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">paramsonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">src</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">src</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">src</span>

<div class="viewcode-block" id="GTAnalysis.cleanup"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_workdir</span><span class="p">()</span></div>

<div class="viewcode-block" id="GTAnalysis.delete_workdir"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.delete_workdir">[docs]</a>    <span class="k">def</span> <span class="nf">delete_workdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleting working directory: &#39;</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.generate_model"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.generate_model">[docs]</a>    <span class="k">def</span> <span class="nf">generate_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate model maps for all components.  model_name should</span>
<span class="sd">        be a unique identifier for the model.  If model_name is None</span>
<span class="sd">        then the model maps will be generated using the current</span>
<span class="sd">        parameters of the ROI.&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">):</span>
            <span class="n">c</span><span class="o">.</span><span class="n">generate_model</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">)</span></div>

            <span class="c1"># If all model maps have the same spatial/energy binning we</span>
            <span class="c1"># could generate a co-added model map here</span>

<div class="viewcode-block" id="GTAnalysis.set_energy_range"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.set_energy_range">[docs]</a>    <span class="k">def</span> <span class="nf">set_energy_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logemin</span><span class="p">,</span> <span class="n">logemax</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the energy bounds of the analysis.  This restricts the</span>
<span class="sd">        evaluation of the likelihood to the data that falls in this</span>
<span class="sd">        range.  Input values will be rounded to the closest bin edge</span>
<span class="sd">        value.  If either argument is None then the lower or upper</span>
<span class="sd">        bound of the analysis instance will be used.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        logemin : float</span>
<span class="sd">           Lower energy bound in log10(E/MeV).</span>

<span class="sd">        logemax : float</span>
<span class="sd">           Upper energy bound in log10(E/MeV).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        eminmax : array</span>
<span class="sd">           Minimum and maximum energy in log10(E/MeV).</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">logemin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logemin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">imin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">val_to_edge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">,</span> <span class="n">logemin</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">logemin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">[</span><span class="n">imin</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">logemax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logemax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">imax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">val_to_edge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">,</span> <span class="n">logemax</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">logemax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">[</span><span class="n">imax</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_loge_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">logemin</span><span class="p">,</span> <span class="n">logemax</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_roi_data</span><span class="p">[</span><span class="s1">&#39;loge_bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loge_bounds</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">set_energy_range</span><span class="p">(</span><span class="n">logemin</span><span class="p">,</span> <span class="n">logemax</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loge_bounds</span></div>

<div class="viewcode-block" id="GTAnalysis.counts_map"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.counts_map">[docs]</a>    <span class="k">def</span> <span class="nf">counts_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a `~fermipy.skymap.Map` representation of the counts map.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        map : `~fermipy.skymap.Map`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ccube</span></div>

<div class="viewcode-block" id="GTAnalysis.weight_map"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.weight_map">[docs]</a>    <span class="k">def</span> <span class="nf">weight_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a `~fermipy.skymap.Map` representation of the weights map.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        map : `~fermipy.skymap.Map`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wcube</span></div>

<div class="viewcode-block" id="GTAnalysis.model_counts_map"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.model_counts_map">[docs]</a>    <span class="k">def</span> <span class="nf">model_counts_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the model counts map for a single source, a list of</span>
<span class="sd">        sources, or for the sum of all sources in the ROI.  The</span>
<span class="sd">        exclude parameter can be used to exclude one or more</span>
<span class="sd">        components when generating the model map.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str or list of str</span>

<span class="sd">           Parameter controlling the set of sources for which the</span>
<span class="sd">           model counts map will be calculated.  If name=None the</span>
<span class="sd">           model map will be generated for all sources in the ROI.</span>

<span class="sd">        exclude : str or list of str</span>

<span class="sd">           List of sources that will be excluded when calculating the</span>
<span class="sd">           model map.</span>

<span class="sd">        use_mask : bool</span>

<span class="sd">           Parameter that specifies in the model counts map should include</span>
<span class="sd">           mask pixels (i.e., ones whose weights are &lt;= 0)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        map : `~gammapy.maps.Map`</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="n">maps</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">model_counts_map</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">exclude</span><span class="p">,</span> <span class="n">use_mask</span><span class="o">=</span><span class="n">use_mask</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">skymap</span><span class="o">.</span><span class="n">coadd_maps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">maps</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.model_counts_spectrum"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.model_counts_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">model_counts_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">logemin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logemax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">summed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">weighted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the predicted number of model counts versus energy</span>
<span class="sd">        for a given source and energy range.  If summed=True return</span>
<span class="sd">        the counts spectrum summed over all components otherwise</span>
<span class="sd">        return a list of model spectra.   If weighted=True return </span>
<span class="sd">        the weighted version of the counts spectrum</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">logemin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logemin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">logemax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logemax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">summed</span><span class="p">:</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enumbins</span><span class="p">)</span>
            <span class="n">imin</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">val_to_bin_bounded</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">,</span>
                                            <span class="n">logemin</span> <span class="o">+</span> <span class="mf">1E-7</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">imax</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">val_to_bin_bounded</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">,</span>
                                            <span class="n">logemax</span> <span class="o">-</span> <span class="mf">1E-7</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="n">ecenter</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">log_energies</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">log_energies</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="n">counts</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">model_counts_spectrum</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">weighted</span><span class="p">)</span>
                <span class="n">cs</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">ecenter</span><span class="p">,</span>
                                   <span class="n">weights</span><span class="o">=</span><span class="n">counts</span><span class="p">,</span>
                                   <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">cs</span><span class="p">[</span><span class="n">imin</span><span class="p">:</span><span class="n">imax</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="n">cs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">model_counts_spectrum</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">logemin</span><span class="p">,</span>
                                               <span class="n">logemax</span><span class="p">,</span> <span class="n">weighted</span><span class="o">=</span><span class="n">weighted</span><span class="p">)]</span>
            <span class="k">return</span> <span class="n">cs</span></div>

<div class="viewcode-block" id="GTAnalysis.get_sources"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.get_sources">[docs]</a>    <span class="k">def</span> <span class="nf">get_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cuts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skydir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">minmax_ts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">minmax_npred</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">square</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve list of sources in the ROI satisfying the given</span>
<span class="sd">        selections.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        srcs : list</span>
<span class="sd">            A list of `~fermipy.roi_model.Model` objects.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">coordsys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;coordsys&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_sources</span><span class="p">(</span><span class="n">skydir</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">cuts</span><span class="p">,</span>
                                    <span class="n">minmax_ts</span><span class="p">,</span> <span class="n">minmax_npred</span><span class="p">,</span>
                                    <span class="n">exclude</span><span class="p">,</span> <span class="n">square</span><span class="p">,</span>
                                    <span class="n">coordsys</span><span class="o">=</span><span class="n">coordsys</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.add_source"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.add_source">[docs]</a>    <span class="k">def</span> <span class="nf">add_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">src_dict</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init_source</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">save_source_maps</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_pylike</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">use_single_psf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a source to the ROI model.  This function may be called</span>
<span class="sd">        either before or after `~fermipy.gtanalysis.GTAnalysis.setup`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Source name.</span>

<span class="sd">        src_dict : dict or `~fermipy.roi_model.Source` object</span>
<span class="sd">            Dictionary or source object defining the source properties</span>
<span class="sd">            (coordinates, spectral parameters, etc.).</span>

<span class="sd">        free : bool</span>
<span class="sd">            Initialize the source with a free normalization parameter.</span>

<span class="sd">        use_pylike : bool</span>
<span class="sd">            Create source maps with pyLikelihood.</span>

<span class="sd">        use_single_psf : bool </span>
<span class="sd">            Use the PSF model calculated for the ROI center.  If false</span>
<span class="sd">            then a new model will be generated using the position of</span>
<span class="sd">            the source.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">has_source</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Source </span><span class="si">%s</span><span class="s1"> already exists.&#39;</span> <span class="o">%</span> <span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">loglevel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;loglevel&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglevel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;Adding source &#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>

        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">create_source</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">src_dict</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_template</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">add_source</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">src_dict</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="n">free</span><span class="p">,</span>
                         <span class="n">save_source_maps</span><span class="o">=</span><span class="n">save_source_maps</span><span class="p">,</span>
                         <span class="n">use_pylike</span><span class="o">=</span><span class="n">use_pylike</span><span class="p">,</span>
                         <span class="n">use_single_psf</span><span class="o">=</span><span class="n">use_single_psf</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_like</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">use_edisp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;edisp&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;edisp_bins&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">use_edisp</span> <span class="ow">and</span> <span class="n">src</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;edisp_disable&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_edisp_flag</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">syncSrcParams</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span>
        <span class="c1"># if free is not None:</span>
        <span class="c1">#    self.free_norm(name, free, loglevel=logging.DEBUG)</span>

        <span class="k">if</span> <span class="n">init_source</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_source</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_roi</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fitcache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fitcache</span><span class="o">.</span><span class="n">update_source</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.add_sources_from_roi"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.add_sources_from_roi">[docs]</a>    <span class="k">def</span> <span class="nf">add_sources_from_roi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add multiple sources to the current ROI model copied from another ROI model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        names : list</span>
<span class="sd">            List of str source names to add.</span>

<span class="sd">        roi : `~fermipy.roi_model.ROIModel` object</span>
<span class="sd">            The roi model from which to add sources.</span>

<span class="sd">        free : bool</span>
<span class="sd">            Initialize the source with a free normalization paramter.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_source</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">roi</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="n">free</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.delete_source"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.delete_source">[docs]</a>    <span class="k">def</span> <span class="nf">delete_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">save_template</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">delete_source_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">build_fixed_wts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete a source from the ROI model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Source name.</span>

<span class="sd">        save_template : bool</span>
<span class="sd">            Keep the SpatialMap FITS template associated with this</span>
<span class="sd">            source.</span>

<span class="sd">        delete_source_map : bool</span>
<span class="sd">            Delete the source map associated with this source from the</span>
<span class="sd">            source maps file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        src : `~fermipy.roi_model.Model`</span>
<span class="sd">            The deleted source object.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">has_source</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No source with name: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">loglevel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;loglevel&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglevel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;Deleting source </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># STs require a source to be freed before deletion</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">free_norm</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">delete_source</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">save_template</span><span class="o">=</span><span class="n">save_template</span><span class="p">,</span>
                            <span class="n">delete_source_map</span><span class="o">=</span><span class="n">delete_source_map</span><span class="p">,</span>
                            <span class="n">build_fixed_wts</span><span class="o">=</span><span class="n">build_fixed_wts</span><span class="p">)</span>

        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">delete_sources</span><span class="p">([</span><span class="n">src</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_roi</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">src</span></div>

<div class="viewcode-block" id="GTAnalysis.delete_sources"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.delete_sources">[docs]</a>    <span class="k">def</span> <span class="nf">delete_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cuts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">skydir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">minmax_ts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">minmax_npred</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete sources in the ROI model satisfying the given</span>
<span class="sd">        selection criteria.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cuts : dict</span>
<span class="sd">            Dictionary of [min,max] selections on source properties.</span>

<span class="sd">        distance : float</span>
<span class="sd">            Cut on angular distance from ``skydir``.  If None then no</span>
<span class="sd">            selection will be applied.</span>

<span class="sd">        skydir : `~astropy.coordinates.SkyCoord`</span>
<span class="sd">            Reference sky coordinate for ``distance`` selection.  If</span>
<span class="sd">            None then the distance selection will be applied with</span>
<span class="sd">            respect to the ROI center.</span>

<span class="sd">        minmax_ts : list</span>
<span class="sd">            Select sources that have TS in the range [min,max].  If</span>
<span class="sd">            either min or max are None then only a lower (upper) bound</span>
<span class="sd">            will be applied.  If this parameter is none no selection</span>
<span class="sd">            will be applied.</span>

<span class="sd">        minmax_npred : list</span>
<span class="sd">            Select sources that have npred in the range [min,max].  If</span>
<span class="sd">            either min or max are None then only a lower (upper) bound</span>
<span class="sd">            will be applied.  If this parameter is none no selection</span>
<span class="sd">            will be applied.</span>

<span class="sd">        square : bool</span>
<span class="sd">            Switch between applying a circular or square (ROI-like)</span>
<span class="sd">            selection on the maximum projected distance from the ROI</span>
<span class="sd">            center.</span>

<span class="sd">        names : list            </span>
<span class="sd">            Select sources matching a name in this list.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        srcs : list</span>
<span class="sd">            A list of `~fermipy.roi_model.Model` objects.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">srcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_sources</span><span class="p">(</span><span class="n">skydir</span><span class="o">=</span><span class="n">skydir</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span> <span class="n">cuts</span><span class="o">=</span><span class="n">cuts</span><span class="p">,</span>
                                    <span class="n">minmax_ts</span><span class="o">=</span><span class="n">minmax_ts</span><span class="p">,</span> <span class="n">minmax_npred</span><span class="o">=</span><span class="n">minmax_npred</span><span class="p">,</span>
                                    <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="n">square</span><span class="p">,</span>
                                    <span class="n">coordsys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span>
                                        <span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;coordsys&#39;</span><span class="p">],</span>
                                    <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">srcs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_source</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">build_fixed_wts</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Build fixed model weights in one pass</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">buildFixedModelWts</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_update_roi</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">srcs</span></div>

<div class="viewcode-block" id="GTAnalysis.set_weights_map"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.set_weights_map">[docs]</a>    <span class="k">def</span> <span class="nf">set_weights_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wmap</span><span class="p">,</span> <span class="n">update_roi</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;GTAnalysis.set_weights_map must be run after GTAnalysis.setup&quot;</span><span class="p">)</span>

        <span class="n">likes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">,</span> <span class="n">gtutils</span><span class="o">.</span><span class="n">SummedLikelihood</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="n">likes</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">logLike</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">likes</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="p">]</span>
        <span class="n">projmaps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wmap</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">wmap</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">projmap</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">projmap</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">WcsMapLibrary</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">wcsmap</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">projmaps</span> <span class="o">+=</span> <span class="p">[</span><span class="n">projmap</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">projmaps</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">likes</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Length of weights maps list is not equal to number of components </span><span class="si">%i</span><span class="s2"> </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">projmaps</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">likes</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">projmap</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">likes</span><span class="p">,</span> <span class="n">projmaps</span><span class="p">):</span>
                <span class="n">l</span><span class="o">.</span><span class="n">setWeightsMap</span><span class="p">(</span><span class="n">projmap</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">wmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">projmap</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">projmap</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">WcsMapLibrary</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">wcsmap</span><span class="p">(</span><span class="n">wmap</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">likes</span><span class="p">:</span>
                <span class="n">l</span><span class="o">.</span><span class="n">setWeightsMap</span><span class="p">(</span><span class="n">projmap</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">update_roi</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_roi_model</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">sourceNames</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Initializing source </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_source</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_roi</span><span class="p">()</span></div>

<div class="viewcode-block" id="GTAnalysis.make_template"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.make_template">[docs]</a>    <span class="k">def</span> <span class="nf">make_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpatialType&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;SpatialMap&#39;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpatialModel&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;RadialGaussian&#39;</span><span class="p">]:</span>

            <span class="n">template_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_template_gauss_</span><span class="si">%05.3f</span><span class="s1">.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                               <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpatialWidth&#39;</span><span class="p">])</span>
            <span class="n">template_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">template_file</span><span class="p">)</span>

            <span class="n">sigma</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpatialWidth&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1.5095921854516636</span>
            <span class="n">srcmap_utils</span><span class="o">.</span><span class="n">make_gaussian_spatial_map</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">skydir</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span>
                                                   <span class="n">template_file</span><span class="p">)</span>
            <span class="n">src</span><span class="p">[</span><span class="s1">&#39;Spatial_Filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">template_file</span>
        <span class="k">elif</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpatialModel&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;RadialDisk&#39;</span><span class="p">]:</span>

            <span class="n">template_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_template_disk_</span><span class="si">%05.3f</span><span class="s1">.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                              <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpatialWidth&#39;</span><span class="p">])</span>
            <span class="n">template_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">template_file</span><span class="p">)</span>

            <span class="n">radius</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpatialWidth&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">0.8246211251235321</span>
            <span class="n">srcmap_utils</span><span class="o">.</span><span class="n">make_disk_spatial_map</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">skydir</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span>
                                               <span class="n">template_file</span><span class="p">)</span>
            <span class="n">src</span><span class="p">[</span><span class="s1">&#39;Spatial_Filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">template_file</span></div>

<div class="viewcode-block" id="GTAnalysis.free_sources_by_name"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.free_sources_by_name">[docs]</a>    <span class="k">def</span> <span class="nf">free_sources_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Free all sources with names matching ``names``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        names : list</span>
<span class="sd">            List of source names.</span>

<span class="sd">        free : bool</span>
<span class="sd">            Choose whether to free (free=True) or fix (free=False)</span>
<span class="sd">            source parameters.</span>

<span class="sd">        pars : list</span>
<span class="sd">            Set a list of parameters to be freed/fixed for each</span>
<span class="sd">            source.  If none then all source parameters will be</span>
<span class="sd">            freed/fixed.  If pars=&#39;norm&#39; then only normalization</span>
<span class="sd">            parameters will be freed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        srcs : list</span>
<span class="sd">            A list of `~fermipy.roi_model.Model` objects.            </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">names</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">names</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
        <span class="n">srcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">sources</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">srcs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">free_source</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="n">free</span><span class="p">,</span> <span class="n">pars</span><span class="o">=</span><span class="n">pars</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">srcs</span></div>

<div class="viewcode-block" id="GTAnalysis.free_sources"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.free_sources">[docs]</a>    <span class="k">def</span> <span class="nf">free_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cuts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skydir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">minmax_ts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">minmax_npred</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Free or fix sources in the ROI model satisfying the given</span>
<span class="sd">        selection.  When multiple selections are defined, the selected</span>
<span class="sd">        sources will be those satisfying the logical AND of all</span>
<span class="sd">        selections (e.g. distance &lt; X &amp;&amp; minmax_ts[0] &lt; ts &lt;</span>
<span class="sd">        minmax_ts[1] &amp;&amp; ...).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        free : bool</span>
<span class="sd">            Choose whether to free (free=True) or fix (free=False)</span>
<span class="sd">            source parameters.</span>

<span class="sd">        pars : list</span>
<span class="sd">            Set a list of parameters to be freed/fixed for each</span>
<span class="sd">            source.  If none then all source parameters will be</span>
<span class="sd">            freed/fixed.  If pars=&#39;norm&#39; then only normalization</span>
<span class="sd">            parameters will be freed.</span>

<span class="sd">        cuts : dict</span>
<span class="sd">            Dictionary of [min,max] selections on source properties.</span>

<span class="sd">        distance : float</span>
<span class="sd">            Cut on angular distance from ``skydir``.  If None then no</span>
<span class="sd">            selection will be applied.</span>

<span class="sd">        skydir : `~astropy.coordinates.SkyCoord`</span>
<span class="sd">            Reference sky coordinate for ``distance`` selection.  If</span>
<span class="sd">            None then the distance selection will be applied with</span>
<span class="sd">            respect to the ROI center.</span>

<span class="sd">        minmax_ts : list</span>
<span class="sd">            Free sources that have TS in the range [min,max].  If</span>
<span class="sd">            either min or max are None then only a lower (upper) bound</span>
<span class="sd">            will be applied.  If this parameter is none no selection</span>
<span class="sd">            will be applied.</span>

<span class="sd">        minmax_npred : list</span>
<span class="sd">            Free sources that have npred in the range [min,max].  If</span>
<span class="sd">            either min or max are None then only a lower (upper) bound</span>
<span class="sd">            will be applied.  If this parameter is none no selection</span>
<span class="sd">            will be applied.</span>

<span class="sd">        exclude : list</span>
<span class="sd">            Names of sources that will be excluded from the selection.</span>

<span class="sd">        square : bool</span>
<span class="sd">            Switch between applying a circular or square (ROI-like)</span>
<span class="sd">            selection on the maximum projected distance from the ROI</span>
<span class="sd">            center.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        srcs : list</span>
<span class="sd">            A list of `~fermipy.roi_model.Model` objects.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">srcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_sources</span><span class="p">(</span><span class="n">skydir</span><span class="o">=</span><span class="n">skydir</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
                                    <span class="n">cuts</span><span class="o">=</span><span class="n">cuts</span><span class="p">,</span> <span class="n">minmax_ts</span><span class="o">=</span><span class="n">minmax_ts</span><span class="p">,</span>
                                    <span class="n">minmax_npred</span><span class="o">=</span><span class="n">minmax_npred</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span>
                                    <span class="n">square</span><span class="o">=</span><span class="n">square</span><span class="p">,</span>
                                    <span class="n">coordsys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;coordsys&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">srcs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">free_source</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="n">free</span><span class="p">,</span> <span class="n">pars</span><span class="o">=</span><span class="n">pars</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">srcs</span></div>

<div class="viewcode-block" id="GTAnalysis.set_edisp_flag"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.set_edisp_flag">[docs]</a>    <span class="k">def</span> <span class="nf">set_edisp_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Enable or disable the energy dispersion correction for the</span>
<span class="sd">        given source.&quot;&quot;&quot;</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">name</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">set_edisp_flag</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.scale_parameter"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.scale_parameter">[docs]</a>    <span class="k">def</span> <span class="nf">scale_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">par_index</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">setScale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">getScale</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_params</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_set_value_bounded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">getBounds</span><span class="p">())</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="GTAnalysis.set_parameter"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.set_parameter">[docs]</a>    <span class="k">def</span> <span class="nf">set_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">true_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_source</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the value of a parameter.  Parameter bounds will</span>
<span class="sd">        automatically be adjusted to encompass the new parameter</span>
<span class="sd">        value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        name : str</span>
<span class="sd">            Source name.</span>

<span class="sd">        par : str</span>
<span class="sd">            Parameter name.</span>

<span class="sd">        value : float</span>
<span class="sd">            Parameter value.  By default this argument should be the</span>
<span class="sd">            unscaled (True) parameter value.</span>

<span class="sd">        scale : float</span>
<span class="sd">            Parameter scale (optional).  Value argument is interpreted</span>
<span class="sd">            with respect to the scale parameter if it is provided.</span>

<span class="sd">        error : float</span>
<span class="sd">            Parameter error (optional).  By default this argument should be the</span>
<span class="sd">            unscaled (True) parameter value.</span>

<span class="sd">        update_source : bool</span>
<span class="sd">            Update the source dictionary for the object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">par_index</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>
        <span class="n">current_bounds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">getBounds</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">setScale</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">getScale</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">true_value</span><span class="p">:</span>
            <span class="n">current_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">current_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
            <span class="n">current_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">current_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">error</span> <span class="o">/</span> <span class="n">scale</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">current_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">current_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">current_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># update current bounds to encompass new value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="o">*</span><span class="n">current_bounds</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">true_value</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">pars</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">setTrueValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">true_value</span><span class="p">:</span>
                <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
                <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># For some reason the numerical accuracy is causing this to throw exceptions.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="o">*</span><span class="n">bounds</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Caught failure on setBounds for </span><span class="si">%s</span><span class="s2">::</span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">par</span><span class="p">))</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">setError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_params</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">update_source</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_source</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.set_parameter_scale"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.set_parameter_scale">[docs]</a>    <span class="k">def</span> <span class="nf">set_parameter_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the scale of a parameter while keeping its value constant.&quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">par_index</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>
        <span class="n">current_bounds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">getBounds</span><span class="p">())</span>
        <span class="n">current_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">getScale</span><span class="p">()</span>
        <span class="n">current_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">setScale</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">current_value</span> <span class="o">*</span> <span class="n">current_scale</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="n">current_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">current_scale</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span>
                                 <span class="n">current_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">current_scale</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_params</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.set_parameter_bounds"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.set_parameter_bounds">[docs]</a>    <span class="k">def</span> <span class="nf">set_parameter_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">bounds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the bounds on the scaled value of a parameter.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        name : str</span>
<span class="sd">            Source name.</span>

<span class="sd">        par : str</span>
<span class="sd">            Parameter name.</span>

<span class="sd">        bounds : list</span>
<span class="sd">            Upper and lower bound.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">par_index</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="o">*</span><span class="n">bounds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_params</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.set_parameter_error"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.set_parameter_error">[docs]</a>    <span class="k">def</span> <span class="nf">set_parameter_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the error on the value of a parameter.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        name : str</span>
<span class="sd">            Source name.</span>

<span class="sd">        par : str</span>
<span class="sd">            Parameter name.</span>

<span class="sd">        error : float</span>
<span class="sd">            The value for the parameter error</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">par_index</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">setError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_params</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.lock_parameter"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.lock_parameter">[docs]</a>    <span class="k">def</span> <span class="nf">lock_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set parameter to locked/unlocked state.  A locked parameter</span>
<span class="sd">        will be ignored when running methods that free/fix sources or</span>
<span class="sd">        parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Source name.</span>

<span class="sd">        par : str</span>
<span class="sd">            Parameter name.</span>

<span class="sd">        lock : bool       </span>
<span class="sd">            Set parameter to locked (True) or unlocked (False) state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="n">lck_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lck_params</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">if</span> <span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">free_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">lck_params</span><span class="p">:</span>
                <span class="n">lck_params</span> <span class="o">+=</span> <span class="p">[</span><span class="n">par</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">lck_params</span><span class="p">:</span>
                <span class="n">lck_params</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">par</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.free_parameter"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.free_parameter">[docs]</a>    <span class="k">def</span> <span class="nf">free_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Free/Fix a parameter of a source by name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Source name.</span>

<span class="sd">        par : str</span>
<span class="sd">            Parameter name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">par</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lck_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">return</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">par_index</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">setFree</span><span class="p">(</span><span class="n">free</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_params</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.lock_source"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.lock_source">[docs]</a>    <span class="k">def</span> <span class="nf">lock_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set all parameters of a source to a locked/unlocked state.</span>
<span class="sd">        Locked parameters will be ignored when running methods that</span>
<span class="sd">        free/fix sources or parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Source name.</span>

<span class="sd">        lock : bool        </span>
<span class="sd">            Set source parameters to locked (True) or unlocked (False)</span>
<span class="sd">            state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lock</span><span class="p">:</span>
            <span class="n">par_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source_params</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">free_source</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">pars</span><span class="o">=</span><span class="n">par_names</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lck_params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">par_names</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lck_params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="GTAnalysis.free_source"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.free_source">[docs]</a>    <span class="k">def</span> <span class="nf">free_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Free/Fix parameters of a source.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        name : str</span>
<span class="sd">            Source name.</span>

<span class="sd">        free : bool</span>
<span class="sd">            Choose whether to free (free=True) or fix (free=False)</span>
<span class="sd">            source parameters.</span>

<span class="sd">        pars : list</span>
<span class="sd">            Set a list of parameters to be freed/fixed for this source.  If</span>
<span class="sd">            none then all source parameters will be freed/fixed with the</span>
<span class="sd">            exception of those defined in the skip_pars list.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">free_pars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_free_param_vector</span><span class="p">()</span>

        <span class="n">loglevel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;loglevel&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglevel</span><span class="p">)</span>

        <span class="c1"># Find the source</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">name</span>

        <span class="k">if</span> <span class="n">pars</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pars</span><span class="p">):</span>
            <span class="n">pars</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">pars</span> <span class="o">+=</span> <span class="n">norm_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpectrumType&#39;</span><span class="p">],</span> <span class="p">[])</span>
            <span class="n">pars</span> <span class="o">+=</span> <span class="n">shape_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpectrumType&#39;</span><span class="p">],</span> <span class="p">[])</span>
        <span class="k">elif</span> <span class="n">pars</span> <span class="o">==</span> <span class="s1">&#39;norm&#39;</span><span class="p">:</span>
            <span class="n">pars</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">pars</span> <span class="o">+=</span> <span class="n">norm_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpectrumType&#39;</span><span class="p">],</span> <span class="p">[])</span>
        <span class="k">elif</span> <span class="n">pars</span> <span class="o">==</span> <span class="s1">&#39;shape&#39;</span><span class="p">:</span>
            <span class="n">pars</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">pars</span> <span class="o">+=</span> <span class="n">shape_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpectrumType&#39;</span><span class="p">],</span> <span class="p">[])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid parameter list.&#39;</span><span class="p">)</span>

        <span class="c1"># Remove locked parameters</span>
        <span class="n">lck_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lck_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pars</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lck_params</span><span class="p">]</span>

        <span class="c1"># Deduce here the names of all parameters from the spectral type</span>
        <span class="n">src_par_names</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">StringVector</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">getParamNames</span><span class="p">(</span><span class="n">src_par_names</span><span class="p">)</span>

        <span class="n">par_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">par_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">src_par_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pars</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">par_index</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">free</span> <span class="o">==</span> <span class="n">free_pars</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="n">par_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">par_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">par_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">free</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;Freeing parameters for </span><span class="si">%-22s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                            <span class="n">name</span><span class="p">,</span> <span class="n">par_names</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;Fixing parameters for </span><span class="si">%-22s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                            <span class="n">name</span><span class="p">,</span> <span class="n">par_names</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">par_name</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">par_indices</span><span class="p">,</span> <span class="n">par_names</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">setFree</span><span class="p">(</span><span class="n">free</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_params_state</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.set_norm_scale"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.set_norm_scale">[docs]</a>    <span class="k">def</span> <span class="nf">set_norm_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">normPar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">normPar</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">normPar</span><span class="o">.</span><span class="n">setScale</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_params</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.set_norm"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.set_norm">[docs]</a>    <span class="k">def</span> <span class="nf">set_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">update_source</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">normPar</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">true_value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">update_source</span><span class="o">=</span><span class="n">update_source</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.set_norm_bounds"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.set_norm_bounds">[docs]</a>    <span class="k">def</span> <span class="nf">set_norm_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bounds</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">normPar</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameter_bounds</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.free_norm"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.free_norm">[docs]</a>    <span class="k">def</span> <span class="nf">free_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Free/Fix normalization of a source.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        name : str</span>
<span class="sd">            Source name.</span>

<span class="sd">        free : bool</span>
<span class="sd">            Choose whether to free (free=True) or fix (free=False).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">normPar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">normPar</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free_source</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pars</span><span class="o">=</span><span class="p">[</span><span class="n">normPar</span><span class="p">],</span> <span class="n">free</span><span class="o">=</span><span class="n">free</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.free_index"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.free_index">[docs]</a>    <span class="k">def</span> <span class="nf">free_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Free/Fix index of a source.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        name : str</span>
<span class="sd">            Source name.</span>

<span class="sd">        free : bool</span>
<span class="sd">            Choose whether to free (free=True) or fix (free=False).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free_source</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="n">free</span><span class="p">,</span>
                         <span class="n">pars</span><span class="o">=</span><span class="n">index_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpectrumType&#39;</span><span class="p">],</span> <span class="p">[]),</span>
                         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.free_shape"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.free_shape">[docs]</a>    <span class="k">def</span> <span class="nf">free_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Free/Fix shape parameters of a source.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        name : str</span>
<span class="sd">            Source name.</span>

<span class="sd">        free : bool</span>
<span class="sd">            Choose whether to free (free=True) or fix (free=False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free_source</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="n">free</span><span class="p">,</span>
                         <span class="n">pars</span><span class="o">=</span><span class="n">shape_parameters</span><span class="p">[</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpectrumType&#39;</span><span class="p">]],</span>
                         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_sync_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">syncSrcParams</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">getSource</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="n">spectral_pars</span> <span class="o">=</span> <span class="n">gtutils</span><span class="o">.</span><span class="n">get_function_pars_dict</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">spectrum</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">set_spectral_pars</span><span class="p">(</span><span class="n">spectral_pars</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_sync_params_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">syncSrcParams</span><span class="p">()</span>
            <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">sourceNames</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">syncSrcParams</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>

            <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">src</span>
            <span class="n">pars</span> <span class="o">=</span> <span class="n">gtutils</span><span class="o">.</span><span class="n">get_function_pars</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">spectrum</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pars</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">spectral_pars</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]][</span><span class="s1">&#39;free&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="GTAnalysis.get_norm"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.get_norm">[docs]</a>    <span class="k">def</span> <span class="nf">get_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">normPar</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_get_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">par_name</span><span class="p">):</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">par_index</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">par_name</span><span class="p">)</span>
        <span class="n">par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">par</span><span class="o">.</span><span class="n">getValue</span><span class="p">(),</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">par</span><span class="o">.</span><span class="n">error</span><span class="p">(),</span>
                <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="n">par</span><span class="o">.</span><span class="n">getScale</span><span class="p">(),</span>
                <span class="s1">&#39;free&#39;</span><span class="p">:</span> <span class="n">par</span><span class="o">.</span><span class="n">isFree</span><span class="p">(),</span>
                <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>

<div class="viewcode-block" id="GTAnalysis.get_params"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.get_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freeonly</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">srcName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">sourceNames</span><span class="p">():</span>

            <span class="n">par_names</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">StringVector</span><span class="p">()</span>
            <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">getSource</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">srcName</span><span class="p">))</span>
            <span class="n">src</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">getParamNames</span><span class="p">(</span><span class="n">par_names</span><span class="p">)</span>

<span class="c1">#            for parName in self.get_free_source_params(srcName):</span>
            <span class="k">for</span> <span class="n">parName</span> <span class="ow">in</span> <span class="n">par_names</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">par_index</span><span class="p">(</span><span class="n">srcName</span><span class="p">,</span> <span class="n">parName</span><span class="p">)</span>
                <span class="n">par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">freeonly</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">par</span><span class="o">.</span><span class="n">isFree</span><span class="p">():</span>
                    <span class="k">continue</span>

                <span class="n">is_norm</span> <span class="o">=</span> <span class="n">parName</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">normPar</span><span class="p">(</span><span class="n">srcName</span><span class="p">)</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
                <span class="n">params</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;src_name&#39;</span><span class="p">:</span> <span class="n">srcName</span><span class="p">,</span>
                               <span class="s1">&#39;par_name&#39;</span><span class="p">:</span> <span class="n">parName</span><span class="p">,</span>
                               <span class="s1">&#39;is_norm&#39;</span><span class="p">:</span> <span class="n">is_norm</span><span class="p">,</span>
                               <span class="s1">&#39;idx&#39;</span><span class="p">:</span> <span class="n">idx</span><span class="p">}</span>
                <span class="n">params</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_param</span><span class="p">(</span><span class="n">srcName</span><span class="p">,</span> <span class="n">parName</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span></div>

<div class="viewcode-block" id="GTAnalysis.get_free_param_vector"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.get_free_param_vector">[docs]</a>    <span class="k">def</span> <span class="nf">get_free_param_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">free</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">params</span><span class="p">():</span>
            <span class="n">free</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">isFree</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">free</span></div>

<div class="viewcode-block" id="GTAnalysis.set_free_param_vector"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.set_free_param_vector">[docs]</a>    <span class="k">def</span> <span class="nf">set_free_param_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">free</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">free</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">t</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">thaw</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_params_state</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_latch_free_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_free_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_free_param_vector</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_restore_free_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_free_param_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_free_params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_latch_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saved_state</span> <span class="o">=</span> <span class="n">LikelihoodState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_state</span>

    <span class="k">def</span> <span class="nf">_restore_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saved_state</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

<div class="viewcode-block" id="GTAnalysis.get_source_params"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.get_source_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_source_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span>
        <span class="n">parNames</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">StringVector</span><span class="p">()</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">getParamNames</span><span class="p">(</span><span class="n">parNames</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parNames</span><span class="p">]</span></div>

<div class="viewcode-block" id="GTAnalysis.get_free_source_params"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.get_free_source_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_free_source_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span>
        <span class="n">parNames</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">StringVector</span><span class="p">()</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">getFreeParamNames</span><span class="p">(</span><span class="n">parNames</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parNames</span><span class="p">]</span></div>

<div class="viewcode-block" id="GTAnalysis.get_source_name"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.get_source_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_source_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the name of a source as it is defined in the</span>
<span class="sd">        pyLikelihood model object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">sourceNames</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="n">name</span></div>

<div class="viewcode-block" id="GTAnalysis.zero_source"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.zero_source">[docs]</a>    <span class="k">def</span> <span class="nf">zero_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">normPar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">normPar</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">normPar</span><span class="p">,</span> <span class="mf">1E-10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free_source</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.unzero_source"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.unzero_source">[docs]</a>    <span class="k">def</span> <span class="nf">unzero_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">normPar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">normPar</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">normPar</span><span class="p">,</span> <span class="mf">1E10</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.optimize"><a class="viewcode-back" href="../../fitting.html#fermipy.gtanalysis.GTAnalysis.optimize">[docs]</a>    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iteratively optimize the ROI model.  The optimization is</span>
<span class="sd">        performed in three sequential steps:</span>

<span class="sd">        * Free the normalization of the N largest components (as</span>
<span class="sd">          determined from NPred) that contain a fraction ``npred_frac``</span>
<span class="sd">          of the total predicted counts in the model and perform a</span>
<span class="sd">          simultaneous fit of the normalization parameters of these</span>
<span class="sd">          components.</span>

<span class="sd">        * Individually fit the normalizations of all sources that were</span>
<span class="sd">          not included in the first step in order of their npred</span>
<span class="sd">          values.  Skip any sources that have NPred &lt;</span>
<span class="sd">          ``npred_threshold``.</span>

<span class="sd">        * Individually fit the shape and normalization parameters of</span>
<span class="sd">          all sources with TS &gt; ``shape_ts_threshold`` where TS is</span>
<span class="sd">          determined from the first two steps of the ROI optimization.</span>

<span class="sd">        To ensure that the model is fully optimized this method can be</span>
<span class="sd">        run multiple times.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        npred_frac : float</span>
<span class="sd">            Threshold on the fractional number of counts in the N</span>
<span class="sd">            largest components in the ROI.  This parameter determines</span>
<span class="sd">            the set of sources that are fit in the first optimization</span>
<span class="sd">            step.</span>

<span class="sd">        npred_threshold : float</span>
<span class="sd">            Threshold on the minimum number of counts of individual</span>
<span class="sd">            sources.  This parameter determines the sources that are</span>
<span class="sd">            fit in the second optimization step.</span>

<span class="sd">        shape_ts_threshold : float</span>
<span class="sd">            Threshold on source TS used for determining the sources</span>
<span class="sd">            that will be fit in the third optimization step.</span>

<span class="sd">        max_free_sources : int</span>
<span class="sd">            Maximum number of sources that will be fit simultaneously</span>
<span class="sd">            in the first optimization step.</span>

<span class="sd">        skip : list</span>
<span class="sd">            List of str source names to skip while optimizing.</span>

<span class="sd">        optimizer : dict</span>
<span class="sd">            Dictionary that overrides the default optimizer settings.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">loglevel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;loglevel&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglevel</span><span class="p">)</span>
        <span class="n">timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;Starting&#39;</span><span class="p">)</span>

        <span class="n">loglike0</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;LogLike: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">loglike0</span><span class="p">)</span>

        <span class="c1"># Extract options from kwargs</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;roiopt&#39;</span><span class="p">])</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">])</span>
        <span class="n">fermipy</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">validate_config</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">merge_dict</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Extract options from kwargs</span>
        <span class="n">npred_frac_threshold</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;npred_frac&#39;</span><span class="p">]</span>
        <span class="n">npred_threshold</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;npred_threshold&#39;</span><span class="p">]</span>
        <span class="n">shape_ts_threshold</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;shape_ts_threshold&#39;</span><span class="p">]</span>
        <span class="n">max_free_sources</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;max_free_sources&#39;</span><span class="p">]</span>
        <span class="n">skip</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;skip&#39;</span><span class="p">])</span>

        <span class="n">o</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">make_default_dict</span><span class="p">(</span><span class="n">defaults</span><span class="o">.</span><span class="n">roiopt_output</span><span class="p">)</span>
        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span>
        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;loglike0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loglike0</span>

        <span class="c1"># preserve free parameters</span>
        <span class="n">free</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_free_param_vector</span><span class="p">()</span>

        <span class="c1"># Fix all parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free_sources</span><span class="p">(</span><span class="n">free</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

        <span class="c1"># Free norms of sources for which the sum of npred is a</span>
        <span class="c1"># fraction &gt; npred_frac of the total model counts in the ROI</span>
        <span class="n">npred_sum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">skip_sources</span> <span class="o">=</span> <span class="n">skip</span> <span class="k">if</span> <span class="n">skip</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">joint_norm_fit</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># EAC, we need this try block by older version of the ST don&#39;t have has_weights function</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">has_weights</span><span class="p">():</span>
                <span class="n">npred_str</span> <span class="o">=</span> <span class="s1">&#39;npred_wt&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">npred_str</span> <span class="o">=</span> <span class="s1">&#39;npred&#39;</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">npred_str</span> <span class="o">=</span> <span class="s1">&#39;npred&#39;</span>

        <span class="c1"># FIXME, EAC, use npred_wt here</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="n">npred_str</span><span class="p">],</span>
                        <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

            <span class="n">npred_sum</span> <span class="o">+=</span> <span class="n">s</span><span class="p">[</span><span class="n">npred_str</span><span class="p">]</span>
            <span class="n">npred_frac</span> <span class="o">=</span> <span class="n">npred_sum</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roi_data</span><span class="p">[</span><span class="n">npred_str</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">skip_sources</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">free_norm</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="n">joint_norm_fit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">npred_frac</span> <span class="o">&gt;</span> <span class="n">npred_frac_threshold</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">npred_str</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">npred_threshold</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_norm_fit</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_free_sources</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Joint fit &quot;</span><span class="p">,</span> <span class="n">joint_norm_fit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free_sources</span><span class="p">(</span><span class="n">free</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

        <span class="c1"># Step through remaining sources and re-fit normalizations</span>
        <span class="c1"># FIXME, EAC, use npred_wt here</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="n">npred_str</span><span class="p">],</span>
                        <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">skip_sources</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">joint_norm_fit</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">npred_str</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">npred_threshold</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s1">&#39;Skipping </span><span class="si">%s</span><span class="s1"> with npred </span><span class="si">%10.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="n">npred_str</span><span class="p">])</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Fitting </span><span class="si">%s</span><span class="s1"> npred: </span><span class="si">%10.3f</span><span class="s1"> TS: </span><span class="si">%10.3f</span><span class="s1">&#39;</span><span class="p">,</span>
                              <span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="n">npred_str</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">free_norm</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Post-fit Results npred: </span><span class="si">%10.3f</span><span class="s1"> TS: </span><span class="si">%10.3f</span><span class="s1">&#39;</span><span class="p">,</span>
                              <span class="n">s</span><span class="p">[</span><span class="n">npred_str</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">free_norm</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

        <span class="c1"># Refit spectral shape parameters for sources with TS &gt;</span>
        <span class="c1"># shape_ts_threshold</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span>
                        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">skip_sources</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">shape_ts_threshold</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]):</span>
                <span class="k">continue</span>

            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Fitting shape </span><span class="si">%s</span><span class="s1"> TS: </span><span class="si">%10.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Fitting shape </span><span class="si">%s</span><span class="s1"> TS: </span><span class="si">%10.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">free_source</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">free_source</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_free_param_vector</span><span class="p">(</span><span class="n">free</span><span class="p">)</span>

        <span class="n">loglike1</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">()</span>

        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;loglike1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loglike1</span>
        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;dloglike&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loglike1</span> <span class="o">-</span> <span class="n">loglike0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;Finished&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;LogLike: </span><span class="si">%f</span><span class="s1"> Delta-LogLike: </span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">loglike1</span><span class="p">,</span> <span class="n">loglike1</span> <span class="o">-</span> <span class="n">loglike0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;Execution time: </span><span class="si">%.2f</span><span class="s1"> s&#39;</span><span class="p">,</span> <span class="n">timer</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">o</span></div>

<div class="viewcode-block" id="GTAnalysis.profile_norm"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.profile_norm">[docs]</a>    <span class="k">def</span> <span class="nf">profile_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">logemin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logemax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reoptimize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">xvals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">npts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fix_shape</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">savestate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Profile the normalization of a source.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        name : str</span>
<span class="sd">            Source name.</span>

<span class="sd">        reoptimize : bool</span>
<span class="sd">            Re-optimize free parameters in the model at each point</span>
<span class="sd">            in the profile likelihood scan.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Profiling </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">savestate</span><span class="p">:</span>
            <span class="n">saved_state</span> <span class="o">=</span> <span class="n">LikelihoodState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fix_shape</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">free_sources</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">pars</span><span class="o">=</span><span class="s1">&#39;shape&#39;</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">npts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">npts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;llscan_npts&#39;</span><span class="p">]</span>

        <span class="c1"># Find the source</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="n">parName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">normPar</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>

        <span class="n">loge_bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loge_bounds</span>
        <span class="k">if</span> <span class="n">logemin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">logemax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_energy_range</span><span class="p">(</span><span class="n">logemin</span><span class="p">,</span> <span class="n">logemax</span><span class="p">)</span>

        <span class="c1"># Find a sequence of values for the normalization scan</span>
        <span class="k">if</span> <span class="n">xvals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reoptimize</span><span class="p">:</span>
                <span class="n">xvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_scan_pts_reopt</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">npts</span><span class="o">=</span><span class="n">npts</span><span class="p">,</span>
                                                  <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_scan_pts</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">npts</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
                <span class="n">lnlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parName</span><span class="p">,</span>
                                    <span class="n">reoptimize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xvals</span><span class="o">=</span><span class="n">xvals</span><span class="p">)</span>
                <span class="n">lims</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_parameter_limits</span><span class="p">(</span><span class="n">lnlp</span><span class="p">[</span><span class="s1">&#39;xvals&#39;</span><span class="p">],</span>
                                                  <span class="n">lnlp</span><span class="p">[</span><span class="s1">&#39;dloglike&#39;</span><span class="p">],</span>
                                                  <span class="n">cl_limit</span><span class="o">=</span><span class="mf">0.99</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="s1">&#39;ul&#39;</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Upper limit not found.  &#39;</span>
                                        <span class="s1">&#39;Refitting normalization.&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">xvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_scan_pts</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">npts</span><span class="o">=</span><span class="n">npts</span><span class="p">)</span>
                    <span class="n">lnlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parName</span><span class="p">,</span>
                                        <span class="n">reoptimize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                        <span class="n">xvals</span><span class="o">=</span><span class="n">xvals</span><span class="p">)</span>
                    <span class="n">lims</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_parameter_limits</span><span class="p">(</span><span class="n">lnlp</span><span class="p">[</span><span class="s1">&#39;xvals&#39;</span><span class="p">],</span>
                                                      <span class="n">lnlp</span><span class="p">[</span><span class="s1">&#39;dloglike&#39;</span><span class="p">],</span>
                                                      <span class="n">cl_limit</span><span class="o">=</span><span class="mf">0.99</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="s1">&#39;ll&#39;</span><span class="p">]):</span>
                    <span class="n">xhi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">],</span> <span class="n">lims</span><span class="p">[</span><span class="s1">&#39;ul&#39;</span><span class="p">],</span> <span class="n">npts</span> <span class="o">-</span> <span class="n">npts</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">xlo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="s1">&#39;ll&#39;</span><span class="p">],</span> <span class="n">lims</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">],</span> <span class="n">npts</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">xlo</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xhi</span><span class="p">))</span>
                    <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lnlp</span><span class="p">[</span><span class="s1">&#39;dloglike&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">lims</span><span class="p">[</span><span class="s1">&#39;lnlmax&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
                    <span class="n">lims</span><span class="p">[</span><span class="s1">&#39;ll&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">xhi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">],</span> <span class="n">lims</span><span class="p">[</span><span class="s1">&#39;ul&#39;</span><span class="p">],</span>
                                      <span class="p">(</span><span class="n">npts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">npts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">xlo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="s1">&#39;ll&#39;</span><span class="p">],</span> <span class="n">lims</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">],</span> <span class="p">(</span><span class="n">npts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">xlo</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xhi</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lims</span><span class="p">[</span><span class="s1">&#39;ul&#39;</span><span class="p">],</span> <span class="n">npts</span><span class="p">)</span>

        <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parName</span><span class="p">,</span>
                         <span class="n">reoptimize</span><span class="o">=</span><span class="n">reoptimize</span><span class="p">,</span> <span class="n">xvals</span><span class="o">=</span><span class="n">xvals</span><span class="p">,</span>
                         <span class="n">savestate</span><span class="o">=</span><span class="n">savestate</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">savestate</span><span class="p">:</span>
            <span class="n">saved_state</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">logemin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">logemax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_energy_range</span><span class="p">(</span><span class="o">*</span><span class="n">loge_bounds</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Finished&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">o</span></div>

    <span class="k">def</span> <span class="nf">_find_scan_pts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">logemin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logemax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">npts</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>

        <span class="n">par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">normPar</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="n">loge_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loge_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">logemin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">logemin</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">loge_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">logemax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">logemax</span><span class="p">]</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">syncSrcParams</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_counts_spectrum</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
                                            <span class="n">loge_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="n">loge_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                            <span class="n">summed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">weighted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">npred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
            <span class="c1"># EAC, protect against npred == 0</span>
            <span class="n">val</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">npred</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
            <span class="n">npred</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">syncSrcParams</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_counts_spectrum</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
                                            <span class="n">loge_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="n">loge_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                            <span class="n">summed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">weighted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">npred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">npred</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">*=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1e-16</span><span class="p">,</span> <span class="n">npred</span><span class="p">)</span>
            <span class="n">xvals</span> <span class="o">=</span> <span class="n">val</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="n">npts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">npts_lo</span> <span class="o">=</span> <span class="n">npts</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">npts_hi</span> <span class="o">=</span> <span class="n">npts</span> <span class="o">-</span> <span class="n">npts_lo</span>
            <span class="n">xhi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npts_hi</span><span class="p">)</span>
            <span class="n">xlo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npts_lo</span><span class="p">)</span>
            <span class="n">xvals</span> <span class="o">=</span> <span class="n">val</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">xlo</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xhi</span><span class="p">))</span>
            <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">xvals</span>

    <span class="k">def</span> <span class="nf">_find_scan_pts_reopt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">logemin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logemax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">npts</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                             <span class="n">dloglike_thresh</span><span class="o">=</span><span class="mf">2.7059</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">parName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">normPar</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>

        <span class="n">cl_limit</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">onesided_dlnl_to_cl</span><span class="p">(</span><span class="n">dloglike_thresh</span><span class="p">)</span>

        <span class="n">npts</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">xvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_scan_pts</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">logemin</span><span class="o">=</span><span class="n">logemin</span><span class="p">,</span> <span class="n">logemax</span><span class="o">=</span><span class="n">logemax</span><span class="p">,</span>
                                    <span class="n">npts</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

        <span class="c1"># Generate likelihood profile w/ fixed nuisance pars</span>
        <span class="n">lnlp0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parName</span><span class="p">,</span> <span class="n">logemin</span><span class="o">=</span><span class="n">logemin</span><span class="p">,</span> <span class="n">logemax</span><span class="o">=</span><span class="n">logemax</span><span class="p">,</span>
                             <span class="n">reoptimize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xvals</span><span class="o">=</span><span class="n">xvals</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">xval0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">normPar</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
        <span class="n">lims0</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_parameter_limits</span><span class="p">(</span><span class="n">lnlp0</span><span class="p">[</span><span class="s1">&#39;xvals&#39;</span><span class="p">],</span> <span class="n">lnlp0</span><span class="p">[</span><span class="s1">&#39;dloglike&#39;</span><span class="p">],</span>
                                           <span class="n">cl_limit</span><span class="o">=</span><span class="n">cl_limit</span><span class="p">)</span>

        <span class="c1"># Difference in lnL at maximum with respect to lnL(x=0)</span>
        <span class="n">dlnlmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lnlp0</span><span class="p">[</span><span class="s1">&#39;dloglike&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">lims0</span><span class="p">[</span><span class="s1">&#39;lnlmax&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">dlnlmax</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">lims0</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">lims0</span><span class="p">[</span><span class="s1">&#39;err_hi&#39;</span><span class="p">],</span> <span class="n">lims0</span><span class="p">[</span><span class="s1">&#39;ul&#39;</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lims0</span><span class="p">[</span><span class="s1">&#39;ll&#39;</span><span class="p">],</span>
                              <span class="n">lims0</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lims0</span><span class="p">[</span><span class="s1">&#39;err_lo&#39;</span><span class="p">],</span> <span class="n">lims0</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">],</span>
                              <span class="n">lims0</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">lims0</span><span class="p">[</span><span class="s1">&#39;err_hi&#39;</span><span class="p">],</span> <span class="n">lims0</span><span class="p">[</span><span class="s1">&#39;ul&#39;</span><span class="p">]])</span>
            <span class="n">xvals</span> <span class="o">=</span> <span class="n">xvals</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">xvals</span><span class="p">)]</span>

        <span class="c1"># Generate likelihood profile w/ free nuisance pars</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xvals</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Parameter scan points for </span><span class="si">%s</span><span class="s2">::</span><span class="si">%s</span><span class="s2"> include infinite value.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parName</span><span class="p">))</span>

        <span class="n">lnlp1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parName</span><span class="p">,</span> <span class="n">logemin</span><span class="o">=</span><span class="n">logemin</span><span class="p">,</span> <span class="n">logemax</span><span class="o">=</span><span class="n">logemax</span><span class="p">,</span>
                             <span class="n">reoptimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xvals</span><span class="o">=</span><span class="n">xvals</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">loglike</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">lnlp1</span><span class="p">[</span><span class="s1">&#39;loglike&#39;</span><span class="p">])</span>
        <span class="n">dloglike</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">lnlp1</span><span class="p">[</span><span class="s1">&#39;dloglike&#39;</span><span class="p">])</span>
        <span class="n">dloglike0</span> <span class="o">=</span> <span class="n">dloglike</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">xup</span> <span class="o">=</span> <span class="n">xvals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Search for value at which likelihood changes by a given amount</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>

            <span class="n">lims1</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_parameter_limits</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">dloglike</span><span class="p">,</span>
                                               <span class="n">cl_limit</span><span class="o">=</span><span class="n">cl_limit</span><span class="p">)</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dloglike0</span> <span class="o">-</span> <span class="n">lims1</span><span class="p">[</span><span class="s1">&#39;lnlmax&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">delta</span> <span class="o">-</span> <span class="n">dloglike_thresh</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lims1</span><span class="p">[</span><span class="s1">&#39;ul&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">xup</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">xvals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xup</span> <span class="o">=</span> <span class="n">lims1</span><span class="p">[</span><span class="s1">&#39;ul&#39;</span><span class="p">]</span>

            <span class="n">lnlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parName</span><span class="p">,</span> <span class="n">logemin</span><span class="o">=</span><span class="n">logemin</span><span class="p">,</span>
                                <span class="n">logemax</span><span class="o">=</span><span class="n">logemax</span><span class="p">,</span>
                                <span class="n">reoptimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xvals</span><span class="o">=</span><span class="p">[</span><span class="n">xup</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">dloglike0</span> <span class="o">=</span> <span class="n">lnlp</span><span class="p">[</span><span class="s1">&#39;dloglike&#39;</span><span class="p">]</span>
            <span class="n">loglike0</span> <span class="o">=</span> <span class="n">lnlp</span><span class="p">[</span><span class="s1">&#39;loglike&#39;</span><span class="p">]</span>

            <span class="n">loglike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">loglike</span><span class="p">,</span> <span class="n">loglike0</span><span class="p">))</span>
            <span class="n">dloglike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">dloglike</span><span class="p">,</span> <span class="n">dloglike0</span><span class="p">))</span>
            <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">xvals</span><span class="p">,</span> <span class="p">[</span><span class="n">xup</span><span class="p">]))</span>
            <span class="n">isort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">xvals</span><span class="p">)</span>
            <span class="n">dloglike</span> <span class="o">=</span> <span class="n">dloglike</span><span class="p">[</span><span class="n">isort</span><span class="p">]</span>
            <span class="n">loglike</span> <span class="o">=</span> <span class="n">loglike</span><span class="p">[</span><span class="n">isort</span><span class="p">]</span>
            <span class="n">xvals</span> <span class="o">=</span> <span class="n">xvals</span><span class="p">[</span><span class="n">isort</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lims1</span><span class="p">[</span><span class="s1">&#39;ll&#39;</span><span class="p">]):</span>
            <span class="n">xlo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">([</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lims1</span><span class="p">[</span><span class="s1">&#39;ll&#39;</span><span class="p">],</span> <span class="n">xval0</span><span class="p">,</span> <span class="p">(</span><span class="n">npts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dloglike</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">lims1</span><span class="p">[</span><span class="s1">&#39;lnlmax&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="n">xlo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">xval0</span><span class="p">,</span> <span class="p">(</span><span class="n">npts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xlo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">xval0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lims1</span><span class="p">[</span><span class="s1">&#39;ul&#39;</span><span class="p">]):</span>
            <span class="n">xhi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xval0</span><span class="p">,</span> <span class="n">lims1</span><span class="p">[</span><span class="s1">&#39;ul&#39;</span><span class="p">],</span> <span class="n">npts</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">xlo</span><span class="p">))[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xhi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xval0</span><span class="p">,</span> <span class="n">lims0</span><span class="p">[</span><span class="s1">&#39;ul&#39;</span><span class="p">],</span> <span class="n">npts</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">xlo</span><span class="p">))[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">xlo</span><span class="p">,</span> <span class="n">xhi</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">xvals</span>

<div class="viewcode-block" id="GTAnalysis.profile"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.profile">[docs]</a>    <span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parName</span><span class="p">,</span> <span class="n">logemin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logemax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">reoptimize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">xvals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">npts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">savestate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Profile the likelihood for the given source and parameter.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        name : str</span>
<span class="sd">           Source name.</span>

<span class="sd">        parName : str</span>
<span class="sd">           Parameter name.</span>

<span class="sd">        reoptimize : bool</span>
<span class="sd">           Re-fit nuisance parameters at each step in the scan.  Note</span>
<span class="sd">           that enabling this option will only re-fit parameters that</span>
<span class="sd">           were free when the method was executed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        lnlprofile : dict</span>
<span class="sd">           Dictionary containing results of likelihood scan.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find the source</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>

        <span class="n">par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">normPar</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">parName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">normPar</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">par_index</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parName</span><span class="p">)</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
        <span class="n">loge_bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loge_bounds</span>

        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;optimizer&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">savestate</span><span class="p">:</span>
            <span class="n">saved_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latch_state</span><span class="p">()</span>

        <span class="c1"># If parameter is fixed temporarily free it</span>
        <span class="n">par</span><span class="o">.</span><span class="n">setFree</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">optimizer</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NEWTON&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_fitcache</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">logemin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">logemax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loge_bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_energy_range</span><span class="p">(</span><span class="n">logemin</span><span class="p">,</span> <span class="n">logemax</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loge_bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loge_bounds</span>

        <span class="n">loglike0</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">xvals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">err</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">error</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">err</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">xvals</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mi">51</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">xvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
                <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">xvals</span><span class="p">[</span><span class="mi">1</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xvals</span><span class="p">))</span>
                <span class="n">xvals</span> <span class="o">=</span> <span class="n">val</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">xvals</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xvals</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Parameter scan points for </span><span class="si">%s</span><span class="s2">::</span><span class="si">%s</span><span class="s2"> include infinite value.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parName</span><span class="p">))</span>

        <span class="c1"># Update parameter bounds to encompass scan range</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">xvals</span><span class="p">),</span> <span class="n">value</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                     <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">xvals</span><span class="p">),</span> <span class="n">value</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Caught failure on setBounds for </span><span class="si">%s</span><span class="s2">::</span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parName</span><span class="p">))</span>

        <span class="n">o</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;xvals&#39;</span><span class="p">:</span> <span class="n">xvals</span><span class="p">,</span>
             <span class="s1">&#39;npred&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xvals</span><span class="p">)),</span>
             <span class="s1">&#39;npred_wt&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xvals</span><span class="p">)),</span>
             <span class="s1">&#39;dnde&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xvals</span><span class="p">)),</span>
             <span class="s1">&#39;flux&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xvals</span><span class="p">)),</span>
             <span class="s1">&#39;eflux&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xvals</span><span class="p">)),</span>
             <span class="s1">&#39;dloglike&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xvals</span><span class="p">)),</span>
             <span class="s1">&#39;loglike&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xvals</span><span class="p">))</span>
             <span class="p">}</span>

        <span class="k">if</span> <span class="n">reoptimize</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">logLike</span><span class="p">,</span>
                                  <span class="s1">&#39;setUpdateFixedWeights&#39;</span><span class="p">):</span>

            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">setUpdateFixedWeights</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xvals</span><span class="p">):</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Caught failure on set for </span><span class="si">%s</span><span class="s2">::</span><span class="si">%s</span><span class="s2">: </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parName</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">nFreeParams</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">reoptimize</span><span class="p">:</span>
                <span class="c1"># Only reoptimize if not all frozen</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">fit_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">optimizer</span><span class="p">)</span>
                <span class="n">loglike1</span> <span class="o">=</span> <span class="n">fit_output</span><span class="p">[</span><span class="s1">&#39;loglike&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">thaw</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loglike1</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">()</span>

            <span class="n">flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">loge_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                        <span class="mi">10</span> <span class="o">**</span> <span class="n">loge_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">eflux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">energyFlux</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">loge_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                               <span class="mi">10</span> <span class="o">**</span> <span class="n">loge_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">prefactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;dloglike&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">loglike1</span> <span class="o">-</span> <span class="n">loglike0</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;loglike&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">loglike1</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;dnde&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefactor</span><span class="o">.</span><span class="n">getTrueValue</span><span class="p">()</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;eflux&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">eflux</span>

            <span class="n">cs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_counts_spectrum</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
                                            <span class="n">loge_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="n">loge_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">summed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;npred&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
            <span class="n">cs_wt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_counts_spectrum</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
                                               <span class="n">loge_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                               <span class="n">loge_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">summed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">weighted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;npred_wt&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cs_wt</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">reoptimize</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">logLike</span><span class="p">,</span>
                                  <span class="s1">&#39;setUpdateFixedWeights&#39;</span><span class="p">):</span>

            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">setUpdateFixedWeights</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Restore model parameters to original values</span>
        <span class="k">if</span> <span class="n">savestate</span><span class="p">:</span>
            <span class="n">saved_state</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="o">*</span><span class="n">bounds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logemin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">logemax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_energy_range</span><span class="p">(</span><span class="o">*</span><span class="n">loge_bounds</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">o</span></div>

<div class="viewcode-block" id="GTAnalysis.constrain_norms"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.constrain_norms">[docs]</a>    <span class="k">def</span> <span class="nf">constrain_norms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">srcNames</span><span class="p">,</span> <span class="n">cov_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constrain the normalizations of one or more sources by</span>
<span class="sd">        adding gaussian priors with sigma equal to the parameter</span>
<span class="sd">        error times a scaling factor.&quot;&quot;&quot;</span>

        <span class="c1"># Get the covariance matrix</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">srcNames</span><span class="p">:</span>
            <span class="n">par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">normPar</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="n">err</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">error</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">error</span><span class="p">()</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">par</span><span class="o">.</span><span class="n">isFree</span><span class="p">():</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">add_gauss_prior</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span>
                                 <span class="n">val</span><span class="p">,</span> <span class="n">err</span> <span class="o">*</span> <span class="n">cov_scale</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.add_gauss_prior"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.add_gauss_prior">[docs]</a>    <span class="k">def</span> <span class="nf">add_gauss_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parName</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>

        <span class="n">par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s2">&quot;Spectrum&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">parName</span><span class="p">]</span>
        <span class="n">par</span><span class="o">.</span><span class="n">addGaussianPrior</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.remove_prior"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.remove_prior">[docs]</a>    <span class="k">def</span> <span class="nf">remove_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parName</span><span class="p">):</span>

        <span class="n">par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s2">&quot;Spectrum&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">parName</span><span class="p">]</span>
        <span class="n">par</span><span class="o">.</span><span class="n">removePrior</span><span class="p">()</span></div>

<div class="viewcode-block" id="GTAnalysis.remove_priors"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.remove_priors">[docs]</a>    <span class="k">def</span> <span class="nf">remove_priors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear all priors.&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="s2">&quot;Spectrum&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">par</span><span class="o">.</span><span class="n">removePrior</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_create_optObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Make MINUIT or NewMinuit type optimizer object &quot;&quot;&quot;</span>

        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;optimizer&#39;</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">][</span><span class="s1">&#39;optimizer&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;MINUIT&#39;</span><span class="p">:</span>
            <span class="n">optObject</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">Minuit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;NEWMINUIT&#39;</span><span class="p">:</span>
            <span class="n">optObject</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">NewMinuit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">optFactory</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">OptimizerFactory_instance</span><span class="p">()</span>
            <span class="n">optObject</span> <span class="o">=</span> <span class="n">optFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">optimizer</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">optObject</span>

    <span class="k">def</span> <span class="nf">_fit_optimizer_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">min_fit_quality</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_fit_quality&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">retries</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;retries&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">covar</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;covar&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">num_free</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">nFreeParams</span><span class="p">()</span>
        <span class="n">o</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_free</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
             <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_free</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
             <span class="s1">&#39;covariance&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">num_free</span><span class="p">,</span> <span class="n">num_free</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
             <span class="s1">&#39;correlation&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">num_free</span><span class="p">,</span> <span class="n">num_free</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
             <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_free</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
             <span class="s1">&#39;is_norm&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">num_free</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span>
             <span class="s1">&#39;src_names&#39;</span><span class="p">:</span> <span class="n">num_free</span> <span class="o">*</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span>
             <span class="s1">&#39;par_names&#39;</span><span class="p">:</span> <span class="n">num_free</span> <span class="o">*</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span>
             <span class="s1">&#39;fit_quality&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
             <span class="s1">&#39;fit_status&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
             <span class="s1">&#39;fit_success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
             <span class="s1">&#39;edm&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
             <span class="s1">&#39;niter&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
             <span class="s1">&#39;loglike&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">num_free</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;loglike&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">o</span>

        <span class="n">quality</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">niter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">niter</span> <span class="o">&lt;</span> <span class="n">retries</span><span class="p">:</span>
            <span class="n">niter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">quality</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">edm</span><span class="p">,</span> <span class="n">loglike</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_optimizer</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">quality</span> <span class="o">&gt;=</span> <span class="n">min_fit_quality</span> <span class="ow">and</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retry fit iter: </span><span class="si">%i</span><span class="s2"> quality: </span><span class="si">%i</span><span class="s2"> edm: </span><span class="si">%8.4f</span><span class="s2"> loglike: </span><span class="si">%12.3f</span><span class="s2">&quot;</span><span class="p">,</span>
                              <span class="n">niter</span><span class="p">,</span> <span class="n">quality</span><span class="p">,</span> <span class="n">edm</span><span class="p">,</span> <span class="n">loglike</span><span class="p">)</span>

        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;fit_quality&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quality</span>
        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;fit_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>
        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;edm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edm</span>
        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;niter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">niter</span>
        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;loglike&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loglike</span>

        <span class="k">if</span> <span class="n">quality</span> <span class="o">&lt;</span> <span class="n">min_fit_quality</span> <span class="ow">or</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;fit_status&#39;</span><span class="p">]:</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;fit_success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">covar</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">covariance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">covariance</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_free</span><span class="p">):</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;covariance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">covariance</span><span class="p">)</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;covariance&#39;</span><span class="p">])</span><span class="o">**</span><span class="mf">0.5</span>
            <span class="n">errinv</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;correlation&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">o</span><span class="p">[</span><span class="s1">&#39;covariance&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">errinv</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">errinv</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">free_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_params</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">free_params</span><span class="p">):</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;src_names&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;src_name&#39;</span><span class="p">]</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;par_names&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;par_name&#39;</span><span class="p">]</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;is_norm&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;is_norm&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">o</span>

    <span class="k">def</span> <span class="nf">_fit_optimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">errors</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;errors&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">optObject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_optObject</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;optimizer&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;MINUIT&#39;</span><span class="p">))</span>

        <span class="n">kw</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">quality</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">edm</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">loglike</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;verbosity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbosity&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tol&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;covar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;covar&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;optObject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optObject</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;verbosity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbosity&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tol&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;optObject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optObject</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

            <span class="n">status</span> <span class="o">=</span> <span class="n">optObject</span><span class="o">.</span><span class="n">getRetCode</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">optObject</span><span class="p">,</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">Minuit</span><span class="p">):</span>
                <span class="n">quality</span> <span class="o">=</span> <span class="n">optObject</span><span class="o">.</span><span class="n">getQuality</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">optObject</span><span class="p">,</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">Minuit</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">optObject</span><span class="p">,</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">NewMinuit</span><span class="p">):</span>
                <span class="n">edm</span> <span class="o">=</span> <span class="n">optObject</span><span class="o">.</span><span class="n">getDistance</span><span class="p">()</span>

            <span class="n">loglike</span> <span class="o">=</span> <span class="n">optObject</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Likelihood optimization failed.&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">quality</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">quality</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">edm</span><span class="p">,</span> <span class="n">loglike</span>

    <span class="k">def</span> <span class="nf">_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;optimizer&#39;</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">][</span><span class="s1">&#39;optimizer&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">optimizer</span> <span class="o">==</span> <span class="s1">&#39;NEWTON&#39;</span><span class="p">:</span>

            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_params</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;is_norm&#39;</span><span class="p">]:</span>
                    <span class="n">optimizer</span> <span class="o">=</span> <span class="s1">&#39;MINUIT&#39;</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;MINUIT&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s1">&#39;Found non-norm free parameter.  Reverting to MINUIT.&#39;</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="n">optimizer</span> <span class="o">==</span> <span class="s1">&#39;NEWTON&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_newton</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_optimizer_iter</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="GTAnalysis.fit"><a class="viewcode-back" href="../../fitting.html#fermipy.gtanalysis.GTAnalysis.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the likelihood optimization.  This will execute a fit of all</span>
<span class="sd">        parameters that are currently free in the model and update the</span>
<span class="sd">        charateristics of the corresponding model components (TS,</span>
<span class="sd">        npred, etc.).  The fit will be repeated N times (set with the</span>
<span class="sd">        `retries` parameter) until a fit quality greater than or equal</span>
<span class="sd">        to `min_fit_quality` and a fit status code of 0 is obtained.</span>
<span class="sd">        If the fit does not succeed after N retries then all parameter</span>
<span class="sd">        values will be reverted to their state prior to the execution</span>
<span class="sd">        of the fit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        update : bool</span>
<span class="sd">           Update the model dictionary for all sources with free</span>
<span class="sd">           parameters.</span>

<span class="sd">        tol : float</span>
<span class="sd">           Set the optimizer tolerance.</span>

<span class="sd">        verbosity : int</span>
<span class="sd">           Set the optimizer output level.</span>

<span class="sd">        optimizer : str</span>
<span class="sd">           Set the likelihood optimizer (e.g. MINUIT or NEWMINUIT).</span>

<span class="sd">        retries : int</span>
<span class="sd">           Set the number of times to rerun the fit when the fit quality</span>
<span class="sd">           is &lt; 3.</span>

<span class="sd">        min_fit_quality : int</span>
<span class="sd">           Set the minimum fit quality.  If the fit quality is smaller</span>
<span class="sd">           than this value then all model parameters will be</span>
<span class="sd">           restored to their values prior to the fit.</span>

<span class="sd">        reoptimize : bool</span>
<span class="sd">           Refit background sources when updating source properties</span>
<span class="sd">           (TS and likelihood profiles).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        fit : dict</span>
<span class="sd">           Dictionary containing diagnostic information from the fit</span>
<span class="sd">           (fit quality, parameter covariances, etc.).</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">loglevel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;loglevel&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglevel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s2">&quot;Starting fit.&quot;</span><span class="p">)</span>

        <span class="c1"># Extract options from kwargs</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">])</span>
        <span class="n">config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;covar&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;reoptimize&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">merge_dict</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

        <span class="n">num_free</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">nFreeParams</span><span class="p">()</span>

        <span class="n">loglike0</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">()</span>

        <span class="c1"># Initialize output dict</span>
        <span class="n">o</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fit_quality&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
             <span class="s1">&#39;fit_status&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
             <span class="s1">&#39;fit_success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
             <span class="s1">&#39;dloglike&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
             <span class="s1">&#39;edm&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
             <span class="s1">&#39;loglike&#39;</span><span class="p">:</span> <span class="n">loglike0</span><span class="p">,</span>
             <span class="s1">&#39;covariance&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
             <span class="s1">&#39;correlation&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
             <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_free</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
             <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_free</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
             <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_free</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
             <span class="s1">&#39;is_norm&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">num_free</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span>
             <span class="s1">&#39;src_names&#39;</span><span class="p">:</span> <span class="n">num_free</span> <span class="o">*</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span>
             <span class="s1">&#39;par_names&#39;</span><span class="p">:</span> <span class="n">num_free</span> <span class="o">*</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span>
             <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">config</span>
             <span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">num_free</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s2">&quot;Skipping fit.  No free parameters.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">o</span>

        <span class="n">saved_state</span> <span class="o">=</span> <span class="n">LikelihoodState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">)</span>

        <span class="n">fit_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="n">o</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fit_output</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Fit complete.&quot;</span><span class="p">)</span>
        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;dloglike&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;loglike&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">loglike0</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;fit_success&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> failed with status code </span><span class="si">%i</span><span class="s1"> fit quality </span><span class="si">%i</span><span class="s1">&#39;</span><span class="p">,</span>
                              <span class="n">config</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">],</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;fit_status&#39;</span><span class="p">],</span>
                              <span class="n">o</span><span class="p">[</span><span class="s1">&#39;fit_quality&#39;</span><span class="p">])</span>
            <span class="n">saved_state</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">o</span>

        <span class="k">if</span> <span class="n">update</span><span class="p">:</span>

            <span class="n">free_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_params</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extract_correlation</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">free_params</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">sourceNames</span><span class="p">():</span>
                <span class="n">freePars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_free_source_params</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">freePars</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_source</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">reoptimize</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;reoptimize&#39;</span><span class="p">])</span>

            <span class="c1"># Update roi model counts</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_roi</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s2">&quot;Fit returned successfully. &quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;Quality: </span><span class="si">%3i</span><span class="s2"> Status: </span><span class="si">%3i</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;fit_quality&#39;</span><span class="p">],</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;fit_status&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s2">&quot;LogLike: </span><span class="si">%12.3f</span><span class="s2"> DeltaLogLike: </span><span class="si">%12.3f</span><span class="s2"> &quot;</span><span class="p">,</span>
                        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;loglike&#39;</span><span class="p">],</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;dloglike&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">o</span></div>

    <span class="k">def</span> <span class="nf">_create_fitcache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">create_fitcache</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;create_fitcache&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fitcache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">create_fitcache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fitcache</span>

        <span class="n">tol</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tol&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">][</span><span class="s1">&#39;tol&#39;</span><span class="p">])</span>
        <span class="n">max_iter</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_iter&#39;</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">][</span><span class="s1">&#39;max_iter&#39;</span><span class="p">])</span>
        <span class="n">init_lambda</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;init_lambda&#39;</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">][</span><span class="s1">&#39;init_lambda&#39;</span><span class="p">])</span>
        <span class="n">use_reduced</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_reduced&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Creating FitCache&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">tol: </span><span class="si">%.5g</span><span class="se">\n</span><span class="s1">max_iter: </span><span class="si">%i</span><span class="se">\n</span><span class="s1">init_lambda: </span><span class="si">%.5g</span><span class="s1">&#39;</span><span class="p">,</span>
                          <span class="n">tol</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">,</span> <span class="n">init_lambda</span><span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fitcache</span> <span class="o">=</span> <span class="n">FitCache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
                                  <span class="n">tol</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">,</span> <span class="n">init_lambda</span><span class="p">,</span> <span class="n">use_reduced</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fitcache</span>

    <span class="k">def</span> <span class="nf">_fit_newton</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fitcache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ebin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fast fitting method using newton fitter.&quot;&quot;&quot;</span>

        <span class="n">tol</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tol&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">][</span><span class="s1">&#39;tol&#39;</span><span class="p">])</span>
        <span class="n">max_iter</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_iter&#39;</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">][</span><span class="s1">&#39;max_iter&#39;</span><span class="p">])</span>
        <span class="n">init_lambda</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;init_lambda&#39;</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">][</span><span class="s1">&#39;init_lambda&#39;</span><span class="p">])</span>
        <span class="n">use_reduced</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_reduced&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">free_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_params</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">free_norm_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">free_params</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;is_norm&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">free_params</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">free_norm_params</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Executing Newton fitter with one &#39;</span> <span class="o">+</span> \
                <span class="s1">&#39;or more free shape parameters.&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">verbosity</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbosity&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fitcache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fitcache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_fitcache</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">fitcache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_params</span><span class="p">(),</span>
                        <span class="n">tol</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">,</span> <span class="n">init_lambda</span><span class="p">,</span> <span class="n">use_reduced</span><span class="p">)</span>

        <span class="n">logemin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loge_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logemax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loge_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">imin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">val_to_edge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">,</span> <span class="n">logemin</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">imax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">val_to_edge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">,</span> <span class="n">logemax</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">ebin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fitcache</span><span class="o">.</span><span class="n">fitcache</span><span class="o">.</span><span class="n">setEnergyBin</span><span class="p">(</span><span class="n">ebin</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">imin</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">imax</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">enumbins</span><span class="p">:</span>
            <span class="n">fitcache</span><span class="o">.</span><span class="n">fitcache</span><span class="o">.</span><span class="n">setEnergyBin</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fitcache</span><span class="o">.</span><span class="n">fitcache</span><span class="o">.</span><span class="n">setEnergyBins</span><span class="p">(</span><span class="n">imin</span><span class="p">,</span> <span class="n">imax</span><span class="p">)</span>

        <span class="n">num_free</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">free_norm_params</span><span class="p">)</span>

        <span class="n">o</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fit_status&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
             <span class="s1">&#39;fit_quality&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
             <span class="s1">&#39;fit_success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
             <span class="s1">&#39;edm&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
             <span class="s1">&#39;loglike&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
             <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_free</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
             <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_free</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
             <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_free</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
             <span class="s1">&#39;is_norm&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">num_free</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span>
             <span class="s1">&#39;src_names&#39;</span><span class="p">:</span> <span class="n">num_free</span> <span class="o">*</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span>
             <span class="s1">&#39;par_names&#39;</span><span class="p">:</span> <span class="n">num_free</span> <span class="o">*</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span>
             <span class="p">}</span>

        <span class="k">if</span> <span class="n">num_free</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">o</span>

        <span class="n">ref_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fitcache</span><span class="o">.</span><span class="n">fitcache</span><span class="o">.</span><span class="n">refValues</span><span class="p">())</span>
        <span class="n">free</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fitcache</span><span class="o">.</span><span class="n">fitcache</span><span class="o">.</span><span class="n">currentFree</span><span class="p">())</span>
        <span class="n">norm_vals</span> <span class="o">=</span> <span class="n">ref_vals</span><span class="p">[</span><span class="n">free</span><span class="p">]</span>

        <span class="n">norm_idxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">free_norm_params</span><span class="p">):</span>

            <span class="n">norm_idxs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]]</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;src_names&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;src_name&#39;</span><span class="p">]</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;par_names&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;par_name&#39;</span><span class="p">]</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;is_norm&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;is_norm&#39;</span><span class="p">]</span>

        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;fit_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitcache</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;edm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitcache</span><span class="o">.</span><span class="n">fitcache</span><span class="o">.</span><span class="n">currentEDM</span><span class="p">()</span>

        <span class="n">pars</span><span class="p">,</span> <span class="n">errs</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">fitcache</span><span class="o">.</span><span class="n">get_pars</span><span class="p">()</span>
        <span class="n">pars</span> <span class="o">*=</span> <span class="n">norm_vals</span>
        <span class="n">errs</span> <span class="o">*=</span> <span class="n">norm_vals</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">cov</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">norm_vals</span><span class="p">,</span> <span class="n">norm_vals</span><span class="p">)</span>

        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pars</span>
        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">errs</span>
        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;covariance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span>
        <span class="n">errinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">])</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">errinv</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span>
        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;correlation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;covariance&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">errinv</span><span class="p">,</span> <span class="n">errinv</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;fit_status&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">err</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">norm_idxs</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">errs</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_value_bounded</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">setError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">syncSrcParams</span><span class="p">()</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;fit_success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;fit_success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;fit_status&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error in NEWTON fit. Fit Status: </span><span class="si">%i</span><span class="s1">&#39;</span><span class="p">,</span>
                              <span class="n">o</span><span class="p">[</span><span class="s1">&#39;fit_status&#39;</span><span class="p">])</span>

        <span class="c1"># FIXME: Figure out why currentLogLike gets out of sync</span>
        <span class="c1">#loglike = fitcache.fitcache.currentLogLike()</span>
        <span class="c1">#prior_vals, prior_errs, has_prior = gtutils.get_priors(self.like)</span>
        <span class="c1">#loglike -= np.sum(has_prior) * np.log(np.sqrt(2 * np.pi))</span>
        <span class="n">loglike</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">()</span>
        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;loglike&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loglike</span>

        <span class="k">return</span> <span class="n">o</span>

<div class="viewcode-block" id="GTAnalysis.fit_correlation"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.fit_correlation">[docs]</a>    <span class="k">def</span> <span class="nf">fit_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">saved_state</span> <span class="o">=</span> <span class="n">LikelihoodState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free_sources</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free_sources</span><span class="p">(</span><span class="n">pars</span><span class="o">=</span><span class="s1">&#39;norm&#39;</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="n">fit_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="n">min_fit_quality</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">free_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_params</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extract_correlation</span><span class="p">(</span><span class="n">fit_results</span><span class="p">,</span> <span class="n">free_params</span><span class="p">)</span>
        <span class="n">saved_state</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_extract_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fit_results</span><span class="p">,</span> <span class="n">free_params</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p0</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">free_params</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">p0</span><span class="p">[</span><span class="s1">&#39;is_norm&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="n">p0</span><span class="p">[</span><span class="s1">&#39;src_name&#39;</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">free_params</span><span class="p">):</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">p1</span><span class="p">[</span><span class="s1">&#39;is_norm&#39;</span><span class="p">]:</span>
                    <span class="k">continue</span>

                <span class="n">src</span><span class="p">[</span><span class="s1">&#39;correlation&#39;</span><span class="p">][</span><span class="n">p1</span><span class="p">[</span><span class="s1">&#39;src_name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">fit_results</span><span class="p">[</span>
                    <span class="s1">&#39;correlation&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

<div class="viewcode-block" id="GTAnalysis.load_xml"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.load_xml">[docs]</a>    <span class="k">def</span> <span class="nf">load_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xmlfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load model definition from XML.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        xmlfile : str</span>
<span class="sd">            Name of the input XML file.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading XML&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">load_xml</span><span class="p">(</span><span class="n">xmlfile</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">sourceNames</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_source</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fitcache</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Finished Loading XML&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.write_xml"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.write_xml">[docs]</a>    <span class="k">def</span> <span class="nf">write_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xmlfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save current model definition as XML file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        xmlfile : str</span>
<span class="sd">            Name of the output XML file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">write_xml</span><span class="p">(</span><span class="n">xmlfile</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.load_parameters_from_yaml"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.load_parameters_from_yaml">[docs]</a>    <span class="k">def</span> <span class="nf">load_parameters_from_yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yamlfile</span><span class="p">,</span> <span class="n">update_sources</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load model parameters from yaml</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        yamlfile : str</span>
<span class="sd">            Name of the input yaml file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_yaml</span><span class="p">(</span><span class="n">yamlfile</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">src_pars</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">par_name</span><span class="p">,</span> <span class="n">par_dict</span> <span class="ow">in</span> <span class="n">src_pars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">par_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;SpectrumType&#39;</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="n">par_value</span> <span class="o">=</span> <span class="n">par_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">par_error</span> <span class="o">=</span> <span class="n">par_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">par_scale</span> <span class="o">=</span> <span class="n">par_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">par_min</span> <span class="o">=</span> <span class="n">par_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">par_max</span> <span class="o">=</span> <span class="n">par_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">par_free</span> <span class="o">=</span> <span class="n">par_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;free&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">par_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">par_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">par_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">par_min</span><span class="p">,</span> <span class="n">par_max</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">par_bounds</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_parameter</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">par_name</span><span class="p">,</span> <span class="n">par_value</span><span class="p">,</span> <span class="n">true_value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                       <span class="n">scale</span><span class="o">=</span><span class="n">par_scale</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">par_bounds</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">par_error</span><span class="p">,</span>
                                       <span class="n">update_source</span><span class="o">=</span><span class="n">update_sources</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Did not set parameter </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="n">par_name</span><span class="p">))</span>                    
                    <span class="k">continue</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">par_free</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">free_parameter</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">par_name</span><span class="p">,</span> <span class="n">par_free</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_params_state</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_restore_counts_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Revert counts maps to their state prior to injecting any simulated</span>
<span class="sd">        components.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">restore_counts_maps</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">logLike</span><span class="p">,</span> <span class="s1">&#39;setCountsMap&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_roi_model</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_xml</span><span class="p">(</span><span class="s1">&#39;tmp&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_like</span> <span class="o">=</span> <span class="n">SummedLikelihood</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">):</span>
                <span class="n">c</span><span class="o">.</span><span class="n">_create_binned_analysis</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_like</span><span class="o">.</span><span class="n">addComponent</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">like</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_roi_model</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_xml</span><span class="p">(</span><span class="s1">&#39;tmp&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="GTAnalysis.simulate_source"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.simulate_source">[docs]</a>    <span class="k">def</span> <span class="nf">simulate_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inject simulated source counts into the data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        src_dict : dict</span>
<span class="sd">           Dictionary defining the spatial and spectral properties of</span>
<span class="sd">           the source that will be injected.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fitcache</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">src_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">src_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">src_dict</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">src_dict</span><span class="p">)</span>

        <span class="n">skydir</span> <span class="o">=</span> <span class="n">wcs_utils</span><span class="o">.</span><span class="n">get_target_skydir</span><span class="p">(</span><span class="n">src_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">skydir</span><span class="p">)</span>

        <span class="n">src_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="n">skydir</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
        <span class="n">src_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="n">skydir</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
        <span class="n">src_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;SpatialModel&#39;</span><span class="p">,</span> <span class="s1">&#39;PointSource&#39;</span><span class="p">)</span>
        <span class="n">src_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;SpatialWidth&#39;</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
        <span class="n">src_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="n">src_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;Prefactor&#39;</span><span class="p">,</span> <span class="mf">1E-13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_source</span><span class="p">(</span><span class="s1">&#39;mcsource&#39;</span><span class="p">,</span> <span class="n">src_dict</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">init_source</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">simulate_roi</span><span class="p">(</span><span class="s1">&#39;mcsource&#39;</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">delete_source</span><span class="p">(</span><span class="s1">&#39;mcsource&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">logLike</span><span class="p">,</span> <span class="s1">&#39;setCountsMap&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_roi_model</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_xml</span><span class="p">(</span><span class="s1">&#39;tmp&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_like</span> <span class="o">=</span> <span class="n">SummedLikelihood</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">):</span>
                <span class="n">c</span><span class="o">.</span><span class="n">_create_binned_analysis</span><span class="p">(</span><span class="s1">&#39;tmp.xml&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_like</span><span class="o">.</span><span class="n">addComponent</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">like</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_roi_model</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_xml</span><span class="p">(</span><span class="s1">&#39;tmp&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.simulate_roi"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.simulate_roi">[docs]</a>    <span class="k">def</span> <span class="nf">simulate_roi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">randomize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">restore</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a simulation of the ROI using the current best-fit model</span>
<span class="sd">        and replace the data counts cube with this simulation.  The</span>
<span class="sd">        simulation is created by generating an array of Poisson random</span>
<span class="sd">        numbers with expectation values drawn from the model cube of</span>
<span class="sd">        the binned analysis instance.  This function will update the</span>
<span class="sd">        counts cube both in memory and in the source map file.  The</span>
<span class="sd">        counts cube can be restored to its original state by calling</span>
<span class="sd">        this method with ``restore`` = True.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">           Name of the model component to be simulated.  If None then</span>
<span class="sd">           the whole ROI will be simulated.</span>

<span class="sd">        restore : bool</span>
<span class="sd">           Restore the data counts cube to its original state.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Simulating ROI&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fitcache</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">restore</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Restoring&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_restore_counts_maps</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Finished&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">simulate_roi</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">randomize</span><span class="o">=</span><span class="n">randomize</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">logLike</span><span class="p">,</span> <span class="s1">&#39;setCountsMap&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_roi_model</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_xml</span><span class="p">(</span><span class="s1">&#39;tmp&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_like</span> <span class="o">=</span> <span class="n">SummedLikelihood</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">):</span>
                <span class="n">c</span><span class="o">.</span><span class="n">_create_binned_analysis</span><span class="p">(</span><span class="s1">&#39;tmp.xml&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_like</span><span class="o">.</span><span class="n">addComponent</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">like</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_roi_model</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_xml</span><span class="p">(</span><span class="s1">&#39;tmp&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Finished&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.write_model_map"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.write_model_map">[docs]</a>    <span class="k">def</span> <span class="nf">write_model_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the counts model map to a FITS file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_name : str</span>
<span class="sd">            String that will be append to the name of the output file.</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of the component.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">maps</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">write_model_map</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">]</span>

        <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span>
                               <span class="s1">&#39;mcube_</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_name</span><span class="p">))</span>

        <span class="n">mmap</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">from_geom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">maps</span><span class="p">:</span>
            <span class="n">mmap</span><span class="o">.</span><span class="n">coadd</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">mmap</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="s1">&#39;fgst-ccube&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">mmap</span><span class="p">]</span> <span class="o">+</span> <span class="n">maps</span></div>

<div class="viewcode-block" id="GTAnalysis.write_weight_map"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.write_weight_map">[docs]</a>    <span class="k">def</span> <span class="nf">write_weight_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the counts model map to a FITS file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_name : str</span>
<span class="sd">            String that will be append to the name of the output file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">maps</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">write_weight_map</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">]</span>

        <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span>
                               <span class="s1">&#39;wcube_</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_name</span><span class="p">))</span>

        <span class="n">wmap</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">from_geom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="p">)</span>
        <span class="c1"># FIXME: Should we average weights maps rather than coadding?</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">maps</span><span class="p">:</span>
            <span class="n">wmap</span><span class="o">.</span><span class="n">coadd</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">wmap</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="s1">&#39;fgst-ccube&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">wmap</span><span class="p">]</span> <span class="o">+</span> <span class="n">maps</span></div>

<div class="viewcode-block" id="GTAnalysis.print_roi"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.print_roi">[docs]</a>    <span class="k">def</span> <span class="nf">print_roi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print information about the spectral and spatial properties</span>
<span class="sd">        of the ROI (sources, diffuse components).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">))</span></div>

<div class="viewcode-block" id="GTAnalysis.print_params"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.print_params">[docs]</a>    <span class="k">def</span> <span class="nf">print_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allpars</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print information about the model parameters (values,</span>
<span class="sd">        errors, bounds, scale).&quot;&quot;&quot;</span>

        <span class="n">pars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span>

        <span class="n">o</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">o</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%4s</span><span class="s1"> </span><span class="si">%-20s%10s%10s%10s%10s%10s%5s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="s1">&#39;idx&#39;</span><span class="p">,</span> <span class="s1">&#39;parname&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="s1">&#39;free&#39;</span><span class="p">)</span>

        <span class="n">o</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="n">src_pars</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pars</span><span class="p">:</span>

            <span class="n">src_pars</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;src_name&#39;</span><span class="p">],</span> <span class="p">[])</span>
            <span class="n">src_pars</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;src_name&#39;</span><span class="p">]]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">p</span><span class="p">]</span>

        <span class="n">free_sources</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">src_pars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">]:</span>
                    <span class="k">continue</span>

                <span class="n">free_sources</span> <span class="o">+=</span> <span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">src_pars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">allpars</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">free_sources</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">o</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">k</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>

                <span class="n">o</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%4i</span><span class="s1"> </span><span class="si">%-20.19s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;par_name&#39;</span><span class="p">])</span>
                <span class="n">o</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%10.3g%10.3g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span>
                <span class="n">o</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%10.3g%10.3g%10.3g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">],</span>
                                             <span class="n">p</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">]:</span>
                    <span class="n">o</span> <span class="o">+=</span> <span class="s1">&#39;    *&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">o</span> <span class="o">+=</span> <span class="s1">&#39;     &#39;</span>

                <span class="n">o</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.print_model"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.print_model">[docs]</a>    <span class="k">def</span> <span class="nf">print_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">):</span>

        <span class="n">o</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">o</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%-20s%8s%8s%7s%10s%10s%12s%5s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="s1">&#39;sourcename&#39;</span><span class="p">,</span> <span class="s1">&#39;offset&#39;</span><span class="p">,</span> <span class="s1">&#39;norm&#39;</span><span class="p">,</span> <span class="s1">&#39;eflux&#39;</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ts&#39;</span><span class="p">,</span> <span class="s1">&#39;npred&#39;</span><span class="p">,</span> <span class="s1">&#39;free&#39;</span><span class="p">)</span>
        <span class="n">o</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">diffuse</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">normVal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">normPar</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
            <span class="n">fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">fixedSpectrum</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">fixed</span><span class="p">:</span>
                <span class="n">free_str</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">free_str</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>

            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;SpectrumType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PowerLaw&#39;</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;dnde1000_index&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;dnde1000_index&#39;</span><span class="p">]</span> <span class="o">+</span>
                               <span class="n">s</span><span class="p">[</span><span class="s1">&#39;dnde10000_index&#39;</span><span class="p">])</span>

            <span class="n">o</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%-20.19s%8.3f%8.3f%10.3g%7.2f%10.2f%12.1f%5s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">s</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">],</span> <span class="n">normVal</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;eflux&#39;</span><span class="p">],</span> <span class="n">index</span><span class="p">,</span>
                <span class="n">s</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;npred&#39;</span><span class="p">],</span> <span class="n">free_str</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">diffuse</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">normVal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">normPar</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
            <span class="n">fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">fixedSpectrum</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">fixed</span><span class="p">:</span>
                <span class="n">free_str</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">free_str</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>

            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;SpectrumType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PowerLaw&#39;</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;dnde1000_index&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;dnde1000_index&#39;</span><span class="p">]</span> <span class="o">+</span>
                               <span class="n">s</span><span class="p">[</span><span class="s1">&#39;dnde10000_index&#39;</span><span class="p">])</span>

            <span class="n">o</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%-20.19s%8s%8.3f%10.3g%7.2f%10.2f%12.1f%5s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">s</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                <span class="s1">&#39;---&#39;</span><span class="p">,</span> <span class="n">normVal</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;eflux&#39;</span><span class="p">],</span> <span class="n">index</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;npred&#39;</span><span class="p">],</span> <span class="n">free_str</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.load_roi"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.load_roi">[docs]</a>    <span class="k">def</span> <span class="nf">load_roi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infile</span><span class="p">,</span> <span class="n">reload_sources</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function reloads the analysis state from a previously</span>
<span class="sd">        saved instance generated with</span>
<span class="sd">        `~fermipy.gtanalysis.GTAnalysis.write_roi`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        infile : str</span>

<span class="sd">        reload_sources : bool</span>
<span class="sd">           Regenerate source maps for non-diffuse sources.</span>

<span class="sd">        params : str</span>
<span class="sd">            Path to a yaml file with updated parameter values</span>
<span class="sd">        </span>
<span class="sd">        mask : str</span>
<span class="sd">            Path to a fits file with an updated mask</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">infile</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">resolve_path</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
        <span class="n">roi_file</span><span class="p">,</span> <span class="n">roi_data</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading ROI file: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">roi_file</span><span class="p">)</span>

        <span class="n">key_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dfde&#39;</span><span class="p">:</span> <span class="s1">&#39;dnde&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;dfde100&#39;</span><span class="p">:</span> <span class="s1">&#39;dnde100&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;dfde1000&#39;</span><span class="p">:</span> <span class="s1">&#39;dnde1000&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;dfde10000&#39;</span><span class="p">:</span> <span class="s1">&#39;dnde10000&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;dfde_index&#39;</span><span class="p">:</span> <span class="s1">&#39;dnde_index&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;dfde100_index&#39;</span><span class="p">:</span> <span class="s1">&#39;dnde100_index&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;dfde1000_index&#39;</span><span class="p">:</span> <span class="s1">&#39;dnde1000_index&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;dfde10000_index&#39;</span><span class="p">:</span> <span class="s1">&#39;dnde10000_index&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;e2dfde&#39;</span><span class="p">:</span> <span class="s1">&#39;e2dnde&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;e2dfde100&#39;</span><span class="p">:</span> <span class="s1">&#39;e2dnde100&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;e2dfde1000&#39;</span><span class="p">:</span> <span class="s1">&#39;e2dnde1000&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;e2dfde10000&#39;</span><span class="p">:</span> <span class="s1">&#39;e2dnde10000&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;Npred&#39;</span><span class="p">:</span> <span class="s1">&#39;npred&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;Npred_wt&#39;</span><span class="p">:</span> <span class="s1">&#39;npred_wt&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;logLike&#39;</span><span class="p">:</span> <span class="s1">&#39;loglike&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;dlogLike&#39;</span><span class="p">:</span> <span class="s1">&#39;dloglike&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;emin&#39;</span><span class="p">:</span> <span class="s1">&#39;e_min&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;ectr&#39;</span><span class="p">:</span> <span class="s1">&#39;e_ctr&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;emax&#39;</span><span class="p">:</span> <span class="s1">&#39;e_max&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;logemin&#39;</span><span class="p">:</span> <span class="s1">&#39;loge_min&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;logectr&#39;</span><span class="p">:</span> <span class="s1">&#39;loge_ctr&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;logemax&#39;</span><span class="p">:</span> <span class="s1">&#39;loge_max&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;ref_dfde&#39;</span><span class="p">:</span> <span class="s1">&#39;ref_dnde&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;ref_e2dfde&#39;</span><span class="p">:</span> <span class="s1">&#39;ref_e2dnde&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;ref_dfde_emin&#39;</span><span class="p">:</span> <span class="s1">&#39;ref_dnde_e_min&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;ref_dfde_emax&#39;</span><span class="p">:</span> <span class="s1">&#39;ref_dnde_e_max&#39;</span><span class="p">,</span>
                   <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_roi_data</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">update_keys</span><span class="p">(</span><span class="n">roi_data</span><span class="p">[</span><span class="s1">&#39;roi&#39;</span><span class="p">],</span> <span class="n">key_map</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;erange&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roi_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_roi_data</span><span class="p">[</span><span class="s1">&#39;loge_bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roi_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;erange&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_loge_bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roi_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;loge_bounds&#39;</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">loge_bounds</span><span class="p">)</span>

        <span class="n">sources</span> <span class="o">=</span> <span class="n">roi_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;sources&#39;</span><span class="p">)</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">update_keys</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">key_map</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k0</span><span class="p">,</span> <span class="n">v0</span> <span class="ow">in</span> <span class="n">sources</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">source_flux_output</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="nb">float</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="n">sources</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;_err&#39;</span><span class="p">]</span> \
                        <span class="o">=</span> <span class="n">v0</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">v0</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">load_sources</span><span class="p">(</span><span class="n">sources</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;src_expscale&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roi_data</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">_src_expscale</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_roi_data</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">]</span>
                                                <span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;src_expscale&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_create_likelihood</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_energy_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loge_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">loge_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_parameters_from_yaml</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_weights_map</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">update_roi</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reload_sources</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">sources</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">diffuse</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reload_sources</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Finished Loading ROI&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.write_roi"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.write_roi">[docs]</a>    <span class="k">def</span> <span class="nf">write_roi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">save_model_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write current state of the analysis to a file.  This method</span>
<span class="sd">        writes an XML model definition, a ROI dictionary, and a FITS</span>
<span class="sd">        source catalog file.  A previously saved analysis state can be</span>
<span class="sd">        reloaded from the ROI dictionary file with the</span>
<span class="sd">        `~fermipy.gtanalysis.GTAnalysis.load_roi` method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        outfile : str</span>
<span class="sd">            String prefix of the output files.  The extension of this</span>
<span class="sd">            string will be stripped when generating the XML, YAML and</span>
<span class="sd">            npy filenames.</span>

<span class="sd">        make_plots : bool</span>
<span class="sd">            Generate diagnostic plots.</span>

<span class="sd">        save_model_map : bool</span>
<span class="sd">            Save the current counts model to a FITS file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># extract the results in a convenient format</span>

        <span class="n">make_plots</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;make_plots&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">save_weight_map</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;save_weight_map&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pathprefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;workdir&#39;</span><span class="p">],</span>
                                      <span class="s1">&#39;results&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">outfile</span><span class="p">):</span>
            <span class="n">pathprefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;workdir&#39;</span><span class="p">],</span>
                                      <span class="n">outfile</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pathprefix</span> <span class="o">=</span> <span class="n">outfile</span>

        <span class="n">pathprefix</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">strip_suffix</span><span class="p">(</span><span class="n">pathprefix</span><span class="p">,</span>
                                        <span class="p">[</span><span class="s1">&#39;fits&#39;</span><span class="p">,</span> <span class="s1">&#39;yaml&#39;</span><span class="p">,</span> <span class="s1">&#39;npy&#39;</span><span class="p">])</span>
<span class="c1">#        pathprefix, ext = os.path.splitext(pathprefix)</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pathprefix</span><span class="p">)</span>

        <span class="n">xmlfile</span> <span class="o">=</span> <span class="n">pathprefix</span> <span class="o">+</span> <span class="s1">&#39;.xml&#39;</span>
        <span class="n">fitsfile</span> <span class="o">=</span> <span class="n">pathprefix</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
        <span class="n">npyfile</span> <span class="o">=</span> <span class="n">pathprefix</span> <span class="o">+</span> <span class="s1">&#39;.npy&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write_xml</span><span class="p">(</span><span class="n">xmlfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_fits</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;use_external_srcmap&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">saveSourceMaps</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmap&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">save_model_map</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_model_map</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_weight_map</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_weight_map</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>

        <span class="n">o</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;roi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_roi_data</span><span class="p">)</span>
        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fermipy</span><span class="o">.</span><span class="n">__version__</span>
        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;stversion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fermipy</span><span class="o">.</span><span class="n">get_st_version</span><span class="p">()</span>
        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">][</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">):</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;roi&#39;</span><span class="p">][</span><span class="s1">&#39;components&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span>
                <span class="s1">&#39;src_expscale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">src_expscale</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writing </span><span class="si">%s</span><span class="s1">...&#39;</span><span class="p">,</span> <span class="n">npyfile</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">npyfile</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">make_plots</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_plots</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plotting&#39;</span><span class="p">,</span> <span class="p">{}))</span></div>

<div class="viewcode-block" id="GTAnalysis.write_fits"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.write_fits">[docs]</a>    <span class="k">def</span> <span class="nf">write_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fitsfile</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writing </span><span class="si">%s</span><span class="s1">...&#39;</span><span class="p">,</span> <span class="n">fitsfile</span><span class="p">)</span>

        <span class="n">tab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">create_table</span><span class="p">()</span>
        <span class="n">hdu_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">table_to_hdu</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span>
        <span class="n">hdu_data</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;CATALOG&#39;</span>

        <span class="n">tab_srcs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tab_params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">):</span>
            <span class="n">tab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">create_source_table</span><span class="p">()</span>
            <span class="n">tab</span><span class="p">[</span><span class="s1">&#39;component&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">tab</span><span class="p">[</span><span class="s1">&#39;expscale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">src_expscale</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[</span><span class="s1">&#39;source_name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span>
                <span class="n">tab</span><span class="p">[</span><span class="s1">&#39;expscale&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

            <span class="n">tab_srcs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tab</span><span class="p">]</span>

            <span class="n">tab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">create_param_table</span><span class="p">()</span>
            <span class="n">tab</span><span class="p">[</span><span class="s1">&#39;component&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">tab_params</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tab</span><span class="p">]</span>

        <span class="kn">from</span> <span class="nn">astropy.table</span> <span class="k">import</span> <span class="n">vstack</span>

        <span class="n">hdu_srcs</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">table_to_hdu</span><span class="p">(</span><span class="n">vstack</span><span class="p">(</span><span class="n">tab_srcs</span><span class="p">))</span>
        <span class="n">hdu_srcs</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;SOURCES&#39;</span>
        <span class="n">hdu_params</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">table_to_hdu</span><span class="p">(</span><span class="n">vstack</span><span class="p">(</span><span class="n">tab_params</span><span class="p">))</span>
        <span class="n">hdu_params</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;PARAMS&#39;</span>
        <span class="n">hdu_roi</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">table_to_hdu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create_roi_table</span><span class="p">())</span>
        <span class="n">hdu_roi</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;ROI&#39;</span>

        <span class="n">hdus</span> <span class="o">=</span> <span class="p">[</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(),</span> <span class="n">hdu_data</span><span class="p">,</span> <span class="n">hdu_roi</span><span class="p">,</span> <span class="n">hdu_srcs</span><span class="p">,</span> <span class="n">hdu_params</span><span class="p">]</span>
        <span class="n">hdus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CONFIG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">hdus</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CONFIG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">fits_utils</span><span class="o">.</span><span class="n">write_hdus</span><span class="p">(</span><span class="n">hdus</span><span class="p">,</span> <span class="n">fitsfile</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.create_roi_table"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.create_roi_table">[docs]</a>    <span class="k">def</span> <span class="nf">create_roi_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">rd</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_roi_data</span><span class="p">)</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="n">fits_utils</span><span class="o">.</span><span class="n">dict_to_table</span><span class="p">(</span><span class="n">rd</span><span class="p">)</span>
        <span class="n">tab</span><span class="p">[</span><span class="s1">&#39;component&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">row_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rd</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">]):</span>
            <span class="n">c</span><span class="p">[</span><span class="s1">&#39;component&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">c</span><span class="p">[</span><span class="s1">&#39;loge_bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rd</span><span class="p">[</span><span class="s1">&#39;loge_bounds&#39;</span><span class="p">]</span>

            <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tab</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>

                <span class="n">shape</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">ndim</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span>
                <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">val</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="p">])]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>
            <span class="n">tab</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tab</span></div>

<div class="viewcode-block" id="GTAnalysis.make_plots"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.make_plots">[docs]</a>    <span class="k">def</span> <span class="nf">make_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">mcube_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make diagnostic plots using the current ROI model.&quot;&quot;&quot;</span>

        <span class="c1">#mcube_maps = kwargs.pop(&#39;mcube_maps&#39;, None)</span>
        <span class="k">if</span> <span class="n">mcube_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mcube_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_counts_map</span><span class="p">()</span>

        <span class="n">plotter</span> <span class="o">=</span> <span class="n">plotting</span><span class="o">.</span><span class="n">AnalysisPlotter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;plotting&#39;</span><span class="p">],</span>
                                           <span class="n">fileio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">],</span>
                                           <span class="n">logging</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;logging&#39;</span><span class="p">])</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mcube_map</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.curvature"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.curvature">[docs]</a>    <span class="k">def</span> <span class="nf">curvature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test whether a source shows spectral curvature by comparing</span>
<span class="sd">        the likelihood ratio of PowerLaw and LogParabola spectral</span>
<span class="sd">        models.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Source name.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>

        <span class="n">saved_state</span> <span class="o">=</span> <span class="n">LikelihoodState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">getSource</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

        <span class="n">old_spectrum</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span>
        <span class="n">old_pars</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">spectral_pars</span><span class="p">)</span>
        <span class="n">old_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;SpectrumType&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">old_type</span> <span class="o">!=</span> <span class="s1">&#39;PowerLaw&#39;</span><span class="p">:</span>

            <span class="n">dnde</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()(</span><span class="n">pyLike</span><span class="o">.</span><span class="n">dArg</span><span class="p">(</span><span class="mf">1000.</span><span class="p">))</span>
            <span class="n">value</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">scale_parameter</span><span class="p">(</span><span class="n">dnde</span><span class="p">)</span>
            <span class="n">pars0</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;Prefactor&#39;</span><span class="p">:</span>
                    <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="n">scale</span><span class="p">,</span>
                        <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mf">1E-5</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mf">1000.</span><span class="p">,</span> <span class="s1">&#39;free&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                <span class="s1">&#39;Index&#39;</span><span class="p">:</span>
                    <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                        <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span> <span class="s1">&#39;free&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
                <span class="s1">&#39;Scale&#39;</span><span class="p">:</span>
                    <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mf">1E3</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
                        <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mf">1E6</span><span class="p">,</span> <span class="s1">&#39;free&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_source_spectrum</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s1">&#39;PowerLaw&#39;</span><span class="p">,</span>
                                     <span class="n">spectrum_pars</span><span class="o">=</span><span class="n">pars0</span><span class="p">,</span>
                                     <span class="n">update_source</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">free_source</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="n">fit_pl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

        <span class="n">prefactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_param</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;Prefactor&#39;</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_param</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;Index&#39;</span><span class="p">)</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_param</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;Scale&#39;</span><span class="p">)</span>

        <span class="n">pars1</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;norm&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">prefactor</span><span class="p">),</span>
            <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">index</span><span class="p">),</span>
            <span class="s1">&#39;Eb&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">scale</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">pars1</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">][</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">pars1</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">][</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.0</span>
        <span class="n">pars1</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_source_spectrum</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s1">&#39;LogParabola&#39;</span><span class="p">,</span>
                                 <span class="n">spectrum_pars</span><span class="o">=</span><span class="n">pars1</span><span class="p">,</span>
                                 <span class="n">update_source</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">free_source</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="n">fit_lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_source_spectrum</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">old_type</span><span class="p">,</span>
                                 <span class="n">spectrum_pars</span><span class="o">=</span><span class="n">old_pars</span><span class="p">,</span>
                                 <span class="n">update_source</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">pars2</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Prefactor&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">prefactor</span><span class="p">),</span>
            <span class="s1">&#39;Index1&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">index</span><span class="p">),</span>
            <span class="s1">&#39;Cutoff&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mf">1E3</span><span class="p">,</span>
                       <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mf">1E4</span><span class="p">,</span> <span class="s1">&#39;free&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="s1">&#39;Index2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                       <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;free&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
            <span class="s1">&#39;Scale&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_source_spectrum</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s1">&#39;PLSuperExpCutoff&#39;</span><span class="p">,</span>
                                 <span class="n">spectrum_pars</span><span class="o">=</span><span class="n">pars2</span><span class="p">,</span>
                                 <span class="n">update_source</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">free_source</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="n">fit_ple</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

        <span class="c1"># Revert to initial spectral model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_source_spectrum</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">old_type</span><span class="p">,</span>
                                 <span class="n">spectrum_pars</span><span class="o">=</span><span class="n">old_pars</span><span class="p">,</span>
                                 <span class="n">update_source</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">saved_state</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

        <span class="n">lp_ts_curv</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">fit_lp</span><span class="p">[</span><span class="s1">&#39;loglike&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fit_pl</span><span class="p">[</span><span class="s1">&#39;loglike&#39;</span><span class="p">])</span>
        <span class="n">ple_ts_curv</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">fit_ple</span><span class="p">[</span><span class="s1">&#39;loglike&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fit_pl</span><span class="p">[</span><span class="s1">&#39;loglike&#39;</span><span class="p">])</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">MutableNamedTuple</span><span class="p">(</span><span class="n">ts_curv</span><span class="o">=</span><span class="n">lp_ts_curv</span><span class="p">,</span>
                              <span class="n">lp_ts_curv</span><span class="o">=</span><span class="n">lp_ts_curv</span><span class="p">,</span>
                              <span class="n">ple_ts_curv</span><span class="o">=</span><span class="n">ple_ts_curv</span><span class="p">,</span>
                              <span class="n">loglike_pl</span><span class="o">=</span><span class="n">fit_pl</span><span class="p">[</span><span class="s1">&#39;loglike&#39;</span><span class="p">],</span>
                              <span class="n">loglike_lp</span><span class="o">=</span><span class="n">fit_lp</span><span class="p">[</span><span class="s1">&#39;loglike&#39;</span><span class="p">],</span>
                              <span class="n">loglike_ple</span><span class="o">=</span><span class="n">fit_ple</span><span class="p">[</span><span class="s1">&#39;loglike&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;LogLike_PL: </span><span class="si">%12.3f</span><span class="s1"> LogLike_LP: </span><span class="si">%12.3f</span><span class="s1"> LogLike_PLE: </span><span class="si">%12.3f</span><span class="s1">&#39;</span><span class="p">,</span>
                         <span class="n">o</span><span class="o">.</span><span class="n">loglike_pl</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">loglike_lp</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">loglike_ple</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;TS_curv:        </span><span class="si">%.3f</span><span class="s1"> (LP)&#39;</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">lp_ts_curv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;TS_curv:        </span><span class="si">%.3f</span><span class="s1"> (PLE)&#39;</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">ple_ts_curv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">o</span></div>

<div class="viewcode-block" id="GTAnalysis.bowtie"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.bowtie">[docs]</a>    <span class="k">def</span> <span class="nf">bowtie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">loge</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a spectral uncertainty band (bowtie) for the given</span>
<span class="sd">        source.  This will create an uncertainty band on the</span>
<span class="sd">        differential flux as a function of energy by propagating the</span>
<span class="sd">        errors on the global fit parameters.  Note that this band only</span>
<span class="sd">        reflects the uncertainty for parameters that are currently</span>
<span class="sd">        free in the model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        name : str</span>
<span class="sd">           Source name.</span>

<span class="sd">        fd : FluxDensity</span>
<span class="sd">           Flux density object.  If this parameter is None then one</span>
<span class="sd">           will be created.</span>

<span class="sd">        loge : array-like</span>
<span class="sd">           Sequence of energies in log10(E/MeV) at which the flux band</span>
<span class="sd">           will be evaluated.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">loge</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logemin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logemax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">loge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">logemin</span><span class="p">,</span> <span class="n">logemax</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

        <span class="n">o</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;energies&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="o">**</span><span class="n">loge</span><span class="p">,</span>
             <span class="s1">&#39;log_energies&#39;</span><span class="p">:</span> <span class="n">loge</span><span class="p">,</span>
             <span class="s1">&#39;dnde&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loge</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
             <span class="s1">&#39;dnde_lo&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loge</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
             <span class="s1">&#39;dnde_hi&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loge</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
             <span class="s1">&#39;dnde_err&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loge</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
             <span class="s1">&#39;dnde_ferr&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loge</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
             <span class="s1">&#39;pivot_energy&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fd</span> <span class="o">=</span> <span class="n">FluxDensity</span><span class="o">.</span><span class="n">FluxDensity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to create FluxDensity&#39;</span><span class="p">,</span>
                              <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">o</span>

        <span class="n">dnde</span> <span class="o">=</span> <span class="p">[</span><span class="n">fd</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">loge</span><span class="p">]</span>
        <span class="n">dnde_err</span> <span class="o">=</span> <span class="p">[</span><span class="n">fd</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">loge</span><span class="p">]</span>

        <span class="n">dnde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dnde</span><span class="p">)</span>
        <span class="n">dnde_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dnde_err</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">dnde</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="n">fhi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dnde</span><span class="p">)</span>
        <span class="n">flo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dnde</span><span class="p">)</span>
        <span class="n">ferr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dnde</span><span class="p">)</span>

        <span class="n">fhi</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">dnde</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">dnde_err</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">/</span> <span class="n">dnde</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
        <span class="n">flo</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">dnde</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">dnde_err</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">/</span> <span class="n">dnde</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
        <span class="n">ferr</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">fhi</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">-</span> <span class="n">flo</span><span class="p">[</span><span class="n">m</span><span class="p">])</span> <span class="o">/</span> <span class="n">dnde</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
        <span class="n">fhi</span><span class="p">[</span><span class="o">~</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">dnde_err</span><span class="p">[</span><span class="o">~</span><span class="n">m</span><span class="p">]</span>

        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;dnde&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dnde</span>
        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;dnde_lo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flo</span>
        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;dnde_hi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fhi</span>
        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;dnde_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dnde_err</span>
        <span class="n">o</span><span class="p">[</span><span class="s1">&#39;dnde_ferr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ferr</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;pivot_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">utils</span><span class="o">.</span><span class="n">interpolate_function_min</span><span class="p">(</span><span class="n">loge</span><span class="p">,</span> <span class="n">o</span><span class="p">[</span>
                                                                     <span class="s1">&#39;dnde_ferr&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to compute pivot energy&#39;</span><span class="p">,</span>
                              <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">o</span></div>

    <span class="k">def</span> <span class="nf">_coadd_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmaps</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">wmaps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ccube</span> <span class="o">=</span> <span class="n">skymap</span><span class="o">.</span><span class="n">coadd_maps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">cmaps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wcube</span> <span class="o">=</span> <span class="n">skymap</span><span class="o">.</span><span class="n">coadd_maps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">wmaps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ccube</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ccube&#39;</span><span class="p">],</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="s1">&#39;fgst-ccube&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projtype</span> <span class="o">==</span> <span class="s2">&quot;WCS&quot;</span><span class="p">:</span>
            <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;counts&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ccube</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                   <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;counts_wt&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ccube</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wcube</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                      <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">projtype</span> <span class="o">==</span> <span class="s2">&quot;HPX&quot;</span><span class="p">:</span>
            <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;counts&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ccube</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">rm</span><span class="p">[</span><span class="s1">&#39;counts_wt&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ccube</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wcube</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                      <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Did not recognize projection type </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">projtype</span><span class="p">)</span>

<div class="viewcode-block" id="GTAnalysis.update_source"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.update_source">[docs]</a>    <span class="k">def</span> <span class="nf">update_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">paramsonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reoptimize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the dictionary for this source.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        name : str</span>

<span class="sd">        paramsonly : bool</span>

<span class="sd">        reoptimize : bool</span>
<span class="sd">           Re-fit background parameters in likelihood scan.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">npts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;llscan_npts&#39;</span><span class="p">]</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;optimizer&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">])</span>

        <span class="n">sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_src_model</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">paramsonly</span><span class="p">,</span> <span class="n">reoptimize</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span>
                                <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">)</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">src</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTAnalysis.get_src_model"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.get_src_model">[docs]</a>    <span class="k">def</span> <span class="nf">get_src_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">paramsonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reoptimize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">npts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compose a dictionary for a source with the current best-fit</span>
<span class="sd">        parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        name : str</span>

<span class="sd">        paramsonly : bool</span>
<span class="sd">           Skip computing TS and likelihood profile.</span>

<span class="sd">        reoptimize : bool</span>
<span class="sd">           Re-fit background parameters in likelihood scan.</span>

<span class="sd">        npts : int</span>
<span class="sd">           Number of points for likelihood scan.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        src_dict : dict</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Generating source dict for &#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>

        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;optimizer&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">npts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">npts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;llscan_npts&#39;</span><span class="p">]</span>

        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">src</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span>
        <span class="n">normPar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">normPar</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="n">src_dict</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">make_default_dict</span><span class="p">(</span><span class="n">defaults</span><span class="o">.</span><span class="n">source_flux_output</span><span class="p">)</span>
        <span class="n">src_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                         <span class="s1">&#39;pivot_energy&#39;</span><span class="p">:</span> <span class="mf">1000.</span><span class="p">,</span>
                         <span class="s1">&#39;ts&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                         <span class="s1">&#39;loglike&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                         <span class="s1">&#39;npred&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                         <span class="s1">&#39;npred_wt&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                         <span class="s1">&#39;loglike_scan&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">npts</span><span class="p">),</span>
                         <span class="s1">&#39;dloglike_scan&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">npts</span><span class="p">),</span>
                         <span class="s1">&#39;eflux_scan&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">npts</span><span class="p">),</span>
                         <span class="s1">&#39;flux_scan&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">npts</span><span class="p">),</span>
                         <span class="s1">&#39;norm_scan&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">npts</span><span class="p">),</span>
                         <span class="p">})</span>

        <span class="n">src_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">gtutils</span><span class="o">.</span><span class="n">gtlike_spectrum_to_vectors</span><span class="p">(</span><span class="n">spectrum</span><span class="p">))</span>
        <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;spectral_pars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gtutils</span><span class="o">.</span><span class="n">get_function_pars_dict</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>

        <span class="c1"># Get Counts Spectrum</span>
        <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;model_counts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_counts_spectrum</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">summed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;model_counts_wt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_counts_spectrum</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">summed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">weighted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Get NPred</span>
        <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;npred&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">NpredValue</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="c1"># EAC, we need this b/c older version of the ST don&#39;t have the right signature</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;npred_wt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">NpredValue</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">NotImplementedError</span><span class="p">):</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;npred_wt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;npred&#39;</span><span class="p">]</span>

        <span class="c1"># Get the Model Fluxes</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">thesrc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">flux</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;flux100&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">flux</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mf">100.</span><span class="p">,</span> <span class="mi">10</span> <span class="o">**</span> <span class="mf">5.5</span><span class="p">)</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;flux1000&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">flux</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mf">1000.</span><span class="p">,</span> <span class="mi">10</span> <span class="o">**</span> <span class="mf">5.5</span><span class="p">)</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;flux10000&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">flux</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mf">10000.</span><span class="p">,</span> <span class="mi">10</span> <span class="o">**</span> <span class="mf">5.5</span><span class="p">)</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;eflux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">energyFlux</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;eflux100&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">energyFlux</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mf">100.</span><span class="p">,</span>
                                                        <span class="mi">10</span> <span class="o">**</span> <span class="mf">5.5</span><span class="p">)</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;eflux1000&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">energyFlux</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mf">1000.</span><span class="p">,</span>
                                                         <span class="mi">10</span> <span class="o">**</span> <span class="mf">5.5</span><span class="p">)</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;eflux10000&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">energyFlux</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mf">10000.</span><span class="p">,</span>
                                                          <span class="mi">10</span> <span class="o">**</span> <span class="mf">5.5</span><span class="p">)</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;dnde&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()(</span>
                <span class="n">pyLike</span><span class="o">.</span><span class="n">dArg</span><span class="p">(</span><span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;pivot_energy&#39;</span><span class="p">]))</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;dnde100&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()(</span>
                <span class="n">pyLike</span><span class="o">.</span><span class="n">dArg</span><span class="p">(</span><span class="mf">100.</span><span class="p">))</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;dnde1000&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()(</span>
                <span class="n">pyLike</span><span class="o">.</span><span class="n">dArg</span><span class="p">(</span><span class="mf">1000.</span><span class="p">))</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;dnde10000&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()(</span>
                <span class="n">pyLike</span><span class="o">.</span><span class="n">dArg</span><span class="p">(</span><span class="mf">10000.</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">normPar</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">normPar</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

                <span class="n">dnde_index</span> <span class="o">=</span> <span class="o">-</span><span class="n">get_spectral_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                                                 <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;pivot_energy&#39;</span><span class="p">])</span>

                <span class="n">dnde100_index</span> <span class="o">=</span> <span class="o">-</span><span class="n">get_spectral_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                                                    <span class="mf">100.</span><span class="p">)</span>
                <span class="n">dnde1000_index</span> <span class="o">=</span> <span class="o">-</span><span class="n">get_spectral_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                                                     <span class="mf">1000.</span><span class="p">)</span>
                <span class="n">dnde10000_index</span> <span class="o">=</span> <span class="o">-</span><span class="n">get_spectral_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                                                      <span class="mf">10000.</span><span class="p">)</span>

                <span class="n">normPar</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dnde_index</span> <span class="o">=</span> <span class="o">-</span><span class="n">get_spectral_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                                                 <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;pivot_energy&#39;</span><span class="p">])</span>

                <span class="n">dnde100_index</span> <span class="o">=</span> <span class="o">-</span><span class="n">get_spectral_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                                                    <span class="mf">100.</span><span class="p">)</span>
                <span class="n">dnde1000_index</span> <span class="o">=</span> <span class="o">-</span><span class="n">get_spectral_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                                                     <span class="mf">1000.</span><span class="p">)</span>
                <span class="n">dnde10000_index</span> <span class="o">=</span> <span class="o">-</span><span class="n">get_spectral_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                                                      <span class="mf">10000.</span><span class="p">)</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;dnde_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dnde_index</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;dnde100_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dnde100_index</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;dnde1000_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dnde1000_index</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;dnde10000_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dnde10000_index</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to update source parameters.&#39;</span><span class="p">,</span>
                              <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Only compute TS, errors, and ULs if the source was free in</span>
        <span class="c1"># the fit</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_free_source_params</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="n">paramsonly</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">src_dict</span>

        <span class="n">emax</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="mf">5.5</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;flux_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">fluxError</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;flux100_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">fluxError</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mf">100.</span><span class="p">,</span> <span class="n">emax</span><span class="p">)</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;flux1000_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">fluxError</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mf">1000.</span><span class="p">,</span> <span class="n">emax</span><span class="p">)</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;flux10000_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">fluxError</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mf">10000.</span><span class="p">,</span> <span class="n">emax</span><span class="p">)</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;eflux_err&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">energyFluxError</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;eflux100_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">energyFluxError</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mf">100.</span><span class="p">,</span>
                                                                 <span class="n">emax</span><span class="p">)</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;eflux1000_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">energyFluxError</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mf">1000.</span><span class="p">,</span>
                                                                  <span class="n">emax</span><span class="p">)</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;eflux10000_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">energyFluxError</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mf">10000.</span><span class="p">,</span>
                                                                   <span class="n">emax</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># self.logger.error(&#39;Failed to update source parameters.&#39;,</span>
        <span class="c1">#  exc_info=True)</span>
        <span class="n">lnlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_norm</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">savestate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">reoptimize</span><span class="o">=</span><span class="n">reoptimize</span><span class="p">,</span> <span class="n">npts</span><span class="o">=</span><span class="n">npts</span><span class="p">,</span>
                                 <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">)</span>

        <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;loglike_scan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lnlp</span><span class="p">[</span><span class="s1">&#39;loglike&#39;</span><span class="p">]</span>
        <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;dloglike_scan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lnlp</span><span class="p">[</span><span class="s1">&#39;dloglike&#39;</span><span class="p">]</span>
        <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;eflux_scan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lnlp</span><span class="p">[</span><span class="s1">&#39;eflux&#39;</span><span class="p">]</span>
        <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;flux_scan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lnlp</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>
        <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;norm_scan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lnlp</span><span class="p">[</span><span class="s1">&#39;xvals&#39;</span><span class="p">]</span>
        <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;loglike&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lnlp</span><span class="p">[</span><span class="s1">&#39;loglike&#39;</span><span class="p">])</span>

        <span class="n">flux_ul_data</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_parameter_limits</span><span class="p">(</span>
            <span class="n">lnlp</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">],</span> <span class="n">lnlp</span><span class="p">[</span><span class="s1">&#39;dloglike&#39;</span><span class="p">])</span>
        <span class="n">eflux_ul_data</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_parameter_limits</span><span class="p">(</span>
            <span class="n">lnlp</span><span class="p">[</span><span class="s1">&#39;eflux&#39;</span><span class="p">],</span> <span class="n">lnlp</span><span class="p">[</span><span class="s1">&#39;dloglike&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">normPar</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">normPar</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">flux</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">flux100</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">flux</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mf">100.</span><span class="p">,</span> <span class="n">emax</span><span class="p">)</span>
            <span class="n">flux1000</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">flux</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mf">1000.</span><span class="p">,</span> <span class="n">emax</span><span class="p">)</span>
            <span class="n">flux10000</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">flux</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mf">10000.</span><span class="p">,</span> <span class="n">emax</span><span class="p">)</span>
            <span class="n">eflux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">energyFlux</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">eflux100</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">energyFlux</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mf">100.</span><span class="p">,</span> <span class="n">emax</span><span class="p">)</span>
            <span class="n">eflux1000</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">energyFlux</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mf">1000.</span><span class="p">,</span> <span class="n">emax</span><span class="p">)</span>
            <span class="n">eflux10000</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">energyFlux</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mf">10000.</span><span class="p">,</span> <span class="n">emax</span><span class="p">)</span>

            <span class="n">flux100_ratio</span> <span class="o">=</span> <span class="n">flux100</span> <span class="o">/</span> <span class="n">flux</span>
            <span class="n">flux1000_ratio</span> <span class="o">=</span> <span class="n">flux1000</span> <span class="o">/</span> <span class="n">flux</span>
            <span class="n">flux10000_ratio</span> <span class="o">=</span> <span class="n">flux10000</span> <span class="o">/</span> <span class="n">flux</span>
            <span class="n">eflux100_ratio</span> <span class="o">=</span> <span class="n">eflux100</span> <span class="o">/</span> <span class="n">eflux</span>
            <span class="n">eflux1000_ratio</span> <span class="o">=</span> <span class="n">eflux1000</span> <span class="o">/</span> <span class="n">eflux</span>
            <span class="n">eflux10000_ratio</span> <span class="o">=</span> <span class="n">eflux10000</span> <span class="o">/</span> <span class="n">eflux</span>
            <span class="n">normPar</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flux100_ratio</span> <span class="o">=</span> <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;flux100&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>
            <span class="n">flux1000_ratio</span> <span class="o">=</span> <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;flux1000&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>
            <span class="n">flux10000_ratio</span> <span class="o">=</span> <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;flux10000&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>

            <span class="n">eflux100_ratio</span> <span class="o">=</span> <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;eflux100&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;eflux&#39;</span><span class="p">]</span>
            <span class="n">eflux1000_ratio</span> <span class="o">=</span> <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;eflux1000&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;eflux&#39;</span><span class="p">]</span>
            <span class="n">eflux10000_ratio</span> <span class="o">=</span> <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;eflux10000&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;eflux&#39;</span><span class="p">]</span>

        <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;flux_ul95&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux_ul_data</span><span class="p">[</span><span class="s1">&#39;ul&#39;</span><span class="p">]</span>
        <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;flux100_ul95&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux_ul_data</span><span class="p">[</span><span class="s1">&#39;ul&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">flux100_ratio</span>
        <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;flux1000_ul95&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux_ul_data</span><span class="p">[</span><span class="s1">&#39;ul&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">flux1000_ratio</span>
        <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;flux10000_ul95&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux_ul_data</span><span class="p">[</span><span class="s1">&#39;ul&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">flux10000_ratio</span>

        <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;eflux_ul95&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eflux_ul_data</span><span class="p">[</span><span class="s1">&#39;ul&#39;</span><span class="p">]</span>
        <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;eflux100_ul95&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eflux_ul_data</span><span class="p">[</span><span class="s1">&#39;ul&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">eflux100_ratio</span>
        <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;eflux1000_ul95&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eflux_ul_data</span><span class="p">[</span><span class="s1">&#39;ul&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">eflux1000_ratio</span>
        <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;eflux10000_ul95&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eflux_ul_data</span><span class="p">[</span><span class="s1">&#39;ul&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">eflux10000_ratio</span>

        <span class="c1"># Extract covariance matrix</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">FluxDensity</span><span class="o">.</span><span class="n">FluxDensity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;covar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">covar</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># if ex.message == &#39;Covariance matrix has not been</span>
        <span class="c1"># computed.&#39;:</span>

        <span class="c1"># Extract bowtie</span>
        <span class="k">if</span> <span class="n">fd</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;covar&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;covar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">loge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">50</span><span class="p">)</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;model_flux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bowtie</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fd</span><span class="o">=</span><span class="n">fd</span><span class="p">,</span> <span class="n">loge</span><span class="o">=</span><span class="n">loge</span><span class="p">)</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;dnde100_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mf">100.</span><span class="p">)</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;dnde1000_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mf">1000.</span><span class="p">)</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;dnde10000_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mf">10000.</span><span class="p">)</span>

            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;pivot_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;model_flux&#39;</span><span class="p">][</span><span class="s1">&#39;pivot_energy&#39;</span><span class="p">]</span>

            <span class="n">e0</span> <span class="o">=</span> <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;pivot_energy&#39;</span><span class="p">]</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;dnde&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()(</span><span class="n">pyLike</span><span class="o">.</span><span class="n">dArg</span><span class="p">(</span><span class="n">e0</span><span class="p">))</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;dnde_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">reoptimize</span><span class="p">:</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">Ts2</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">reoptimize</span><span class="o">=</span><span class="n">reoptimize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">src_dict</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">lnlp</span><span class="p">[</span><span class="s1">&#39;dloglike&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">src_dict</span></div>

<div class="viewcode-block" id="GTAnalysis.compute_srcprob"><a class="viewcode-back" href="../../fermipy.html#fermipy.gtanalysis.GTAnalysis.compute_srcprob">[docs]</a>    <span class="k">def</span> <span class="nf">compute_srcprob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">xmlfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the gtsrcprob app with the current model or a user provided xmlfile&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">):</span>
            <span class="c1"># compute diffuse response, necessary for srcprob</span>
            <span class="n">c</span><span class="o">.</span><span class="n">_diffrsp_app</span><span class="p">(</span><span class="n">xmlfile</span><span class="o">=</span><span class="n">xmlfile</span><span class="p">)</span>
            <span class="c1"># compute srcprob</span>
            <span class="n">c</span><span class="o">.</span><span class="n">_srcprob_app</span><span class="p">(</span><span class="n">xmlfile</span> <span class="o">=</span> <span class="n">xmlfile</span><span class="p">,</span> <span class="n">overwrite</span> <span class="o">=</span> <span class="n">overwrite</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">GTBinnedAnalysis</span><span class="p">(</span><span class="n">fermipy</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Configurable</span><span class="p">):</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">selection</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span>
                    <span class="n">binning</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">binning</span><span class="p">,</span>
                    <span class="n">ltcube</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">ltcube</span><span class="p">,</span>
                    <span class="n">gtlike</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">gtlike</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                    <span class="n">logging</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">logging</span><span class="p">,</span>
                    <span class="n">fileio</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">fileio</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;00&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
                    <span class="n">file_suffix</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_loglevel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;loglevel&#39;</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">GTBinnedAnalysis</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_projtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;projtype&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;logging&#39;</span><span class="p">][</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="n">Logger</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;logfile&#39;</span><span class="p">],</span>
                         <span class="n">log_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;logging&#39;</span><span class="p">][</span><span class="s1">&#39;verbosity&#39;</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_roi</span> <span class="o">=</span> <span class="n">roi</span>
        <span class="n">workdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;workdir&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

        <span class="n">search_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">workdir</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Set default file names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="s1">&#39;ft1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ft1</span><span class="si">%s</span><span class="s1">.fits&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="s1">&#39;ft1_filtered&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ft1_filtered</span><span class="si">%s</span><span class="s1">.fits&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="s1">&#39;ccube&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ccube</span><span class="si">%s</span><span class="s1">.fits&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="s1">&#39;ccubemc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ccubemc</span><span class="si">%s</span><span class="s1">.fits&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="s1">&#39;srcmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;srcmap</span><span class="si">%s</span><span class="s1">.fits&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="s1">&#39;bexpmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bexpmap</span><span class="si">%s</span><span class="s1">.fits&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="s1">&#39;bexpmap_roi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bexpmap_roi</span><span class="si">%s</span><span class="s1">.fits&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="s1">&#39;srcmdl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;srcmdl</span><span class="si">%s</span><span class="s1">.xml&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="s1">&#39;ltcube&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ltcube</span><span class="si">%s</span><span class="s1">.fits&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">v</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;file_suffix&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="c1"># Override files defined in gtlike</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;srcmap&#39;</span><span class="p">,</span> <span class="s1">&#39;bexpmap&#39;</span><span class="p">,</span> <span class="s1">&#39;bexpmap_roi&#39;</span><span class="p">]:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolve_file_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">],</span>
                                               <span class="n">search_dirs</span><span class="o">=</span><span class="n">search_dirs</span><span class="p">,</span>
                                               <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data_files</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_files</span><span class="p">[</span><span class="s1">&#39;evfile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;evfile&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_files</span><span class="p">[</span><span class="s1">&#39;scfile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;scfile&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_fits_file</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data_files</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">utils</span><span class="o">.</span><span class="n">resolve_file_path_list</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span>
                                                 <span class="n">prefix</span><span class="o">=</span><span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data_files</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_srcmap_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srcmap</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Fill dictionary of exposure corrections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_src_expscale</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;expscale&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_src_expscale</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;expscale&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;src_expscale&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;src_expscale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_src_expscale</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="c1"># Setup external LT cube</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ext_ltcube</span> <span class="o">=</span> <span class="n">resolve_file_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;ltcube&#39;</span><span class="p">],</span>
                                             <span class="n">search_dirs</span><span class="o">=</span><span class="n">search_dirs</span><span class="p">,</span>
                                             <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ext_ltcube</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ltcube&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ext_ltcube</span>

        <span class="c1"># Setup weights map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="s1">&#39;wmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolve_file_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;wmap&#39;</span><span class="p">],</span>
                                                <span class="n">search_dirs</span><span class="o">=</span><span class="n">search_dirs</span><span class="p">,</span>
                                                <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">emin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;emin&#39;</span><span class="p">]</span>
            <span class="n">emax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;emax&#39;</span><span class="p">]</span>
            <span class="n">logemin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">emin</span><span class="p">)</span>
            <span class="n">logemax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">emax</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">logemin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;logemin&#39;</span><span class="p">]</span>
            <span class="n">logemax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;logemax&#39;</span><span class="p">]</span>
            <span class="n">emin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">logemin</span><span class="p">)</span>
            <span class="n">emax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">logemax</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;logemin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">logemin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;logemax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">logemax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;emin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">emin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;emax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">emax</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;enumbins&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_enumbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;enumbins&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_enumbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;binsperdec&#39;</span><span class="p">]</span> <span class="o">*</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">emax</span> <span class="o">/</span> <span class="n">emin</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_enumbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_enumbins</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ebin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">logemin</span><span class="p">,</span> <span class="n">logemax</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_enumbins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ebin_center</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ebin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ebin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;npix&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">roiwidth</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;roiwidth&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;roiwidth&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">360.</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_npix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">roiwidth</span> <span class="o">/</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;binsz&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_npix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;npix&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npix</span> <span class="o">*</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;binsz&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;Automatically setting selection radius to </span><span class="si">%s</span><span class="s1"> deg&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;coordsys&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CEL&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xref</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">skydir</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_yref</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">skydir</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;coordsys&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;GAL&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xref</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">skydir</span><span class="o">.</span><span class="n">galactic</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_yref</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">skydir</span><span class="o">.</span><span class="n">galactic</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unrecognized coord system: &#39;</span> <span class="o">+</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;coordsys&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_like</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coordsys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;coordsys&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;tmin&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;tmax&#39;</span><span class="p">]</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">MapAxis</span><span class="o">.</span><span class="n">from_edges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span>
                                   <span class="n">name</span><span class="o">=</span><span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;MeV&#39;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projtype</span> <span class="o">==</span> <span class="s1">&#39;HPX&#39;</span><span class="p">:</span>
            <span class="n">is_nested</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;hpx_ordering_scheme&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;NESTED&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_geom</span> <span class="o">=</span> <span class="n">HpxGeom</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;hpx_order&#39;</span><span class="p">],</span>
                                        <span class="n">nest</span><span class="o">=</span><span class="n">is_nested</span><span class="p">,</span>
                                        <span class="n">coordsys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;coordsys&#39;</span><span class="p">],</span>
                                        <span class="n">width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;roiwidth&#39;</span><span class="p">],</span>
                                        <span class="n">skydir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">skydir</span><span class="p">,</span>
                                        <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">projtype</span> <span class="o">==</span> <span class="s2">&quot;WCS&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_geom</span> <span class="o">=</span> <span class="n">WcsGeom</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">npix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">npix</span><span class="p">,</span> <span class="n">binsz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">binsz</span><span class="p">,</span>
                                        <span class="n">coordsys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;coordsys&#39;</span><span class="p">],</span>
                                        <span class="n">proj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;proj&#39;</span><span class="p">],</span>
                                        <span class="n">skydir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">skydir</span><span class="p">,</span>
                                        <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Did not recognize projection type </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">projtype</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">print_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the default loglevel.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger_name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">loglevel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the default loglevel.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loglevel</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">workdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the analysis working directory.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;workdir&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">roi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roi</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">like</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_like</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">energies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the energy bin edges in MeV.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">10</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_ebin_edges</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_energies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the energy bin edges in log10(E/MeV).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ebin_edges</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">enumbins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ebin_edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">npix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_npix</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">binsz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;binsz&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">roiwidth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_npix</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;binsz&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">projtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the type of projection to use&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_projtype</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">geom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ROI geometry.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geom</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tmin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the MET time for the start of the observation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmin</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tmax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the MET time for the end of the observation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmax</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">geom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geom</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">wcs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projtype</span> <span class="o">==</span> <span class="s2">&quot;WCS&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">wcs</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hpx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projtype</span> <span class="o">==</span> <span class="s2">&quot;HPX&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coordsys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordsys</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_files</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">src_expscale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_expscale</span>

    <span class="k">def</span> <span class="nf">reload_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Recompute the source map for a single source in the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="p">,</span> <span class="s1">&#39;loadSourceMap&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">loadSourceMap</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">srcmap_utils</span><span class="o">.</span><span class="n">delete_source_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmap&#39;</span><span class="p">],</span> <span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">saveSourceMaps</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmap&#39;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scale_srcmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_expscale</span><span class="p">,</span> <span class="n">check_header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">buildFixedModelWts</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_xml</span><span class="p">(</span><span class="s1">&#39;tmp&#39;</span><span class="p">)</span>
            <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_source</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_source</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_xml</span><span class="p">(</span><span class="s1">&#39;tmp&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reload_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Recompute the source map for a list of sources in the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">loadSourceMaps</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="c1"># loadSourceMaps doesn&#39;t overwrite the header so we need</span>
            <span class="c1"># to ignore EXPSCALE by setting check_header=False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scale_srcmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_expscale</span><span class="p">,</span> <span class="n">check_header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reload_source</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">src_dict</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_source_maps</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">use_pylike</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_single_psf</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a new source to the model.  Source properties</span>
<span class="sd">        (spectrum, spatial model) are set with the src_dict argument.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        name : str</span>
<span class="sd">            Source name.</span>

<span class="sd">        src_dict : dict or `~fermipy.roi_model.Source` object</span>
<span class="sd">            Dictionary or Source object defining the properties of the</span>
<span class="sd">            source.</span>

<span class="sd">        free : bool</span>
<span class="sd">            Initialize the source with the normalization parameter free.</span>

<span class="sd">        save_source_maps : bool</span>
<span class="sd">            Write the source map for this source to the source maps file.</span>

<span class="sd">        use_pylike : bool</span>

<span class="sd">        use_single_psf : bool</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># if self.roi.has_source(name):</span>
        <span class="c1">#    msg = &#39;Source %s already exists.&#39; % name</span>
        <span class="c1">#    self.logger.error(msg)</span>
        <span class="c1">#    raise Exception(msg)</span>

        <span class="n">srcmap_utils</span><span class="o">.</span><span class="n">delete_source_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmap&#39;</span><span class="p">],</span> <span class="n">name</span><span class="p">)</span>

        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;expscale&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_expscale</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_src_expscale</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;expscale&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_like</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_pylike</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_srcmap_file</span><span class="p">([</span><span class="n">src</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">pylike_src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_source</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

        <span class="c1"># Initialize source as free/fixed</span>
        <span class="k">if</span> <span class="n">free</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pylike_src</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">normPar</span><span class="p">()</span><span class="o">.</span><span class="n">setFree</span><span class="p">(</span><span class="n">free</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pyLike</span><span class="p">,</span> <span class="s1">&#39;PsfIntegConfig&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">pyLike</span><span class="o">.</span><span class="n">PsfIntegConfig</span><span class="p">,</span> <span class="s1">&#39;set_use_single_psf&#39;</span><span class="p">):</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">BinnedLikeConfig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">config</span><span class="p">())</span>
            <span class="n">config</span><span class="o">.</span><span class="n">psf_integ_config</span><span class="p">()</span><span class="o">.</span><span class="n">set_use_single_psf</span><span class="p">(</span><span class="n">use_single_psf</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">addSource</span><span class="p">(</span><span class="n">pylike_src</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">addSource</span><span class="p">(</span><span class="n">pylike_src</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">syncSrcParams</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">buildFixedModelWts</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">save_source_maps</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;use_external_srcmap&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">saveSourceMaps</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmap&#39;</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_exposure_scale</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a pyLikelihood Source object from a</span>
<span class="sd">        `~fermipy.roi_model.Model` object.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpatialType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SkyDirFunction&#39;</span><span class="p">:</span>
            <span class="n">pylike_src</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">PointSource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">observation</span><span class="p">())</span>
            <span class="n">pylike_src</span><span class="o">.</span><span class="n">setDir</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">skydir</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">skydir</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpatialType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SpatialMap&#39;</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">path_to_xmlpath</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;Spatial_Filename&#39;</span><span class="p">]))</span>
            <span class="n">sm</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">SpatialMap</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="n">pylike_src</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">DiffuseSource</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">observation</span><span class="p">(),</span>
                                              <span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpatialType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;RadialProfile&#39;</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">path_to_xmlpath</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;Spatial_Filename&#39;</span><span class="p">]))</span>
            <span class="n">sm</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">RadialProfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="n">sm</span><span class="o">.</span><span class="n">setCenter</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">])</span>
            <span class="n">pylike_src</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">DiffuseSource</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">observation</span><span class="p">(),</span>
                                              <span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpatialType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;RadialGaussian&#39;</span><span class="p">:</span>
            <span class="n">sm</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">RadialGaussian</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">skydir</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">skydir</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                                       <span class="n">src</span><span class="o">.</span><span class="n">spatial_pars</span><span class="p">[</span><span class="s1">&#39;Sigma&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
            <span class="n">pylike_src</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">DiffuseSource</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">observation</span><span class="p">(),</span>
                                              <span class="kc">False</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpatialType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;RadialDisk&#39;</span><span class="p">:</span>
            <span class="n">sm</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">RadialDisk</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">skydir</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">skydir</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                                   <span class="n">src</span><span class="o">.</span><span class="n">spatial_pars</span><span class="p">[</span><span class="s1">&#39;Radius&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
            <span class="n">pylike_src</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">DiffuseSource</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">observation</span><span class="p">(),</span>
                                              <span class="kc">False</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpatialType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MapCubeFunction&#39;</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">path_to_xmlpath</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;Spatial_Filename&#39;</span><span class="p">]))</span>
            <span class="n">mcf</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">MapCubeFunction2</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="n">pylike_src</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">DiffuseSource</span><span class="p">(</span><span class="n">mcf</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">observation</span><span class="p">(),</span>
                                              <span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unrecognized spatial type: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                            <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpatialType&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpectrumType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FileFunction&#39;</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">gtutils</span><span class="o">.</span><span class="n">create_spectrum_from_dict</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpectrumType&#39;</span><span class="p">],</span>
                                                   <span class="n">src</span><span class="o">.</span><span class="n">spectral_pars</span><span class="p">)</span>

            <span class="n">file_function</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">FileFunction_cast</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;Spectrum_Filename&#39;</span><span class="p">]))</span>
            <span class="n">file_function</span><span class="o">.</span><span class="n">readFunction</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpectrumType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;DMFitFunction&#39;</span><span class="p">:</span>

            <span class="n">fn</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">DMFitFunction</span><span class="p">()</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">gtutils</span><span class="o">.</span><span class="n">create_spectrum_from_dict</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpectrumType&#39;</span><span class="p">],</span>
                                                   <span class="n">src</span><span class="o">.</span><span class="n">spectral_pars</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;Spectrum_Filename&#39;</span><span class="p">]))</span>
            <span class="n">fn</span><span class="o">.</span><span class="n">readFunction</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">gtutils</span><span class="o">.</span><span class="n">create_spectrum_from_dict</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpectrumType&#39;</span><span class="p">],</span>
                                                   <span class="n">src</span><span class="o">.</span><span class="n">spectral_pars</span><span class="p">)</span>

        <span class="n">pylike_src</span><span class="o">.</span><span class="n">setSpectrum</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">pylike_src</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">pylike_src</span>

    <span class="k">def</span> <span class="nf">delete_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">save_template</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">delete_source_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">build_fixed_wts</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Deleting source </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">normPar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">normPar</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">isFree</span> <span class="o">=</span> <span class="n">normPar</span><span class="o">.</span><span class="n">isFree</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">sourceNames</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">deleteSource</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">eraseSourceMap</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">isFree</span> <span class="ow">and</span> <span class="n">build_fixed_wts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">buildFixedModelWts</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">save_template</span> <span class="ow">and</span>
            <span class="n">src</span><span class="p">[</span><span class="s1">&#39;Spatial_Filename&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;Spatial_Filename&#39;</span><span class="p">])</span> <span class="ow">and</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;Spatial_Filename&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;workdir&#39;</span><span class="p">]):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="s1">&#39;Spatial_Filename&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">delete_source_map</span><span class="p">:</span>
            <span class="n">srcmap_utils</span><span class="o">.</span><span class="n">delete_source_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmap&#39;</span><span class="p">],</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">src</span>

    <span class="k">def</span> <span class="nf">set_exposure_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the exposure correction of a source.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Source name.</span>

<span class="sd">        scale : factor</span>
<span class="sd">            Exposure scale factor (1.0 = nominal exposure).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_expscale</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_expscale</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_src_expscale</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale_srcmap</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">scale</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">set_edisp_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Enable/Disable the energy dispersion correction for a</span>
<span class="sd">        source.&quot;&quot;&quot;</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">set_edisp_flag</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_energy_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logemin</span><span class="p">,</span> <span class="n">logemax</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the energy range of the analysis.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        logemin: float</span>
<span class="sd">           Lower end of energy range in log10(E/MeV).</span>

<span class="sd">        logemax : float</span>
<span class="sd">           Upper end of energy range in log10(E/MeV).</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">logemin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logemin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">logemax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logemax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">imin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">val_to_edge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">,</span> <span class="n">logemin</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">imax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">val_to_edge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">,</span> <span class="n">logemax</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">imin</span> <span class="o">-</span> <span class="n">imax</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">imin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">imax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">klims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">klims</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">imin</span> <span class="o">!=</span> <span class="n">klims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">imax</span> <span class="o">!=</span> <span class="n">klims</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">selectEbounds</span><span class="p">(</span><span class="n">imin</span><span class="p">,</span> <span class="n">imax</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">[</span><span class="n">imin</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">[</span><span class="n">imax</span><span class="p">]])</span>

    <span class="k">def</span> <span class="nf">counts_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return 3-D counts map for this component as a Map object.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        map : `~fermipy.skymap.MapBase`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">,</span> <span class="n">gtutils</span><span class="o">.</span><span class="n">SummedLikelihood</span><span class="p">):</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">countsMap</span><span class="p">()</span>
                <span class="n">p_method</span> <span class="o">=</span> <span class="n">cmap</span><span class="o">.</span><span class="n">projection</span><span class="p">()</span><span class="o">.</span><span class="n">method</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">countsMap</span><span class="p">()</span>
                <span class="n">p_method</span> <span class="o">=</span> <span class="n">cmap</span><span class="o">.</span><span class="n">projection</span><span class="p">()</span><span class="o">.</span><span class="n">method</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">p_method</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">p_method</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># WCS</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">cmap</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enumbins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npix</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">WcsNDMap</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="p">),</span> <span class="n">z</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">p_method</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># HPX</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">cmap</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enumbins</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">npix</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">HpxNDMap</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="p">),</span> <span class="n">z</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Did not recognize CountsMap type </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">p_method</span><span class="p">,</span>
                              <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">weight_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return 3-D weights map for this component as a Map object.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        map : `~fermipy.skymap.MapBase`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># EAC we need the try blocks b/c older versions of the ST don&#39;t have some of these functions</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="p">,</span> <span class="n">gtutils</span><span class="o">.</span><span class="n">SummedLikelihood</span><span class="p">):</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">countsMap</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p_method</span> <span class="o">=</span> <span class="n">cmap</span><span class="o">.</span><span class="n">projection</span><span class="p">()</span><span class="o">.</span><span class="n">method</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">p_method</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">has_weights</span><span class="p">():</span>
                    <span class="n">wmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">weightMap</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wmap</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">wmap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">countsMap</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p_method</span> <span class="o">=</span> <span class="n">cmap</span><span class="o">.</span><span class="n">projection</span><span class="p">()</span><span class="o">.</span><span class="n">method</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">p_method</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">has_weights</span><span class="p">():</span>
                    <span class="n">wmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">weightMap</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wmap</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">wmap</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">p_method</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># WCS</span>
            <span class="k">if</span> <span class="n">wmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">enumbins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npix</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">wmap</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enumbins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npix</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">WcsNDMap</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_geom</span><span class="p">),</span> <span class="n">z</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">p_method</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># HPX</span>
            <span class="n">nhpix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">npix</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">enumbins</span><span class="p">,</span> <span class="n">nhpix</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">wmap</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enumbins</span><span class="p">,</span> <span class="n">nhpix</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HpxNDMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Did not recognize CountsMap type </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">p_method</span><span class="p">,</span>
                              <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">model_counts_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the model expectation map for a single source, a set</span>
<span class="sd">        of sources, or all sources in the ROI.  The map will be</span>
<span class="sd">        computed using the current model parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>

<span class="sd">           Parameter that defines the sources for which the model map</span>
<span class="sd">           will be calculated.  If name=None a model map will be</span>
<span class="sd">           generated for all sources in the model.  If name=&#39;diffuse&#39;</span>
<span class="sd">           a map for all diffuse sources will be generated.</span>

<span class="sd">        exclude : list</span>

<span class="sd">           Source name or list of source names that will be excluded</span>
<span class="sd">           from the model map.</span>

<span class="sd">        use_mask : bool</span>

<span class="sd">           Parameter that specifies in the model counts map should include</span>
<span class="sd">           mask pixels (i.e., ones whose weights are &lt;= 0)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        map : `~fermipy.skymap.Map`</span>

<span class="sd">           A map object containing the counts and WCS projection.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projtype</span> <span class="o">==</span> <span class="s2">&quot;WCS&quot;</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npix</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">enumbins</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">projtype</span> <span class="o">==</span> <span class="s2">&quot;HPX&quot;</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">npix</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">enumbins</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unknown projection type </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">projtype</span><span class="p">)</span>

        <span class="n">exclude</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">arg_to_list</span><span class="p">(</span><span class="n">exclude</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">arg_to_list</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="n">excluded_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">exclude</span><span class="p">):</span>
            <span class="n">srcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_sources_by_name</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">excluded_names</span> <span class="o">+=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">srcs</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="p">,</span> <span class="s1">&#39;loadSourceMaps&#39;</span><span class="p">):</span>
            <span class="c1"># Update fixed model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">buildFixedModelWts</span><span class="p">()</span>
            <span class="c1"># Populate source map hash</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">buildFixedModelWts</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exclude</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">loadSourceMaps</span><span class="p">()</span>

        <span class="n">src_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">):</span>
            <span class="n">src_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">sources</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;diffuse&#39;</span><span class="p">:</span>
            <span class="n">src_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">sources</span> <span class="k">if</span>
                         <span class="n">src</span><span class="o">.</span><span class="n">diffuse</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">srcs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
            <span class="n">src_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">srcs</span><span class="p">]</span>

        <span class="c1"># Remove sources in exclude list</span>
        <span class="n">src_names</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">src_names</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excluded_names</span><span class="p">]</span>

        <span class="c1"># EAC we need the try blocks b/c older versions of the ST don&#39;t have some of these functions</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">src_names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">sources</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">computeModelMap</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">use_mask</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">NotImplementedError</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">computeModelMap</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="p">,</span> <span class="s1">&#39;setSourceMapImage&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">src_names</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">sourceMap</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">updateModelMap</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">use_mask</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">NotImplementedError</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">updateModelMap</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="p">,</span> <span class="s1">&#39;has_weights&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">computeModelMap</span><span class="p">(</span><span class="n">src_names</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">use_mask</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">computeModelMap</span><span class="p">(</span><span class="n">src_names</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">vsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">src_names</span><span class="p">:</span>
                    <span class="n">vtmp</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="p">,</span> <span class="s1">&#39;has_weights&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">computeModelMap</span><span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">vtmp</span><span class="p">,</span> <span class="n">use_mask</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">computeModelMap</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">vtmp</span><span class="p">)</span>
                    <span class="n">vsum</span> <span class="o">+=</span> <span class="n">vtmp</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">pyLike</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">vsum</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projtype</span> <span class="o">==</span> <span class="s2">&quot;WCS&quot;</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enumbins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npix</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">WcsNDMap</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_geom</span><span class="p">),</span> <span class="n">z</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">projtype</span> <span class="o">==</span> <span class="s2">&quot;HPX&quot;</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enumbins</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_geom</span><span class="o">.</span><span class="n">npix</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">HpxNDMap</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_geom</span><span class="p">),</span> <span class="n">z</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Did not recognize projection type </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">projtype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">model_counts_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">logemin</span><span class="p">,</span> <span class="n">logemax</span><span class="p">,</span> <span class="n">weighted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the model counts spectrum of a source.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">           Source name.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># EAC, we need this b/c older version of the ST don&#39;t have the right signature</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">modelCountsSpectrum</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">weighted</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">NotImplementedError</span><span class="p">):</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">modelCountsSpectrum</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
        <span class="n">imin</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">val_to_edge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">,</span> <span class="n">logemin</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">imax</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">val_to_edge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_energies</span><span class="p">,</span> <span class="n">logemax</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">imax</span> <span class="o">&lt;=</span> <span class="n">imin</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid energy range.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cs</span><span class="p">[</span><span class="n">imin</span><span class="p">:</span><span class="n">imax</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run pre-processing step for this component.  This will</span>
<span class="sd">        generate all of the auxiliary files needed to instantiate a</span>
<span class="sd">        likelihood object.  By default this function will skip any</span>
<span class="sd">        steps for which the output file already exists.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        overwrite : bool</span>

<span class="sd">            Run all pre-processing steps even if the output file of</span>
<span class="sd">            that step is present in the working directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">loglevel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;loglevel&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglevel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;Running setup for component </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">use_external_srcmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;use_external_srcmap&#39;</span><span class="p">]</span>

        <span class="c1"># Run data selection</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_external_srcmap</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_select_data</span><span class="p">(</span><span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Create LT Cube</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ext_ltcube</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;Using external LT cube.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_ltcube</span><span class="p">(</span><span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Loading LT Cube </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ltcube&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ltc</span> <span class="o">=</span> <span class="n">LTCube</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ltcube&#39;</span><span class="p">])</span>

        <span class="c1"># Extract tmin, tmax from LT cube</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ltc</span><span class="o">.</span><span class="n">tstart</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ltc</span><span class="o">.</span><span class="n">tstop</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Creating PSF model&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_psf</span> <span class="o">=</span> <span class="n">irfs</span><span class="o">.</span><span class="n">PSFModel</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">skydir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ltc</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;irfs&#39;</span><span class="p">],</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;evtype&#39;</span><span class="p">],</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">)</span>

        <span class="c1"># Bin data and create exposure cube</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_external_srcmap</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bin_data</span><span class="p">(</span><span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_expcube</span><span class="p">(</span><span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># This is needed in case the exposure map is in HEALPix</span>
        <span class="n">hpxhduname</span> <span class="o">=</span> <span class="s2">&quot;HPXEXPOSURES&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bexp</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;bexpmap&#39;</span><span class="p">],</span> <span class="n">hdu</span><span class="o">=</span><span class="n">hpxhduname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bexp</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;bexpmap&#39;</span><span class="p">])</span>

        <span class="c1"># Write ROI XML</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">write_xml</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmdl&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">])</span>

        <span class="c1"># Create source maps file</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_external_srcmap</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_srcmaps</span><span class="p">(</span><span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;cacheft1&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ft1&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Deleting FT1 file.&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ft1&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;Finished setup for component </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_select_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">loglevel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;loglevel&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglevel</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ft1&#39;</span><span class="p">])</span> <span class="ow">and</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ccube&#39;</span><span class="p">])</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="n">overwrite</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;Skipping data selection.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Run gtselect and gtmktime</span>
        <span class="n">kw_gtselect</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_files</span><span class="p">[</span><span class="s1">&#39;evfile&#39;</span><span class="p">],</span>
                           <span class="n">outfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ft1&#39;</span><span class="p">],</span>
                           <span class="n">ra</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">skydir</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                           <span class="n">dec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">skydir</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                           <span class="n">rad</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">],</span>
                           <span class="n">convtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;convtype&#39;</span><span class="p">],</span>
                           <span class="n">phasemin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;phasemin&#39;</span><span class="p">],</span>
                           <span class="n">phasemax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;phasemax&#39;</span><span class="p">],</span>
                           <span class="n">evtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;evtype&#39;</span><span class="p">],</span>
                           <span class="n">evclass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;evclass&#39;</span><span class="p">],</span>
                           <span class="n">tmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;tmin&#39;</span><span class="p">],</span>
                           <span class="n">tmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;tmax&#39;</span><span class="p">],</span>
                           <span class="n">emin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;emin&#39;</span><span class="p">],</span>
                           <span class="n">emax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;emax&#39;</span><span class="p">],</span>
                           <span class="n">zmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;zmax&#39;</span><span class="p">],</span>
                           <span class="n">chatter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;logging&#39;</span><span class="p">][</span><span class="s1">&#39;chatter&#39;</span><span class="p">])</span>

        <span class="n">kw_gtmktime</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">evfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ft1&#39;</span><span class="p">],</span>
                           <span class="n">outfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ft1_filtered&#39;</span><span class="p">],</span>
                           <span class="n">scfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_files</span><span class="p">[</span><span class="s1">&#39;scfile&#39;</span><span class="p">],</span>
                           <span class="n">roicut</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;roicut&#39;</span><span class="p">],</span>
                           <span class="nb">filter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;filter&#39;</span><span class="p">])</span>

        <span class="n">run_gtapp</span><span class="p">(</span><span class="s1">&#39;gtselect&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">kw_gtselect</span><span class="p">,</span>
                  <span class="n">loglevel</span><span class="o">=</span><span class="n">loglevel</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;roicut&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span> <span class="ow">or</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">run_gtapp</span><span class="p">(</span><span class="s1">&#39;gtmktime&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">kw_gtmktime</span><span class="p">,</span>
                      <span class="n">loglevel</span><span class="o">=</span><span class="n">loglevel</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mv </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ft1_filtered&#39;</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ft1&#39;</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">_bin_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">loglevel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;loglevel&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglevel</span><span class="p">)</span>

        <span class="c1"># Run gtbin</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projtype</span> <span class="o">==</span> <span class="s2">&quot;WCS&quot;</span><span class="p">:</span>
            <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;ccube&#39;</span><span class="p">,</span>
                      <span class="n">nxpix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">npix</span><span class="p">,</span> <span class="n">nypix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">npix</span><span class="p">,</span>
                      <span class="n">binsz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;binsz&#39;</span><span class="p">],</span>
                      <span class="n">evfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ft1&#39;</span><span class="p">],</span>
                      <span class="n">outfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ccube&#39;</span><span class="p">],</span>
                      <span class="n">scfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_files</span><span class="p">[</span><span class="s1">&#39;scfile&#39;</span><span class="p">],</span>
                      <span class="n">xref</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_xref</span><span class="p">,</span>
                      <span class="n">yref</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_yref</span><span class="p">,</span>
                      <span class="n">axisrot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">proj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;proj&#39;</span><span class="p">],</span>
                      <span class="n">ebinalg</span><span class="o">=</span><span class="s1">&#39;LOG&#39;</span><span class="p">,</span>
                      <span class="n">emin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;emin&#39;</span><span class="p">],</span>
                      <span class="n">emax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;emax&#39;</span><span class="p">],</span>
                      <span class="n">enumbins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_enumbins</span><span class="p">,</span>
                      <span class="n">coordsys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;coordsys&#39;</span><span class="p">],</span>
                      <span class="n">chatter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;logging&#39;</span><span class="p">][</span><span class="s1">&#39;chatter&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">projtype</span> <span class="o">==</span> <span class="s2">&quot;HPX&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;roiwidth&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;roiwidth&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">180.</span><span class="p">:</span>
                <span class="n">hpx_region</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hpx_region</span> <span class="o">=</span> <span class="s2">&quot;DISK(</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_xref</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yref</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;roiwidth&#39;</span><span class="p">])</span>
            <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;healpix&#39;</span><span class="p">,</span>
                      <span class="n">evfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ft1&#39;</span><span class="p">],</span>
                      <span class="n">outfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ccube&#39;</span><span class="p">],</span>
                      <span class="n">scfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_files</span><span class="p">[</span><span class="s1">&#39;scfile&#39;</span><span class="p">],</span>
                      <span class="n">xref</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_xref</span><span class="p">,</span>
                      <span class="n">yref</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_yref</span><span class="p">,</span>
                      <span class="n">proj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;proj&#39;</span><span class="p">],</span>
                      <span class="n">hpx_ordering_scheme</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span>
                          <span class="s1">&#39;hpx_ordering_scheme&#39;</span><span class="p">],</span>
                      <span class="n">hpx_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;hpx_order&#39;</span><span class="p">],</span>
                      <span class="n">hpx_ebin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;hpx_ebin&#39;</span><span class="p">],</span>
                      <span class="n">hpx_region</span><span class="o">=</span><span class="n">hpx_region</span><span class="p">,</span>
                      <span class="n">ebinalg</span><span class="o">=</span><span class="s1">&#39;LOG&#39;</span><span class="p">,</span>
                      <span class="n">emin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;emin&#39;</span><span class="p">],</span>
                      <span class="n">emax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;emax&#39;</span><span class="p">],</span>
                      <span class="n">enumbins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_enumbins</span><span class="p">,</span>
                      <span class="n">coordsys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;coordsys&#39;</span><span class="p">],</span>
                      <span class="n">chatter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;logging&#39;</span><span class="p">][</span><span class="s1">&#39;chatter&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Unknown projection type, </span><span class="si">%s</span><span class="s1">. Choices are WCS or HPX&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">projtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ccube&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="n">run_gtapp</span><span class="p">(</span><span class="s1">&#39;gtbin&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">loglevel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Skipping gtbin.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_ltcube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">loglevel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;loglevel&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglevel</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ltcube&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;Skipping LT Cube.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Run gtltcube</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">evfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ft1&#39;</span><span class="p">],</span>
                  <span class="n">scfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_files</span><span class="p">[</span><span class="s1">&#39;scfile&#39;</span><span class="p">],</span>
                  <span class="n">outfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ltcube&#39;</span><span class="p">],</span>
                  <span class="n">binsz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ltcube&#39;</span><span class="p">][</span><span class="s1">&#39;binsz&#39;</span><span class="p">],</span>
                  <span class="n">dcostheta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ltcube&#39;</span><span class="p">][</span><span class="s1">&#39;dcostheta&#39;</span><span class="p">],</span>
                  <span class="n">phibins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ltcube&#39;</span><span class="p">][</span><span class="s1">&#39;phibins&#39;</span><span class="p">],</span>
                  <span class="n">zmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;zmax&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ltcube&#39;</span><span class="p">][</span><span class="s1">&#39;use_local_ltcube&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating local LT cube.&#39;</span><span class="p">)</span>
            <span class="n">colnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;START&#39;</span><span class="p">,</span> <span class="s1">&#39;STOP&#39;</span><span class="p">,</span> <span class="s1">&#39;LIVETIME&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;RA_SCZ&#39;</span><span class="p">,</span> <span class="s1">&#39;DEC_SCZ&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;RA_ZENITH&#39;</span><span class="p">,</span> <span class="s1">&#39;DEC_ZENITH&#39;</span><span class="p">]</span>
            <span class="n">tab_sc</span> <span class="o">=</span> <span class="n">create_sc_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_files</span><span class="p">[</span><span class="s1">&#39;scfile&#39;</span><span class="p">],</span>
                                     <span class="n">colnames</span><span class="o">=</span><span class="n">colnames</span><span class="p">)</span>
            <span class="n">tab_gti</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ft1&#39;</span><span class="p">],</span> <span class="s1">&#39;GTI&#39;</span><span class="p">)</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">10.0</span>
            <span class="n">ltc_new</span> <span class="o">=</span> <span class="n">LTCube</span><span class="o">.</span><span class="n">create_from_gti</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">skydir</span><span class="p">,</span> <span class="n">tab_sc</span><span class="p">,</span> <span class="n">tab_gti</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;zmax&#39;</span><span class="p">],</span>
                                             <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">)</span>
            <span class="n">ltc_new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ltcube&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">run_gtapp</span><span class="p">(</span><span class="s1">&#39;gtltcube&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">loglevel</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_expcube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">loglevel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;loglevel&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglevel</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;bexpmap&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;Skipping gtexpcube.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;irfs&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CALDB&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projtype</span> <span class="o">==</span> <span class="s2">&quot;HPX&quot;</span><span class="p">:</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ccube&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>

        <span class="c1"># Run gtexpcube2</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ltcube&#39;</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                  <span class="n">ebinalg</span><span class="o">=</span><span class="s1">&#39;LOG&#39;</span><span class="p">,</span>
                  <span class="n">emin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;emin&#39;</span><span class="p">],</span>
                  <span class="n">emax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;emax&#39;</span><span class="p">],</span>
                  <span class="n">enumbins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_enumbins</span><span class="p">,</span>
                  <span class="n">outfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;bexpmap&#39;</span><span class="p">],</span> <span class="n">proj</span><span class="o">=</span><span class="s1">&#39;CAR&#39;</span><span class="p">,</span>
                  <span class="n">nxpix</span><span class="o">=</span><span class="mi">360</span><span class="p">,</span> <span class="n">nypix</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span> <span class="n">binsz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                  <span class="n">xref</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">yref</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                  <span class="n">evtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;evtype&#39;</span><span class="p">],</span>
                  <span class="n">irfs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;irfs&#39;</span><span class="p">],</span>
                  <span class="n">coordsys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;coordsys&#39;</span><span class="p">],</span>
                  <span class="n">chatter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;logging&#39;</span><span class="p">][</span><span class="s1">&#39;chatter&#39;</span><span class="p">])</span>

        <span class="n">set_edisp_kwargs</span><span class="p">(</span><span class="s1">&#39;gtexpcube2&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>
        
        <span class="n">run_gtapp</span><span class="p">(</span><span class="s1">&#39;gtexpcube2&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">loglevel</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projtype</span> <span class="o">==</span> <span class="s2">&quot;WCS&quot;</span><span class="p">:</span>
            <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ltcube&#39;</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                      <span class="n">ebinalg</span><span class="o">=</span><span class="s1">&#39;LOG&#39;</span><span class="p">,</span>
                      <span class="n">emin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;emin&#39;</span><span class="p">],</span>
                      <span class="n">emax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;emax&#39;</span><span class="p">],</span>
                      <span class="n">enumbins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_enumbins</span><span class="p">,</span>
                      <span class="n">outfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;bexpmap_roi&#39;</span><span class="p">],</span> <span class="n">proj</span><span class="o">=</span><span class="s1">&#39;CAR&#39;</span><span class="p">,</span>
                      <span class="n">nxpix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">npix</span><span class="p">,</span> <span class="n">nypix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">npix</span><span class="p">,</span>
                      <span class="n">binsz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;binsz&#39;</span><span class="p">],</span>
                      <span class="n">xref</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_xref</span><span class="p">,</span> <span class="n">yref</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_yref</span><span class="p">,</span>
                      <span class="n">evtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;evtype&#39;</span><span class="p">],</span>
                      <span class="n">irfs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;irfs&#39;</span><span class="p">],</span>
                      <span class="n">coordsys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;coordsys&#39;</span><span class="p">],</span>
                      <span class="n">chatter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;logging&#39;</span><span class="p">][</span><span class="s1">&#39;chatter&#39;</span><span class="p">])</span>

            <span class="n">run_gtapp</span><span class="p">(</span><span class="s1">&#39;gtexpcube2&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">loglevel</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">projtype</span> <span class="o">==</span> <span class="s2">&quot;HPX&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Skipping local gtexpcube for HEALPix&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Did not recognize projection type </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">projtype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_srcmaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">loglevel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;loglevel&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglevel</span><span class="p">)</span>
        <span class="n">use_scaled_srcmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;use_scaled_srcmap&#39;</span><span class="p">]</span>

        <span class="c1"># Run gtsrcmaps</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">scfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_files</span><span class="p">[</span><span class="s1">&#39;scfile&#39;</span><span class="p">],</span>
                  <span class="n">expcube</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ltcube&#39;</span><span class="p">],</span>
                  <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ccube&#39;</span><span class="p">],</span>
                  <span class="n">srcmdl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmdl&#39;</span><span class="p">],</span>
                  <span class="n">bexpmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;bexpmap&#39;</span><span class="p">],</span>
                  <span class="n">outfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmap&#39;</span><span class="p">],</span>
                  <span class="n">irfs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;irfs&#39;</span><span class="p">],</span>
                  <span class="n">wmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;wmap&#39;</span><span class="p">],</span>
                  <span class="n">evtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;evtype&#39;</span><span class="p">],</span>
                  <span class="n">rfactor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;rfactor&#39;</span><span class="p">],</span>
                  <span class="c1">#                   resample=self.config[&#39;resample&#39;],</span>
                  <span class="n">minbinsz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;minbinsz&#39;</span><span class="p">],</span>
                  <span class="n">chatter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;logging&#39;</span><span class="p">][</span><span class="s1">&#39;chatter&#39;</span><span class="p">],</span>
                  <span class="n">emapbnds</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span>

        <span class="n">set_edisp_kwargs</span><span class="p">(</span><span class="s1">&#39;gtsrcmaps&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmap&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;Skipping gtsrcmaps.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">use_scaled_srcmap</span><span class="p">:</span>
            <span class="n">make_scaled_srcmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;srcmap_base&#39;</span><span class="p">],</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;bexpmap_base&#39;</span><span class="p">],</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;bexpmap_roi_base&#39;</span><span class="p">],</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;bexpmap&#39;</span><span class="p">],</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;bexpmap_roi&#39;</span><span class="p">],</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ccube&#39;</span><span class="p">],</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmap&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">run_gtapp</span><span class="p">(</span><span class="s1">&#39;gtsrcmaps&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">loglevel</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_binned_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xmlfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">loglevel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;loglevel&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglevel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;Creating BinnedAnalysis for component </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">srcmdl_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmdl&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">xmlfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">srcmdl_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_path</span><span class="p">(</span><span class="n">xmlfile</span><span class="p">)</span>

        <span class="c1"># Create BinnedObs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Creating BinnedObs&#39;</span><span class="p">)</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">srcMaps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmap&#39;</span><span class="p">],</span> <span class="n">expCube</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ltcube&#39;</span><span class="p">],</span>
                  <span class="n">binnedExpMap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;bexpmap&#39;</span><span class="p">],</span>
                  <span class="n">irfs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;irfs&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_obs</span> <span class="o">=</span> <span class="n">ba</span><span class="o">.</span><span class="n">BinnedObs</span><span class="p">(</span><span class="o">**</span><span class="n">utils</span><span class="o">.</span><span class="n">unicode_to_str</span><span class="p">(</span><span class="n">kw</span><span class="p">))</span>


        <span class="c1"># Create BinnedAnalysis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Creating BinnedAnalysis&#39;</span><span class="p">)</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">srcModel</span><span class="o">=</span><span class="n">srcmdl_file</span><span class="p">,</span>
                  <span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;MINUIT&#39;</span><span class="p">,</span>
                  <span class="n">wmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="s1">&#39;wmap&#39;</span><span class="p">],</span>
                  <span class="n">convolve</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;convolve&#39;</span><span class="p">],</span>
                  <span class="n">resample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;resample&#39;</span><span class="p">],</span>
                  <span class="n">minbinsz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;minbinsz&#39;</span><span class="p">],</span>
                  <span class="n">resamp_fact</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;rfactor&#39;</span><span class="p">])</span>

        <span class="n">set_edisp_kwargs</span><span class="p">(</span><span class="s1">&#39;gtlike&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_like</span> <span class="o">=</span> <span class="n">BinnedAnalysis</span><span class="p">(</span><span class="n">binnedData</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_obs</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">utils</span><span class="o">.</span><span class="n">unicode_to_str</span><span class="p">(</span><span class="n">kw</span><span class="p">))</span>

<span class="c1">#        print(self.like.logLike.use_single_fixed_map())</span>
<span class="c1">#        self.like.logLike.set_use_single_fixed_map(False)</span>
<span class="c1">#        print(self.like.logLike.use_single_fixed_map())</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;edisp_disable&#39;</span><span class="p">]:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">has_source</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Disabling energy dispersion for </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_edisp_flag</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_like</span><span class="o">.</span><span class="n">logLike</span><span class="p">,</span> <span class="s1">&#39;set_save_all_srcmaps&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">set_save_all_srcmaps</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Recompute fixed model weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Computing fixed weights&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">buildFixedModelWts</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Updating source maps&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;use_external_srcmap&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">saveSourceMaps</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmap&#39;</span><span class="p">]))</span>

        <span class="c1"># Apply exposure corrections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale_srcmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_expscale</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scale_srcmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale_map</span><span class="p">,</span> <span class="n">check_header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply exposure corrections to the source map file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scale_map : dict</span>
<span class="sd">            Dictionary of exposure corrections.</span>

<span class="sd">        check_header : bool</span>
<span class="sd">            Check EXPSCALE header keyword to see if an exposure</span>
<span class="sd">            correction has already been applied to this source.</span>

<span class="sd">        names : list, optional</span>
<span class="sd">            Names of sources to which the exposure correction will be</span>
<span class="sd">            applied.  If None then all sources will be corrected.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">srcmap</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmap&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="n">srcmap</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="n">hdu</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scale_map</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hdu</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">scale</span> <span class="o">=</span> <span class="n">scale_map</span><span class="p">[</span><span class="n">hdu</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">scale</span> <span class="o">&lt;</span> <span class="mf">1e-20</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;The expscale parameter was zero, setting it to 1e-8&quot;</span><span class="p">)</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="mf">1e-8</span>
            <span class="k">if</span> <span class="s1">&#39;EXPSCALE&#39;</span> <span class="ow">in</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span> <span class="ow">and</span> <span class="n">check_header</span><span class="p">:</span>
                <span class="n">old_scale</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXPSCALE&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">old_scale</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">scale</span> <span class="o">/</span> <span class="n">old_scale</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXPSCALE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">scale</span><span class="p">,</span>
                                      <span class="s1">&#39;Exposure correction applied to this map&#39;</span><span class="p">)</span>

        <span class="n">srcmap</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmap&#39;</span><span class="p">],</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">srcmap</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Force reloading the map from disk</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">scale_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">eraseSourceMap</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">buildFixedModelWts</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_make_scaled_srcmap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make an exposure cube with the same binning as the counts map.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing scaled source map.&#39;</span><span class="p">)</span>

        <span class="n">bexp0</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;bexpmap_roi&#39;</span><span class="p">])</span>
        <span class="n">bexp1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;bexpmap&#39;</span><span class="p">])</span>
        <span class="n">srcmap</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;srcmap&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">bexp0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">bexp1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Wrong shape for input exposure map file.&#39;</span><span class="p">)</span>

        <span class="n">bexp_ratio</span> <span class="o">=</span> <span class="n">bexp0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">/</span> <span class="n">bexp1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Min/Med/Max exposure correction: </span><span class="si">%f</span><span class="s1"> </span><span class="si">%f</span><span class="s1"> </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bexp_ratio</span><span class="p">),</span>
                                                           <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span>
                                                               <span class="n">bexp_ratio</span><span class="p">),</span>
                                                           <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bexp_ratio</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="n">srcmap</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>

            <span class="k">if</span> <span class="n">hdu</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;GTI&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">hdu</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;EBOUNDS&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">bexp_ratio</span>

        <span class="n">srcmap</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmap&#39;</span><span class="p">],</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">restore_counts_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">cmap</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ccube&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="p">,</span> <span class="s1">&#39;setCountsMap&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">setCountsMap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">cmap</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)))</span>

        <span class="n">srcmap_utils</span><span class="o">.</span><span class="n">update_source_maps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmap&#39;</span><span class="p">],</span>
                                        <span class="p">{</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">:</span> <span class="n">cmap</span><span class="o">.</span><span class="n">data</span><span class="p">},</span>
                                        <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">simulate_roi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">randomize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulate the whole ROI or inject a simulation of one or</span>
<span class="sd">        more model components into the data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">           Name of the model component to be simulated.  If None then</span>
<span class="sd">           the whole ROI will be simulated.</span>

<span class="sd">        clear : bool</span>
<span class="sd">           Zero the current counts map before injecting the simulation.</span>

<span class="sd">        randomize : bool</span>
<span class="sd">           Fill with each pixel with random values drawn from a</span>
<span class="sd">           poisson distribution.  If false then fill each pixel with</span>
<span class="sd">           the counts expectation value.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_map</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">data</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_counts_map</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> 

        <span class="k">if</span> <span class="n">clear</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">randomize</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">&lt;</span><span class="mf">0.</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;At least on negative value found in model map.&#39;</span>
                                    <span class="s1">&#39; Changing it/them to 0&#39;</span><span class="p">)</span>
                <span class="n">indexcond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">m</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span><span class="mf">0.</span> <span class="p">)</span>
                <span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">indexcond</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">indexcond</span><span class="p">]))</span>
                
            <span class="n">data</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">+=</span> <span class="n">m</span><span class="o">.</span><span class="n">data</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="p">,</span> <span class="s1">&#39;setCountsMap&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">setCountsMap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

        <span class="n">srcmap_utils</span><span class="o">.</span><span class="n">update_source_maps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmap&#39;</span><span class="p">],</span>
                                        <span class="p">{</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span>
                                        <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ccubemc&#39;</span><span class="p">],</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="s1">&#39;fgst-ccube&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_model_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save counts model map to a FITS file.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">model_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;file_suffix&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;_</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;file_suffix&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating model map for component </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;workdir&#39;</span><span class="p">],</span>
                               <span class="s1">&#39;mcube</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">suffix</span><span class="p">))</span>

        <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_counts_map</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">use_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">cmap</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="s1">&#39;fgst-ccube&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cmap</span>

    <span class="k">def</span> <span class="nf">write_weight_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save counts model map to a FITS file.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">model_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;file_suffix&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;_</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;file_suffix&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating model map for component </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;workdir&#39;</span><span class="p">],</span>
                               <span class="s1">&#39;wcube</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">suffix</span><span class="p">))</span>

        <span class="n">wmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_map</span><span class="p">()</span>
        <span class="n">wmap</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="s1">&#39;fgst-ccube&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wmap</span>

    <span class="k">def</span> <span class="nf">_update_srcmap_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check the contents of the source map file and generate</span>
<span class="sd">        source maps for any components that are not present.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmap&#39;</span><span class="p">]):</span>
            <span class="k">return</span>

        <span class="n">hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmap&#39;</span><span class="p">])</span>
        <span class="n">hdunames</span> <span class="o">=</span> <span class="p">[</span><span class="n">hdu</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="n">hdulist</span><span class="p">]</span>

        <span class="n">srcmaps</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">hdunames</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Creating source map for </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">srcmaps</span><span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_srcmap</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">srcmaps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;Updating source map file for component </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">srcmap_utils</span><span class="o">.</span><span class="n">update_source_maps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmap&#39;</span><span class="p">],</span> <span class="n">srcmaps</span><span class="p">,</span>
                                            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">hdulist</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_create_srcmap_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="kn">from</span> <span class="nn">fermipy.srcmap_utils</span> <span class="k">import</span> <span class="n">SourceMapCache</span>

        <span class="n">skydir</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">skydir</span>
        <span class="n">spatial_model</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpatialModel&#39;</span><span class="p">]</span>
        <span class="n">spatial_width</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpatialWidth&#39;</span><span class="p">]</span>
        <span class="n">xpix</span><span class="p">,</span> <span class="n">ypix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">to_image</span><span class="p">()</span><span class="o">.</span><span class="n">coord_to_pix</span><span class="p">(</span><span class="n">skydir</span><span class="p">)</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bexp</span><span class="o">.</span><span class="n">interp_by_coord</span><span class="p">(</span>
            <span class="p">(</span><span class="n">skydir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bexp</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">center</span><span class="p">))</span>
        <span class="n">rebin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binsz</span> <span class="o">/</span> <span class="mf">0.01</span><span class="p">)),</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">shape_out</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enumbins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npix</span><span class="p">)</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">SourceMapCache</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_psf</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">spatial_model</span><span class="p">,</span>
                                      <span class="n">spatial_width</span><span class="p">,</span> <span class="n">shape_out</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;binsz&#39;</span><span class="p">],</span>
                                      <span class="n">rebin</span><span class="o">=</span><span class="n">rebin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srcmap_cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cache</span>

    <span class="k">def</span> <span class="nf">_create_srcmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate the source map for a source.&quot;&quot;&quot;</span>

        <span class="n">psf_scale_fn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;psf_scale_fn&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">skydir</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">skydir</span>
        <span class="n">spatial_model</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpatialModel&#39;</span><span class="p">]</span>
        <span class="n">spatial_width</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;SpatialWidth&#39;</span><span class="p">]</span>
        <span class="n">xpix</span><span class="p">,</span> <span class="n">ypix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">to_image</span><span class="p">()</span><span class="o">.</span><span class="n">coord_to_pix</span><span class="p">(</span><span class="n">skydir</span><span class="p">)</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bexp</span><span class="o">.</span><span class="n">interp_by_coord</span><span class="p">(</span>
            <span class="p">(</span><span class="n">skydir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bexp</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">center</span><span class="p">))</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_srcmap_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">create_map</span><span class="p">([</span><span class="n">ypix</span><span class="p">,</span> <span class="n">xpix</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">srcmap_utils</span><span class="o">.</span><span class="n">make_srcmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_psf</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">spatial_model</span><span class="p">,</span>
                                         <span class="n">spatial_width</span><span class="p">,</span>
                                         <span class="n">npix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">npix</span><span class="p">,</span> <span class="n">xpix</span><span class="o">=</span><span class="n">xpix</span><span class="p">,</span> <span class="n">ypix</span><span class="o">=</span><span class="n">ypix</span><span class="p">,</span>
                                         <span class="n">cdelt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;binsz&#39;</span><span class="p">],</span>
                                         <span class="n">psf_scale_fn</span><span class="o">=</span><span class="n">psf_scale_fn</span><span class="p">,</span>
                                         <span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">k</span>

    <span class="k">def</span> <span class="nf">_update_srcmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the source map for an existing source in memory.&quot;&quot;&quot;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_srcmap</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_expscale</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">*=</span> <span class="n">scale</span>

        <span class="c1"># Force the source map to be cached</span>
        <span class="c1"># FIXME: No longer necessary to force cacheing in ST after 11-05-02</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">sourceMap</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">setSourceMapImage</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">sourceMap</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>

        <span class="n">normPar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">normPar</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">normPar</span><span class="o">.</span><span class="n">isFree</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">buildFixedModelWts</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">generate_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a counts model map from an XML model file using</span>
<span class="sd">        gtmodel.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_name : str</span>
<span class="sd">            Name of the model.  If no name is given it will use the</span>
<span class="sd">            baseline model.</span>

<span class="sd">        outfile : str</span>
<span class="sd">            Override the name of the output model file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">model_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">model_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">model_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">srcmdl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmdl&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">srcmdl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_path</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">srcmdl</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Model file does not exist: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">srcmdl</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;file_suffix&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;_</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;file_suffix&#39;</span><span class="p">])</span>

        <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;workdir&#39;</span><span class="p">],</span>
                               <span class="s1">&#39;mcube</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">suffix</span><span class="p">))</span>

        <span class="c1"># May consider generating a custom source model file</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">outfile</span><span class="p">):</span>

            <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">srcmaps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmap&#39;</span><span class="p">],</span>
                      <span class="n">srcmdl</span><span class="o">=</span><span class="n">srcmdl</span><span class="p">,</span>
                      <span class="n">bexpmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;bexpmap&#39;</span><span class="p">],</span>
                      <span class="n">outfile</span><span class="o">=</span><span class="n">outfile</span><span class="p">,</span>
                      <span class="n">expcube</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ltcube&#39;</span><span class="p">],</span>
                      <span class="n">irfs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;irfs&#39;</span><span class="p">],</span>
                      <span class="n">evtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;evtype&#39;</span><span class="p">],</span>
                      <span class="n">outtype</span><span class="o">=</span><span class="s1">&#39;ccube&#39;</span><span class="p">,</span>

                      <span class="n">chatter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;logging&#39;</span><span class="p">][</span><span class="s1">&#39;chatter&#39;</span><span class="p">])</span>

            <span class="n">set_edisp_kwargs</span><span class="p">(</span><span class="s1">&#39;gtmodel&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>
            <span class="n">run_gtapp</span><span class="p">(</span><span class="s1">&#39;gtmodel&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping gtmodel&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xmlfile</span><span class="p">):</span>

        <span class="n">xmlfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_path</span><span class="p">(</span><span class="n">xmlfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">xmlfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">reReadXml</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">xmlfile</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">fixedModelUpdated</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">logLike</span><span class="o">.</span><span class="n">buildFixedModelWts</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">write_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xmlfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the XML model for this analysis component.&quot;&quot;&quot;</span>

        <span class="n">xmlfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_path</span><span class="p">(</span><span class="n">xmlfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writing </span><span class="si">%s</span><span class="s1">...&#39;</span><span class="p">,</span> <span class="n">xmlfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">like</span><span class="o">.</span><span class="n">writeXml</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">xmlfile</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_model_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Infer the path to the XML model name.&quot;&quot;&quot;</span>

        <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;.xml&#39;</span>
        <span class="n">xmlfile</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;file_suffix&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ext</span>
        <span class="n">xmlfile</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">resolve_path</span><span class="p">(</span><span class="n">xmlfile</span><span class="p">,</span>
                                     <span class="n">workdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;workdir&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">xmlfile</span>

    <span class="k">def</span> <span class="nf">_tscube_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xmlfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run gttscube as an application.&quot;&quot;&quot;</span>

        <span class="n">xmlfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_path</span><span class="p">(</span><span class="n">xmlfile</span><span class="p">)</span>

        <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fileio&#39;</span><span class="p">][</span><span class="s1">&#39;workdir&#39;</span><span class="p">],</span>
                               <span class="s1">&#39;tscube</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;file_suffix&#39;</span><span class="p">]))</span>

        <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ccube&#39;</span><span class="p">],</span>
                  <span class="n">expcube</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ltcube&#39;</span><span class="p">],</span>
                  <span class="n">bexpmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;bexpmap&#39;</span><span class="p">],</span>
                  <span class="n">irfs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;irfs&#39;</span><span class="p">],</span>
                  <span class="n">evtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;evtype&#39;</span><span class="p">],</span>
                  <span class="n">srcmdl</span><span class="o">=</span><span class="n">xmlfile</span><span class="p">,</span>
                  <span class="n">nxpix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">npix</span><span class="p">,</span> <span class="n">nypix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">npix</span><span class="p">,</span>
                  <span class="n">binsz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;binsz&#39;</span><span class="p">],</span>
                  <span class="n">xref</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">skydir</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span>
                  <span class="n">yref</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">skydir</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span>
                  <span class="n">proj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;proj&#39;</span><span class="p">],</span>
                  <span class="n">stlevel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                  <span class="n">coordsys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">][</span><span class="s1">&#39;coordsys&#39;</span><span class="p">],</span>
                  <span class="n">outfile</span><span class="o">=</span><span class="n">outfile</span><span class="p">)</span>

        <span class="n">run_gtapp</span><span class="p">(</span><span class="s1">&#39;gttscube&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_diffrsp_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">xmlfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the diffuse response </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">loglevel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;loglevel&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglevel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;Computing diffuse repsonce for component </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># set the srcmdl</span>
        <span class="n">srcmdl_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmdl&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">xmlfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">srcmdl_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_path</span><span class="p">(</span><span class="n">xmlfile</span><span class="p">)</span>

        <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">evfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ft1&#39;</span><span class="p">],</span>
            <span class="n">scfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_files</span><span class="p">[</span><span class="s1">&#39;scfile&#39;</span><span class="p">],</span>
            <span class="n">irfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;irfs&#39;</span><span class="p">],</span>
            <span class="n">evtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;evtype&#39;</span><span class="p">],</span>
            <span class="n">srcmdl</span> <span class="o">=</span> <span class="n">srcmdl_file</span><span class="p">)</span>

        <span class="n">run_gtapp</span><span class="p">(</span><span class="s1">&#39;gtdiffrsp&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">loglevel</span><span class="p">)</span>
        <span class="k">return</span> 

    <span class="k">def</span> <span class="nf">_srcprob_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">xmlfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run srcprob for an analysis component as an application</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">loglevel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;loglevel&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglevel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s1">&#39;Computing src probability for component </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># set the srcmdl</span>
        <span class="n">srcmdl_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;srcmdl&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">xmlfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">srcmdl_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_path</span><span class="p">(</span><span class="n">xmlfile</span><span class="p">)</span>

        <span class="c1"># set the outfile</span>
        <span class="c1"># it&#39;s defined here and not in self.files dict</span>
        <span class="c1"># so that it is copied with the stage_output module</span>
        <span class="c1"># even if savefits is False</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> 
                    <span class="s1">&#39;ft1_srcprob</span><span class="si">{0[file_suffix]:s}</span><span class="s1">.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">))</span>

        <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">evfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ft1&#39;</span><span class="p">],</span>
            <span class="n">scfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_files</span><span class="p">[</span><span class="s1">&#39;scfile&#39;</span><span class="p">],</span>
            <span class="n">outfile</span><span class="o">=</span> <span class="n">outfile</span><span class="p">,</span>
            <span class="n">irfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gtlike&#39;</span><span class="p">][</span><span class="s1">&#39;irfs&#39;</span><span class="p">],</span>
            <span class="n">srcmdl</span> <span class="o">=</span> <span class="n">srcmdl_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>

        <span class="c1"># run gtapp for the srcprob</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping gtsrcprob&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">run_gtapp</span><span class="p">(</span><span class="s1">&#39;gtsrcprob&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">loglevel</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Fermipy Developers

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>